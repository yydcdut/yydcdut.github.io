<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>ListView优化总结 | Android杂文 - yydcdut</title>
  <meta name="description" content="Android技术杂文,yydcdut" />
  <meta name="keywords" content="blog,博客,Android,开源,源码,Android源码,yydcdut" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternative" href="/atom.xml" title="Android杂文 - yydcdut" type="application/atom+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ListView 的优化总结，包括利用好 ConvertView、利用好 ViewType、Layout 层次结构、ViewHolder、使用自定义布局、保证 Adapter 的 hasStableIds() 返回 true、Item 不能太高、getView() 中要做尽量少的事情、ListView 中元素避免半透明、尽量开启硬件加速、 AnimationCache、 ScrollingCach">
<meta property="og:type" content="article">
<meta property="og:title" content="ListView优化总结">
<meta property="og:url" content="http://yydcdut.com/2016/02/28/listview-optimize/index.html">
<meta property="og:site_name" content="Android杂文 - yydcdut">
<meta property="og:description" content="ListView 的优化总结，包括利用好 ConvertView、利用好 ViewType、Layout 层次结构、ViewHolder、使用自定义布局、保证 Adapter 的 hasStableIds() 返回 true、Item 不能太高、getView() 中要做尽量少的事情、ListView 中元素避免半透明、尽量开启硬件加速、 AnimationCache、 ScrollingCach">
<meta property="og:updated_time" content="2016-02-28T12:38:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ListView优化总结">
<meta name="twitter:description" content="ListView 的优化总结，包括利用好 ConvertView、利用好 ViewType、Layout 层次结构、ViewHolder、使用自定义布局、保证 Adapter 的 hasStableIds() 返回 true、Item 不能太高、getView() 中要做尽量少的事情、ListView 中元素避免半透明、尽量开启硬件加速、 AnimationCache、 ScrollingCach">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css" type="text/css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Android杂文 - yydcdut
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/me'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/me" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-listview-optimize"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2016/02/28/listview-optimize/">
    	ListView优化总结
    </a>
  </h2>
	<time>
	  2月 28, 2016
	</time>
	
    
    <div class='cats'>
        <a href="/categories/Android/">Android</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#利用好-ConvertView"><span class="toc-number">1.</span> <span class="toc-text">利用好 ConvertView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用好-ViewType"><span class="toc-number">2.</span> <span class="toc-text">利用好 ViewType</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-View-的-Layout-层次结构简单"><span class="toc-number">3.</span> <span class="toc-text">Item View 的 Layout 层次结构简单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#减少View绘制时间"><span class="toc-number">4.</span> <span class="toc-text">减少View绘制时间</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原因"><span class="toc-number">4.1.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#减短时间"><span class="toc-number">4.2.</span> <span class="toc-text">减短时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#控件更新前先对比数据"><span class="toc-number">4.3.</span> <span class="toc-text">控件更新前先对比数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Instagram-预渲染文本"><span class="toc-number">4.4.</span> <span class="toc-text">Instagram 预渲染文本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ViewHolder"><span class="toc-number">5.</span> <span class="toc-text">ViewHolder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#尽量自定义布局"><span class="toc-number">6.</span> <span class="toc-text">尽量自定义布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#尽量能保证-Adapter-的-hasStableIds-返回-true"><span class="toc-number">7.</span> <span class="toc-text">尽量能保证 Adapter 的 hasStableIds() 返回 true</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#每个-Item-不能太高"><span class="toc-number">8.</span> <span class="toc-text">每个 Item 不能太高</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getView-中要做尽量少的事情"><span class="toc-number">9.</span> <span class="toc-text">getView() 中要做尽量少的事情</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#停下来再加载"><span class="toc-number">9.1.</span> <span class="toc-text">停下来再加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步加载"><span class="toc-number">9.2.</span> <span class="toc-text">异步加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#监听器设置一个就OK了"><span class="toc-number">10.</span> <span class="toc-text">监听器设置一个就OK了</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView-中元素避免半透明"><span class="toc-number">11.</span> <span class="toc-text">ListView 中元素避免半透明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#尽量开启硬件加速"><span class="toc-number">12.</span> <span class="toc-text">尽量开启硬件加速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AnimationCache"><span class="toc-number">13.</span> <span class="toc-text">AnimationCache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ScrollingCache"><span class="toc-number">14.</span> <span class="toc-text">ScrollingCache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SmoothScrollbar"><span class="toc-number">15.</span> <span class="toc-text">SmoothScrollbar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">16.</span> <span class="toc-text">参考</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<p>ListView 的优化总结，包括利用好 ConvertView、利用好 ViewType、Layout 层次结构、ViewHolder、使用自定义布局、保证 Adapter 的 hasStableIds() 返回 true、Item 不能太高、getView() 中要做尽量少的事情、ListView 中元素避免半透明、尽量开启硬件加速、 AnimationCache、 ScrollingCache 和 SmoothScrollbar。</p>
<a id="more"></a>
<h2 id="利用好-ConvertView"><a href="#利用好-ConvertView" class="headerlink" title="利用好 ConvertView"></a>利用好 ConvertView</h2><p>尽可能的少去执行 Layout 的 Inflate 。即使 Layout 文件已经被高效的解析程序转换为了二进制代码，Layout 的 Inflate 仍然是巨消耗资源的。Infalte 操作依旧需要彻底包含整个 XML 代码树，而且还要实例化相应的View。</p>
<p>在初始显示的时候，每次显示一个 item 都调用一次 <code>getview()</code> ，但是每次调用的时候 covertView 为 null ，当显示完了之后。如果屏幕移动了之后，并且导致有些 item 的 View 移到屏幕外面，此时如果还有新的 item 需要产生，则这些 item 显示时调用的 <code>getView()</code> 方法，此时 <code>getView()</code> 中的 convertview 参数就不是 null ，而是那些移出屏幕的 View ，我们所要做的就是将需要显示的 item 填充到这些回收的 View 中去，最后注意 convertview 为 null 的不仅仅是初始显示的那些 item ，还要可能跟 <code>ViewType</code> 有关。</p>
<h2 id="利用好-ViewType"><a href="#利用好-ViewType" class="headerlink" title="利用好 ViewType"></a>利用好 ViewType</h2><p>如果ListView中要显示多种布局文件（类似聊天界面那种），可以使用 <code>ViewType</code> 。其中涉及到两个方法，分别是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getItemViewType(position);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewTypeCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getViewTypeCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一个方法是告诉 ListView 当前 position 对应哪种 <code>ViewType</code> ，第二个方法是告诉 ListView 一共有多少中 <code>ViewType</code> 。</p>
<p>如果要实现聊天界面那种，这是一种可行方案，同样可行方案是使用同一个布局，但是在 getView() 中去判断是<code>发送消息类型</code>还是<code>接收消息类型</code>，然后去调用 <code>View.setVisibility(View.VISIBLE)</code> 或 <code>View.setVisibility(View.GONE)</code> ，<strong>但是这样的话会导致 Layout 的层次结构复杂</strong>。</p>
<p>同样，如果是使用 <code>ViewType</code> 的话，与上面那种相比可能会使 ListView 中的子 View 变多。</p>
<p>如果想动态向 ListView 中添加 HeaderView 或者 FooterView ，可以结合这两个方法。</p>
<h2 id="Item-View-的-Layout-层次结构简单"><a href="#Item-View-的-Layout-层次结构简单" class="headerlink" title="Item View 的 Layout 层次结构简单"></a>Item View 的 Layout 层次结构简单</h2><p>善用自定义 View，自定义 View 可以有效的减小 Layout 的层级。</p>
<h2 id="减少View绘制时间"><a href="#减少View绘制时间" class="headerlink" title="减少View绘制时间"></a>减少View绘制时间</h2><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>Android系统每隔16.7ms发出一个渲染信号，通知ui线程进行界面的渲染。当一个ListView被添加到布局时 <code>getView()</code> 方法将会被回调。在16.7毫秒时间单内，ListView 中 item 将调用 <code>getView()</code> 方法，并且需要显示多少个 item 就会调用多少次 <code>getView()</code> 方法。在大多数情况下，由于其他绘图行为的存在，例如 <code>measure</code> 和 <code>draw</code> ，<code>getView()</code> 实际分配到执行时间远低于16ms。一旦ListView包含复杂控件时，在16毫秒内不能完成渲染，用户只能看到上一帧的结果，这时就发生了掉帧。</p>
<h3 id="减短时间"><a href="#减短时间" class="headerlink" title="减短时间"></a>减短时间</h3><p>比如把 item 中控件高度尽量固定，比如固定值或者 <code>match_parent</code> 。慎用 <code>layout_weight</code> 类似属性，以便缩短 View 的 <code>measure</code> 时间。</p>
<h3 id="控件更新前先对比数据"><a href="#控件更新前先对比数据" class="headerlink" title="控件更新前先对比数据"></a>控件更新前先对比数据</h3><p>设置 View （如 TextView.setText() ）之前先对比数据是否有改变。一般来说，<code>比较两个数据的代价</code>远小于 <code>View 的重绘的代价</code>。</p>
<h3 id="Instagram-预渲染文本"><a href="#Instagram-预渲染文本" class="headerlink" title="Instagram 预渲染文本"></a>Instagram 预渲染文本</h3><p>ins 中一条消息也很长，而且起初 <code>measure</code> 和 <code>draw</code> 时间都超过了16ms。ins 使用了 <code>text.Layout</code> 并且缓存了 <code>text.Layout</code> 实例。同时自定义View实现自己去控制 <code>text.Layout</code> 的绘制，这样有很多好处，比如可以使用 <code>StaticLayout</code> 而不是 <code>DynamicLayout</code>、避免从 <code>SpannableStringBuilder</code> 转换 <code>String</code> 的过程（前提是看文字中是否有links）、避免 <code>TextView</code> 中不需要的逻辑。比如监控文本信息的改变等。</p>
<h2 id="ViewHolder"><a href="#ViewHolder" class="headerlink" title="ViewHolder"></a>ViewHolder</h2><p>使用 ViewHolder 的原因是 <code>findViewById()</code> 方法耗时较大，如果控件个数过多，会严重影响性能，而使用ViewHolder主要是为了可以省去这个时间。<strong>注意 viewHolder 里面 item 方法重绘：如 invalidate ， setVisibility ， requestLayout 后，会调用 adapter 的 getView() 方法。</strong></p>
<h2 id="尽量自定义布局"><a href="#尽量自定义布局" class="headerlink" title="尽量自定义布局"></a>尽量自定义布局</h2><p>自定义布局有个好处就是可以省略 <code>ViewHolder</code>。说出来可能你不会信， <code>ViewHolder</code> 首先会占用 <code>setTag()</code> ，其次每次取出后都需要转换一下类的类型。如果是自定义布局的话，<code>findViewById()</code> 这个过程可以在构造函数中进行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemView</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> TextView mTitleTextView;</span><br><span class="line">	<span class="keyword">private</span> TextView mDescriptionTextView;</span><br><span class="line">	<span class="keyword">private</span> ImageView mImageView;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ItemView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">        LayoutInflater.from(context).inflate(R.layout.item_view_children, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">        setupChildren();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ItemView <span class="title">inflate</span><span class="params">(ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        ItemView itemView = (ItemView)LayoutInflater.from(parent.getContext())</span><br><span class="line">                .inflate(R.layout.item_view, parent, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> itemView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChildren</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mTitleTextView = (TextView) findViewById(R.id.item_titleTextView);</span><br><span class="line">        mDescriptionTextView = (TextView) findViewById(R.id.item_descriptionTextView);</span><br><span class="line">        mImageView = (ImageView) findViewById(R.id.item_imageView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItem</span><span class="params">(Item item)</span> </span>&#123;</span><br><span class="line">        mTitleTextView.setText(item.getTitle());</span><br><span class="line">        mDescriptionTextView.setText(item.getDescription());</span><br><span class="line">        <span class="comment">// set up image URL blablabla...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样操作的话，在 Adapter 的 <code>getView()</code> 中的操作就少了 <code>ViewHolder</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemAdapter</span> <span class="keyword">extends</span> <span class="title">ArrayAdapter</span>&lt;<span class="title">Item</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ItemAdapter</span><span class="params">(Context c, List&lt;Item&gt; items)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(c, <span class="number">0</span>, items);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            ItemView itemView = (ItemView)convertView;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == itemView)</span><br><span class="line">                itemView = ItemView.inflate(parent);</span><br><span class="line">            itemView.setItem(getItem(position));</span><br><span class="line">            <span class="keyword">return</span> itemView;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="尽量能保证-Adapter-的-hasStableIds-返回-true"><a href="#尽量能保证-Adapter-的-hasStableIds-返回-true" class="headerlink" title="尽量能保证 Adapter 的 hasStableIds() 返回 true"></a>尽量能保证 Adapter 的 hasStableIds() 返回 true</h2><blockquote>
<p>Indicates whether the item ids are stable across changes to the underlying data.</p>
</blockquote>
<p>这样在 <code>notifyDataSetChanged()</code> 的时候，如果 id 不变，ListView 将不会重新绘制这个 View，达到优化的目的；</p>
<p>这个在 RecyclerView 的时候得到了改善，多出了 <code>notifyItemMoved()</code> 等方法。毕竟 <code>notifyDataSetChanged()</code> 太暴力了。</p>
<h2 id="每个-Item-不能太高"><a href="#每个-Item-不能太高" class="headerlink" title="每个 Item 不能太高"></a>每个 Item 不能太高</h2><p>特别是不要超过屏幕的高度，最好在3/4以下，以便View的回收。这部分可以查看 <code>facebook</code> 的做法。</p>
<h2 id="getView-中要做尽量少的事情"><a href="#getView-中要做尽量少的事情" class="headerlink" title="getView() 中要做尽量少的事情"></a>getView() 中要做尽量少的事情</h2><p>为了保证 ListView 滑动的流畅性，不要有耗时的操作。很多时候，Android 应用在 ListView 每行中显示一些多媒体内容，比如图片等。在 Adapter 中的 <code>getView()</code> 使用应用内置的图片资源还是不会出什么问题的，因为可以存储在 Android 的高速缓存中。但当想显示来自本地磁盘或网络的内容时，例如缩略图，简历图片等，在这种情况下，可能不希望直接在 Adapter 中的 <code>getView()</code> 加载它们，因为IO进程会阻塞UI线程。如果这样做的话， ListView 就看起来非常卡顿。</p>
<h3 id="停下来再加载"><a href="#停下来再加载" class="headerlink" title="停下来再加载"></a>停下来再加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">listView.setOnScrollListener(<span class="keyword">new</span> AbsListView.OnScrollListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrollStateChanged</span><span class="params">(AbsListView view, <span class="keyword">int</span> scrollState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (scrollState)&#123;</span><br><span class="line">            <span class="keyword">case</span> SCROLL_STATE_TOUCH_SCROLL:</span><br><span class="line">            <span class="keyword">case</span> SCROLL_STATE_FLING:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SCROLL_STATE_IDLE:</span><br><span class="line">                <span class="keyword">int</span> start = listView.getFirstVisiblePosition();</span><br><span class="line">                <span class="keyword">int</span> end = listView.getLastVisiblePosition();</span><br><span class="line">                <span class="keyword">if</span>(end &gt;= listView.getCount())&#123;</span><br><span class="line">                    end = listView.getCount() - <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//展示start－end之间的图片  blablabla......</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScroll</span><span class="params">(AbsListView view, <span class="keyword">int</span> firstVisibleItem, <span class="keyword">int</span> visibleItemCount, <span class="keyword">int</span> totalItemCount)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="异步加载"><a href="#异步加载" class="headerlink" title="异步加载"></a>异步加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView,</span><br><span class="line">        ViewGroup parent)</span> </span>&#123;</span><br><span class="line">    ViewHolder holder;</span><br><span class="line">    <span class="comment">///blablabla......</span></span><br><span class="line">    holder.position = position;</span><br><span class="line">    <span class="keyword">new</span> ThumbnailTask(position, holder)</span><br><span class="line">            .executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> convertView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThumbnailTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mPosition;</span><br><span class="line">    <span class="keyword">private</span> ViewHolder mHolder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThumbnailTask</span><span class="params">(<span class="keyword">int</span> position, ViewHolder holder)</span> </span>&#123;</span><br><span class="line">        mPosition = position;</span><br><span class="line">        mHolder = holder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Cursor <span class="title">doInBackground</span><span class="params">(Void... arg0)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Download bitmap here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mHolder.position == mPosition) &#123;</span><br><span class="line">            mHolder.thumbnail.setImageBitmap(bitmap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> ImageView thumbnail;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，<strong>在滑动屏幕时，如果你一味的在每一个 <code>getView()</code> 调用里面都去启动一个异步的操作，造成的结果就是你会浪费大量资源。因为行被频繁回收，造成大部分返回的结果会被丢弃</strong>。</p>
<h2 id="监听器设置一个就OK了"><a href="#监听器设置一个就OK了" class="headerlink" title="监听器设置一个就OK了"></a>监听器设置一个就OK了</h2><p>不要在 getView() 中不断的去设置监听器，因为 View 是复用的，<strong>当 convertView 不为 null 时是已经设置了监听器的</strong>。同时当 convertView 为 null 时也不要去 new 监听器，假设一个屏幕上有10个 item ，那么就要 new 出10个监听器来。最佳的做法是这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> View.OnClickListener mOnClickListener = <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">     <span class="annotation">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//blablabla......</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//blablabla......</span></span><br><span class="line">    <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="comment">//blablabla......</span></span><br><span class="line">        convertView.setOnClickListener(mOnClickListener);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  		<span class="comment">//blablabla......</span></span><br><span class="line">	&#125;</span><br><span class="line">  	<span class="comment">//blablabla......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样做就不需要 new 出那么多监听器来了。</p>
<p>有人问，如果这样写，所有 button 只能通过 id 区分逻辑，无法传入每个 item 的数据，我们可以将数据通过 View 的 tag 带进来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123; </span><br><span class="line">	<span class="comment">//blablabla......</span></span><br><span class="line">	convertView.setTag(key, getItem(position));      </span><br><span class="line">	<span class="comment">//blablabla......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>mOnClickListener</code> 中通过 <code>v.getTag(key)</code> 将数据取出。</p>
<h2 id="ListView-中元素避免半透明"><a href="#ListView-中元素避免半透明" class="headerlink" title="ListView 中元素避免半透明"></a>ListView 中元素避免半透明</h2><p>半透明绘制需要大量乘法计算，在滑动时不停重绘会造成大量的计算，在比较差的机子上会比较卡。在设计上能不半透明就不不半透明。<strong>实在要弄的话我个人是用个比较偷懒的方法，是在滑动的时候把半透明设置成不透明，滑动完再重新设置成半透明</strong>。</p>
<h2 id="尽量开启硬件加速"><a href="#尽量开启硬件加速" class="headerlink" title="尽量开启硬件加速"></a>尽量开启硬件加速</h2><p>硬件加速提升巨大，避免使用一些不支持的函数导致含泪关闭某个地方的硬件加速。</p>
<h2 id="AnimationCache"><a href="#AnimationCache" class="headerlink" title="AnimationCache"></a>AnimationCache</h2><p>在Layout布局中添加 <code>android:animationCache=&quot;false&quot;</code> ，或者调用方法 <code>public void setAnimationCacheEnabled(boolean enabled)</code> 。</p>
<blockquote>
<p>Enables or disables the children’s drawing cache during a layout animation.<br>By default, the drawing cache is enabled but this will prevent nested layout animations from working. To nest animations, you must disable the cache.</p>
</blockquote>
<p>在执行一个 Layout 动画时开启或关闭子控件的绘制缓存。默认情况下，绘制缓存是开启的，但是这将阻止嵌套 Layout 动画的正常执行。对于嵌套动画，你必须禁用这个缓存。</p>
<h2 id="ScrollingCache"><a href="#ScrollingCache" class="headerlink" title="ScrollingCache"></a>ScrollingCache</h2><p>在Layout布局中添加 <code>android:scrollingCache=&quot;false&quot;</code> ，或者调用方法 <code>public void setScrollingCacheEnabled(boolean enabled)</code> 。</p>
<blockquote>
<p>Enables or disables the children’s drawing cache during a scroll.<br>By default, the drawing cache is enabled but this will use more memory.</p>
<p>When the scrolling cache is enabled, the caches are kept after the first scrolling. You can manually clear the cache by calling android.view.ViewGroup.setChildrenDrawingCacheEnabled(boolean).</p>
</blockquote>
<p>在滚动期间执行子控件的绘制缓存。默认情况下，绘制缓存是开启的，但是这会导致使用更多的内存。当滑动缓存开启时，一开始滑动就保存了缓存，可以人工情况缓存。</p>
<h2 id="SmoothScrollbar"><a href="#SmoothScrollbar" class="headerlink" title="SmoothScrollbar"></a>SmoothScrollbar</h2><p>item 大小不一致的时候设置一下 <code>public void setSmoothScrollbarEnabled(boolean enabled)</code>可以让ListView滑动更流畅。</p>
<blockquote>
<p>When smooth scrollbar is enabled, the position and size of the scrollbar thumb is computed based on the number of visible pixels in the visible items. This however assumes that all list items have the same height. If you use a list in which items have different heights, the scrollbar will change appearance as the user scrolls through the list. To avoid this issue, you need to disable this property.</p>
<p>When smooth scrollbar is disabled, the position and size of the scrollbar thumb is based solely on the number of items in the adapter and the position of the visible items inside the adapter. This provides a stable scrollbar as the user navigates through a list of items with varying heights.</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.zhihu.com/question/19703384" target="_blank" rel="external">优化 listview 有哪些方法？</a></li>
<li><a href="https://code.facebook.com/posts/879498888759525/fast-rendering-news-feed-on-android/" target="_blank" rel="external">Fast Rendering News Feed on Android</a></li>
<li><a href="http://instagram-engineering.tumblr.com/post/114508858967/improving-comment-rendering-on-android" target="_blank" rel="external">Improving Comment Rendering on Android</a></li>
<li><a href="http://lucasr.org/2012/04/05/performance-tips-for-androids-listview/" target="_blank" rel="external">Performance Tips for Android’s ListView</a></li>
<li><a href="https://www.bignerdranch.com/blog/customizing-android-listview-rows-subclassing/" target="_blank" rel="external">Customizing Android ListView Rows by Subclassing</a></li>
</ul>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/ListView/">ListView</a>
      
	  </div>
    
	</section>
	
</article>
<script>
	window.subData = {
		title: 'ListView优化总结',
		tools: true
	}
</script>


    
      <div class="duoshuo" id="comments">
    <!-- UY BEGIN -->
	<div id="uyan_frame"></div>
	<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2141459"></script>
	<!-- UY END -->
</div>

    


      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='/img/as.gif' />

<div class='header'>yydcdut</div>
<div class='content'>
<div class='desc'> (ง •̀_•́)ง </div>
</div>
</section>


  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://github.com/yydcdut">
            <div class='name'>Github</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://weibo.com/yydcdut">
            <div class='name'>Weibo</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="mailto:yydcdut@qq.com">
            <div class='name'>Email</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://stackoverflow.com/users/4364595/yydcdut">
            <div class='name'>StackOverflow</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/Android/"><div class='name'>Android</div><div class='badget'>20</div></a></li>
    
        <li><a class="flat-box" href="/categories/Gradle/"><div class='name'>Gradle</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/Java/"><div class='name'>Java</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/扯蛋/"><div class='name'>扯蛋</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/读书笔记/"><div class='name'>读书笔记</div><div class='badget'>1</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/Android图像处理/" style="font-size: 14px; color: #808080">Android图像处理</a> <a href="/tags/AsyncTask/" style="font-size: 14px; color: #808080">AsyncTask</a> <a href="/tags/Dex/" style="font-size: 16px; color: #555">Dex</a> <a href="/tags/ElasticScrollView/" style="font-size: 14px; color: #808080">ElasticScrollView</a> <a href="/tags/EventBus/" style="font-size: 14px; color: #808080">EventBus</a> <a href="/tags/ExplosionField/" style="font-size: 14px; color: #808080">ExplosionField</a> <a href="/tags/Gradle/" style="font-size: 16px; color: #555">Gradle</a> <a href="/tags/ListView/" style="font-size: 16px; color: #555">ListView</a> <a href="/tags/SwipeBack/" style="font-size: 14px; color: #808080">SwipeBack</a> <a href="/tags/TextView/" style="font-size: 14px; color: #808080">TextView</a> <a href="/tags/UI/" style="font-size: 14px; color: #808080">UI</a> <a href="/tags/Volley/" style="font-size: 14px; color: #808080">Volley</a> <a href="/tags/drag/" style="font-size: 14px; color: #808080">drag</a> <a href="/tags/support-v4/" style="font-size: 16px; color: #555">support-v4</a> <a href="/tags/传感器/" style="font-size: 14px; color: #808080">传感器</a> <a href="/tags/动画/" style="font-size: 14px; color: #808080">动画</a> <a href="/tags/扯蛋/" style="font-size: 14px; color: #808080">扯蛋</a> <a href="/tags/权限/" style="font-size: 14px; color: #808080">权限</a> <a href="/tags/流程/" style="font-size: 14px; color: #808080">流程</a> <a href="/tags/源码/" style="font-size: 20px; color: #000">源码</a> <a href="/tags/粒子爆炸/" style="font-size: 14px; color: #808080">粒子爆炸</a> <a href="/tags/自定义控件/" style="font-size: 18px; color: #2b2b2b">自定义控件</a> <a href="/tags/读书笔记/" style="font-size: 14px; color: #808080">读书笔记</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  
    <script type="text/javascript" src="/live2d/script.js"></script>
    <canvas id="live2dcanvas" width="150" height="300" class="live2d"></canvas>
    <style>
      #live2dcanvas {
        position: fixed;
        z-index: 999;
        pointer-events: none;
        bottom: -40px;
      }
    </style>
    <script>loadlive2d("live2dcanvas" ,"/live2d/assets/shizuku/shizuku.model.json")</script>
  
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/yydcdut" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="http://weibo.com/yydcdut" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
        <a href="mailto:yydcdut@qq.com" class="social mail"
          target="_blank" rel="external">
          <span class="icon icon-mail"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js" type="text/javascript"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js" type="text/javascript"></script>
<script src="/js/app.js" type="text/javascript"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
