<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>android-crop源码解析 | Android杂文 - yydcdut</title>
  <meta name="description" content="Android技术杂文,yydcdut" />
  <meta name="keywords" content="blog,博客,Android,开源,源码,Android源码,yydcdut" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternative" href="/atom.xml" title="Android杂文 - yydcdut" type="application/atom+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Github: android-crop      分析版本：adb9b6e

android-crop 是一个基于 AOSP 的图片裁剪库。">
<meta property="og:type" content="article">
<meta property="og:title" content="android-crop源码解析">
<meta property="og:url" content="http://yydcdut.com/2016/04/17/android-crop-analyse/index.html">
<meta property="og:site_name" content="Android杂文 - yydcdut">
<meta property="og:description" content="Github: android-crop      分析版本：adb9b6e

android-crop 是一个基于 AOSP 的图片裁剪库。">
<meta property="og:image" content="http://7xs03u.com1.z0.glb.clouddn.com/android_crop_highlightview.jpg">
<meta property="og:updated_time" content="2016-05-21T07:30:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android-crop源码解析">
<meta name="twitter:description" content="Github: android-crop      分析版本：adb9b6e

android-crop 是一个基于 AOSP 的图片裁剪库。">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css" type="text/css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/' >
				Android杂文 - yydcdut
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
					
						<li>
							<a class='flat-box nav-about' href='/me'>
								About
							</a>
						</li>
					
				</ul>
				<div class='underline'></div>
			</div>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
				
				<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
			</ul>
		</div>
		
		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
		
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
		
			<a href="/me" class="nav-about nav">
				About
			</a>
		
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-android-crop-analyse"
  class="post white-box article-type-post"
  itemscope itemprop="blogPost">
	<section class='meta'>
	<h2 class="title">
  	<a href="/2016/04/17/android-crop-analyse/">
    	android-crop源码解析
    </a>
  </h2>
	<time>
	  4月 17, 2016
	</time>
	
    
    <div class='cats'>
        <a href="/categories/Android/">Android</a>
    </div>

	</section>
	
		<section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#android-crop"><span class="toc-number">1.</span> <span class="toc-text">android-crop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用"><span class="toc-number">2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码解析"><span class="toc-number">3.</span> <span class="toc-text">源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#选择图片"><span class="toc-number">3.1.</span> <span class="toc-text">选择图片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#裁图前的准备"><span class="toc-number">3.2.</span> <span class="toc-text">裁图前的准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#真正裁剪"><span class="toc-number">3.3.</span> <span class="toc-text">真正裁剪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RotateBitmap"><span class="toc-number">3.4.</span> <span class="toc-text">RotateBitmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HighlightView"><span class="toc-number">3.5.</span> <span class="toc-text">HighlightView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CropImageView"><span class="toc-number">3.6.</span> <span class="toc-text">CropImageView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ImageViewTouchBase"><span class="toc-number">3.7.</span> <span class="toc-text">ImageViewTouchBase</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></section>
	
	<section class="article typo">
  	<div class="article-entry" itemprop="articleBody">
    	<blockquote>
<p>Github: <a href="https://github.com/jdamcd/android-crop" target="_blank" rel="external">android-crop</a>      分析版本：<a href="https://github.com/jdamcd/android-crop/tree/2db9b6eeaea5990947a2bf07288b0852a272945a" target="_blank" rel="external">adb9b6e</a></p>
</blockquote>
<p>android-crop 是一个基于 AOSP 的图片裁剪库。</p>
<a id="more"></a>
<h2 id="android-crop"><a href="#android-crop" class="headerlink" title="android-crop"></a>android-crop</h2><p><img src="http://7xs03u.com1.z0.glb.clouddn.com/android_crop_highlightview.jpg" alt="android-crop"></p>
<p>整个界面分为上面的两个 Button，显示的 CropImageView，裁剪显示区域的 HighlightView。通过拖拉已经放大缩小 HighlightView 来确定裁剪区域。同时当 HighlightView 缩小的一定值的时候， CropImageView 也会缩小。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>引入包：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.soundcloud.android:android-crop:1.0.1@aar'</span></span><br></pre></td></tr></table></figure>
<p>在 <code>AndroidManifest.xml</code> 中申明 <code>CropImageActivity</code> :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">activity</span> <span class="attribute">android:name</span>=<span class="value">"com.soundcloud.android.crop.CropImageActivity"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>选择想要裁剪的图片（选择图片的这个过程也可以自己完成）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Crop.pickImage(activity)</span><br></pre></td></tr></table></figure>
<p>之后会返回到 <code>onActivityResult</code> 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (requestCode == Crop.REQUEST_PICK &amp;&amp; resultCode == RESULT_OK) &#123;</span><br><span class="line">		beginCrop(result.getData());</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行裁剪：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beginCrop</span><span class="params">(Uri source)</span> </span>&#123;</span><br><span class="line">	Uri destination = Uri.fromFile(<span class="keyword">new</span> File(getCacheDir(), <span class="string">"cropped"</span>));<span class="comment">//temp url</span></span><br><span class="line">	Crop.of(source, destination).asSquare().start(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>裁剪完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent result)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (requestCode == Crop.REQUEST_CROPK) &#123;</span><br><span class="line">		handleCrop(resultCode, result);</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="选择图片"><a href="#选择图片" class="headerlink" title="选择图片"></a>选择图片</h3><p>先从选择图片开始看，这个地方也就是通过 <code>Intent</code> 的 type 为 <code>image/*</code> 去做操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Crop</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * Pick image from an Activity</span><br><span class="line">     * 通过Activity的方式启动</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> activity Activity to receive result</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pickImage</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        pickImage(activity, REQUEST_PICK);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * Pick image from an Activity with a custom request code</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> activity    Activity to receive result</span><br><span class="line">     * <span class="doctag">@param</span> requestCode requestCode for result</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pickImage</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            activity.startActivityForResult(getImagePicker(), requestCode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ActivityNotFoundException e) &#123;</span><br><span class="line">            showImagePickerError(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Intent <span class="title">getImagePicker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Intent(Intent.ACTION_GET_CONTENT).setType(<span class="string">"image/*"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showImagePickerError</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(context, R.string.crop__pick_error, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>Crop</code> 中不仅仅提供了 <code>Activity</code> 的方式，同时还提供了 <code>android.app.Fragment</code> 和 <code>android.support.v4.app.Fragment</code> 的方式。</p>
<h3 id="裁图前的准备"><a href="#裁图前的准备" class="headerlink" title="裁图前的准备"></a>裁图前的准备</h3><p>先从入口开始看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Uri destination = Uri.fromFile(<span class="keyword">new</span> File(getCacheDir(), <span class="string">"cropped"</span>));</span><br><span class="line">Crop.of(source, destination).asSquare().start(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>传入的 <code>destination</code> 是裁剪完之后保存的地址。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Crop</span> </span>&#123;</span><br><span class="line">  	<span class="class"><span class="keyword">interface</span> <span class="title">Extra</span> </span>&#123;</span><br><span class="line">        String ASPECT_X = <span class="string">"aspect_x"</span>;</span><br><span class="line">        String ASPECT_Y = <span class="string">"aspect_y"</span>;</span><br><span class="line">        String MAX_X = <span class="string">"max_x"</span>;</span><br><span class="line">        String MAX_Y = <span class="string">"max_y"</span>;</span><br><span class="line">        String ERROR = <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Intent cropIntent;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * Create a crop Intent builder with source and destination image Uris</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> source      Uri for image to crop</span><br><span class="line">     * <span class="doctag">@param</span> destination Uri for saving the cropped image</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Crop <span class="title">of</span><span class="params">(Uri source, Uri destination)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Crop(source, destination);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="title">Crop</span><span class="params">(Uri source, Uri destination)</span> </span>&#123;</span><br><span class="line">        cropIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">        cropIntent.setData(source);</span><br><span class="line">        cropIntent.putExtra(MediaStore.EXTRA_OUTPUT, destination);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * Crop area with fixed 1:1 aspect ratio</span><br><span class="line">     * X:Y 的比例为 1:1</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Crop <span class="title">asSquare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cropIntent.putExtra(Extra.ASPECT_X, <span class="number">1</span>);</span><br><span class="line">        cropIntent.putExtra(Extra.ASPECT_Y, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * Send the crop Intent from an Activity</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> activity Activity to receive result</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        start(activity, REQUEST_CROP);</span><br><span class="line">    &#125;</span><br><span class="line">  	</span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * Send the crop Intent from an Activity with a custom request code</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> activity    Activity to receive result</span><br><span class="line">     * <span class="doctag">@param</span> requestCode requestCode for result</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Activity activity, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">        activity.startActivityForResult(getIntent(activity), requestCode);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * Get Intent to start crop Activity</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> context Context</span><br><span class="line">     * <span class="doctag">@return</span> Intent for CropImageActivity</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">getIntent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        cropIntent.setClass(context, CropImageActivity.class);</span><br><span class="line">        <span class="keyword">return</span> cropIntent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用 <code>Crop.of(source, destination).asSquare().start(this)</code> 进入到 <code>CropImageActivity</code> 这个界面中。其中还经历了许多的配置，比如初始化的时候裁图显示的X/Y比例是多少等。</p>
<p>那么进入到 <code>CropImageActivity</code> 中看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CropImageActivity</span> <span class="keyword">extends</span> <span class="title">MonitoredActivity</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE_DEFAULT = <span class="number">2048</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE_LIMIT = <span class="number">4096</span>;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">int</span> aspectX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> aspectY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Output image</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> exifRotation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Uri sourceUri;<span class="comment">//要裁图的图片的uri</span></span><br><span class="line">    <span class="keyword">private</span> Uri saveUri;<span class="comment">//裁完图的图片要保存的地址</span></span><br><span class="line">  </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler();</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">private</span> CropImageView imageView;<span class="comment">//显示bitmap的View</span></span><br><span class="line">	<span class="keyword">private</span> HighlightView cropView;<span class="comment">//显示裁剪的View</span></span><br><span class="line">  </span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line">        setupWindowFlags();<span class="comment">//初始化界面</span></span><br><span class="line">        setupViews();<span class="comment">//初始化界面里的控件</span></span><br><span class="line"></span><br><span class="line">        loadInput();<span class="comment">//加载传入的数据</span></span><br><span class="line">        <span class="keyword">if</span> (rotateBitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            finish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        startCrop();<span class="comment">//开始裁剪</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * 加载数据</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Intent intent = getIntent();</span><br><span class="line">        Bundle extras = intent.getExtras();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (extras != <span class="keyword">null</span>) &#123;</span><br><span class="line">            aspectX = extras.getInt(Crop.Extra.ASPECT_X);</span><br><span class="line">            aspectY = extras.getInt(Crop.Extra.ASPECT_Y);</span><br><span class="line">            maxX = extras.getInt(Crop.Extra.MAX_X);</span><br><span class="line">            maxY = extras.getInt(Crop.Extra.MAX_Y);</span><br><span class="line">            saveUri = extras.getParcelable(MediaStore.EXTRA_OUTPUT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sourceUri = intent.getData();</span><br><span class="line">        <span class="keyword">if</span> (sourceUri != <span class="keyword">null</span>) &#123;</span><br><span class="line">            exifRotation = CropUtil.getExifRotation(CropUtil.getFromMediaUri(<span class="keyword">this</span>, getContentResolver(), sourceUri));<span class="comment">//通过图片的Exif信息得到要选择多少度</span></span><br><span class="line"></span><br><span class="line">            InputStream is = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sampleSize = calculateBitmapSampleSize(sourceUri);<span class="comment">//计算图片在decode的时候的sampleSize</span></span><br><span class="line">                is = getContentResolver().openInputStream(sourceUri);</span><br><span class="line">                BitmapFactory.Options option = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">                option.inSampleSize = sampleSize;</span><br><span class="line">              	<span class="comment">//decode出通过exif信息旋转之后，通过option的simpleSize采样缩放之后的bitmap，赋值给成员变量rotateBitmap</span></span><br><span class="line">                rotateBitmap = <span class="keyword">new</span> RotateBitmap(BitmapFactory.decodeStream(is, <span class="keyword">null</span>, option), exifRotation);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.e(<span class="string">"Error reading image: "</span> + e.getMessage(), e);</span><br><span class="line">                setResultException(e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">                Log.e(<span class="string">"OOM reading image: "</span> + e.getMessage(), e);</span><br><span class="line">                setResultException(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                CropUtil.closeSilently(is);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * 计算simpleSize</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">calculateBitmapSampleSize</span><span class="params">(Uri bitmapUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = getContentResolver().openInputStream(bitmapUri);</span><br><span class="line">            BitmapFactory.decodeStream(is, <span class="keyword">null</span>, options); <span class="comment">//bitmap的高宽都存到了options中</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CropUtil.closeSilently(is);<span class="comment">//关流</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> maxSize = getMaxImageSize();<span class="comment">//得到最大的显示size</span></span><br><span class="line">        <span class="keyword">int</span> sampleSize = <span class="number">1</span>;</span><br><span class="line">      	<span class="comment">//通过bitmap的高或者宽除以simpleSize得到的值与maxSize对比，如果还大的话，simpleSize向右移动一位，就是乘以2，如果都不大于maxSize的话，就选定当前这个值</span></span><br><span class="line">        <span class="keyword">while</span> (options.outHeight / sampleSize &gt; maxSize || options.outWidth / sampleSize &gt; maxSize) &#123;</span><br><span class="line">            sampleSize = sampleSize &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sampleSize;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * 得到最大的Size</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMaxImageSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> textureLimit = getMaxTextureSize();</span><br><span class="line">        <span class="keyword">if</span> (textureLimit == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> SIZE_DEFAULT;<span class="comment">//2048</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Math.min(textureLimit, SIZE_LIMIT);<span class="comment">//4096</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * OpenGL的texture的大小是ImageView最大绘制的大小</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMaxTextureSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The OpenGL texture size is the maximum size that can be drawn in an ImageView</span></span><br><span class="line">        <span class="keyword">int</span>[] maxSize = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        GLES10.glGetIntegerv(GLES10.GL_MAX_TEXTURE_SIZE, maxSize, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> maxSize[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startCrop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isFinishing()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">//设置bitmap</span></span><br><span class="line">        imageView.setImageRotateBitmapResetBase(rotateBitmap, <span class="keyword">true</span>);</span><br><span class="line">        CropUtil.startBackgroundJob(<span class="keyword">this</span>, <span class="keyword">null</span>, getResources().getString(R.string.crop__wait),</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                      	<span class="comment">//线程计数器</span></span><br><span class="line">                        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">                      	<span class="comment">//主线程进行UI操作</span></span><br><span class="line">                        handler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (imageView.getScale() == <span class="number">1F</span>) &#123;</span><br><span class="line">                                    imageView.center();</span><br><span class="line">                                &#125;</span><br><span class="line">                                latch.countDown();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                      	<span class="comment">//子线程阻塞住，直到latch.countDown();执行</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            latch.await();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                        &#125;</span><br><span class="line">                      	<span class="comment">//设置裁剪View</span></span><br><span class="line">                        <span class="keyword">new</span> Cropper().crop();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, handler</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Cropper</span> </span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">crop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            handler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    makeDefault();<span class="comment">//设置默认值</span></span><br><span class="line">                    imageView.invalidate();<span class="comment">//更新绘制</span></span><br><span class="line">                    <span class="keyword">if</span> (imageView.highlightViews.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                        cropView = imageView.highlightViews.get(<span class="number">0</span>);</span><br><span class="line">                        cropView.setFocus(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">makeDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (rotateBitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            HighlightView hv = <span class="keyword">new</span> HighlightView(imageView);<span class="comment">//这个imageview就是CropImageView</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> width = rotateBitmap.getWidth();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> height = rotateBitmap.getHeight();</span><br><span class="line"></span><br><span class="line">            Rect imageRect = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make the default size about 4/5 of the width or height</span></span><br><span class="line">            <span class="keyword">int</span> cropWidth = Math.min(width, height) * <span class="number">4</span> / <span class="number">5</span>;<span class="comment">//要显示裁剪的view的宽度是bitmap的宽度或高度中的最小值的4/5</span></span><br><span class="line">            <span class="annotation">@SuppressWarnings</span>(<span class="string">"SuspiciousNameCombination"</span>)</span><br><span class="line">            <span class="keyword">int</span> cropHeight = cropWidth;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (aspectX != <span class="number">0</span> &amp;&amp; aspectY != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (aspectX &gt; aspectY) &#123;<span class="comment">//根据传入的X:Y的比例进行设置</span></span><br><span class="line">                    cropHeight = cropWidth * aspectY / aspectX;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cropWidth = cropHeight * aspectX / aspectY;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> x = (width - cropWidth) / <span class="number">2</span>;<span class="comment">//裁剪view的x坐标</span></span><br><span class="line">            <span class="keyword">int</span> y = (height - cropHeight) / <span class="number">2</span>;<span class="comment">//裁剪view的y坐标</span></span><br><span class="line"></span><br><span class="line">            RectF cropRect = <span class="keyword">new</span> RectF(x, y, x + cropWidth, y + cropHeight);</span><br><span class="line">            hv.setup(imageView.getUnrotatedMatrix(), imageRect, cropRect, aspectX != <span class="number">0</span> &amp;&amp; aspectY != <span class="number">0</span>);<span class="comment">//初始化HighlightView</span></span><br><span class="line">            imageView.add(hv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>startCrop</code> 中做的 job 是以下操作，主要是通过 <code>Activity</code> 生命周期来显示或者隐藏 <code>Dialog</code> 和在子线程中执行 job 操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CropUtil</span> </span>&#123;</span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * 该方法主要操作就是进行耗时操作前后显示dialog，同时监听Activity的生命去显示和隐藏dialog</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> activity</span><br><span class="line">     * <span class="doctag">@param</span> title</span><br><span class="line">     * <span class="doctag">@param</span> message</span><br><span class="line">     * <span class="doctag">@param</span> job</span><br><span class="line">     * <span class="doctag">@param</span> handler</span><br><span class="line">     */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startBackgroundJob</span><span class="params">(MonitoredActivity activity, String title, String message, Runnable job, Handler handler)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Make the progress dialog uncancelable, so that we can guarantee</span></span><br><span class="line">        <span class="comment">// the thread will be done before the activity getting destroyed</span></span><br><span class="line">        ProgressDialog dialog = ProgressDialog.show(</span><br><span class="line">                activity, title, message, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> BackgroundJob(activity, job, dialog, handler)).start();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">//MonitoredActivity.LifeCycleAdapter是Activity的生命周期监听的一个Adapter</span></span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundJob</span> <span class="keyword">extends</span> <span class="title">MonitoredActivity</span>.<span class="title">LifeCycleAdapter</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MonitoredActivity activity;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ProgressDialog dialog;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Runnable job;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Handler handler;<span class="comment">//主线程的handler</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Runnable cleanupRunner = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              	<span class="comment">//从activity中remove掉，防止泄露</span></span><br><span class="line">                activity.removeLifeCycleListener(BackgroundJob.<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">if</span> (dialog.getWindow() != <span class="keyword">null</span>) dialog.dismiss();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BackgroundJob</span><span class="params">(MonitoredActivity activity, Runnable job,</span><br><span class="line">                             ProgressDialog dialog, Handler handler)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.activity = activity;</span><br><span class="line">            <span class="keyword">this</span>.dialog = dialog;</span><br><span class="line">            <span class="keyword">this</span>.job = job;</span><br><span class="line">            <span class="keyword">this</span>.activity.addLifeCycleListener(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">this</span>.handler = handler;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              	<span class="comment">//执行job</span></span><br><span class="line">                job.run();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                handler.post(cleanupRunner);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(MonitoredActivity activity)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// We get here only when the onDestroyed being called before</span></span><br><span class="line">            <span class="comment">// the cleanupRunner. So, run it now and remove it from the queue</span></span><br><span class="line">            cleanupRunner.run();</span><br><span class="line">            handler.removeCallbacks(cleanupRunner);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(MonitoredActivity activity)</span> </span>&#123;</span><br><span class="line">          	<span class="comment">//当Activity的状态为stop的时候，将dialog隐藏掉</span></span><br><span class="line">            dialog.hide();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStarted</span><span class="params">(MonitoredActivity activity)</span> </span>&#123;</span><br><span class="line">          	<span class="comment">//当Activity的状态为started的时候，将dialog显示出来</span></span><br><span class="line">            dialog.show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="真正裁剪"><a href="#真正裁剪" class="headerlink" title="真正裁剪"></a>真正裁剪</h3><p>当点击『完成』时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CropImageActivity</span> <span class="keyword">extends</span> <span class="title">MonitoredActivity</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClicked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cropView == <span class="keyword">null</span> || isSaving) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        isSaving = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        Bitmap croppedImage;</span><br><span class="line">      	<span class="comment">//得到HighlightView的Rect大小</span></span><br><span class="line">        Rect r = cropView.getScaledCropRect(sampleSize);</span><br><span class="line">        <span class="keyword">int</span> width = r.width();</span><br><span class="line">        <span class="keyword">int</span> height = r.height();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outWidth = width;</span><br><span class="line">        <span class="keyword">int</span> outHeight = height;</span><br><span class="line">      	<span class="comment">//如果intent传参传的是maxX和maxY的话，这里就需要进行判断</span></span><br><span class="line">      	<span class="comment">//如果裁剪出的width大于maxX或者裁剪出的height大于maxY，则进行比例缩放</span></span><br><span class="line">        <span class="keyword">if</span> (maxX &gt; <span class="number">0</span> &amp;&amp; maxY &gt; <span class="number">0</span> &amp;&amp; (width &gt; maxX || height &gt; maxY)) &#123;</span><br><span class="line">            <span class="keyword">float</span> ratio = (<span class="keyword">float</span>) width / (<span class="keyword">float</span>) height;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">float</span>) maxX / (<span class="keyword">float</span>) maxY &gt; ratio) &#123;</span><br><span class="line">                outHeight = maxY;</span><br><span class="line">                outWidth = (<span class="keyword">int</span>) ((<span class="keyword">float</span>) maxY * ratio + .<span class="number">5f</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outWidth = maxX;</span><br><span class="line">                outHeight = (<span class="keyword">int</span>) ((<span class="keyword">float</span>) maxX / ratio + .<span class="number">5f</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	<span class="comment">//得到裁剪之后的Bitmap</span></span><br><span class="line">            croppedImage = decodeRegionCrop(r, outWidth, outHeight);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            setResultException(e);</span><br><span class="line">            finish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (croppedImage != <span class="keyword">null</span>) &#123;</span><br><span class="line">          	<span class="comment">//在CropImageView中显示裁剪了的bitmap</span></span><br><span class="line">            imageView.setImageRotateBitmapResetBase(<span class="keyword">new</span> RotateBitmap(croppedImage, exifRotation), <span class="keyword">true</span>);</span><br><span class="line">            imageView.center();</span><br><span class="line">            imageView.highlightViews.clear();</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">//保存裁剪之后的bitmap</span></span><br><span class="line">        saveImage(croppedImage);</span><br><span class="line">    &#125;</span><br><span class="line">  	</span><br><span class="line">  	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeRegionCrop</span><span class="params">(Rect rect, <span class="keyword">int</span> outWidth, <span class="keyword">int</span> outHeight)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Release memory now</span></span><br><span class="line">      	<span class="comment">//释放CropImageView中的bitmap</span></span><br><span class="line">        clearImageView();</span><br><span class="line"></span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        Bitmap croppedImage = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            is = getContentResolver().openInputStream(sourceUri);</span><br><span class="line">          	<span class="comment">//得到BitmapRegionDecoder</span></span><br><span class="line">            BitmapRegionDecoder decoder = BitmapRegionDecoder.newInstance(is, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> width = decoder.getWidth();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> height = decoder.getHeight();</span><br><span class="line">			<span class="comment">//如果exif信息中要旋转</span></span><br><span class="line">            <span class="keyword">if</span> (exifRotation != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Adjust crop area to account for image rotation</span></span><br><span class="line">                Matrix matrix = <span class="keyword">new</span> Matrix();</span><br><span class="line">                matrix.setRotate(-exifRotation);</span><br><span class="line">				<span class="comment">//adjusted为旋转后的rect</span></span><br><span class="line">                RectF adjusted = <span class="keyword">new</span> RectF();</span><br><span class="line">                matrix.mapRect(adjusted, <span class="keyword">new</span> RectF(rect));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Adjust to account for origin at 0,0</span></span><br><span class="line">                adjusted.offset(adjusted.left &lt; <span class="number">0</span> ? width : <span class="number">0</span>, adjusted.top &lt; <span class="number">0</span> ? height : <span class="number">0</span>);</span><br><span class="line">                rect = <span class="keyword">new</span> Rect((<span class="keyword">int</span>) adjusted.left, (<span class="keyword">int</span>) adjusted.top, (<span class="keyword">int</span>) adjusted.right, (<span class="keyword">int</span>) adjusted.bottom);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              	<span class="comment">//裁剪rect区域的图像</span></span><br><span class="line">                croppedImage = decoder.decodeRegion(rect, <span class="keyword">new</span> BitmapFactory.Options());</span><br><span class="line">              	<span class="comment">//裁剪的宽度或高度大于想要的宽度或高度的话，通过矩阵进行缩放，然后再创建出一个想要高宽的bitmap</span></span><br><span class="line">                <span class="keyword">if</span> (croppedImage != <span class="keyword">null</span> &amp;&amp; (rect.width() &gt; outWidth || rect.height() &gt; outHeight)) &#123;</span><br><span class="line">                    Matrix matrix = <span class="keyword">new</span> Matrix();</span><br><span class="line">                    matrix.postScale((<span class="keyword">float</span>) outWidth / rect.width(), (<span class="keyword">float</span>) outHeight / rect.height());</span><br><span class="line">                    croppedImage = Bitmap.createBitmap(croppedImage, <span class="number">0</span>, <span class="number">0</span>, croppedImage.getWidth(), croppedImage.getHeight(), matrix, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                <span class="comment">// Rethrow with some extra information</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Rectangle "</span> + rect + <span class="string">" is outside of the image ("</span></span><br><span class="line">                        + width + <span class="string">","</span> + height + <span class="string">","</span> + exifRotation + <span class="string">")"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(<span class="string">"Error cropping image: "</span> + e.getMessage(), e);</span><br><span class="line">            setResultException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">            Log.e(<span class="string">"OOM cropping image: "</span> + e.getMessage(), e);</span><br><span class="line">            setResultException(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CropUtil.closeSilently(is);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> croppedImage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * 回收之前没有裁剪的bitmap</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearImageView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        imageView.clear();</span><br><span class="line">        <span class="keyword">if</span> (rotateBitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rotateBitmap.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveImage</span><span class="params">(Bitmap croppedImage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (croppedImage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> Bitmap b = croppedImage;</span><br><span class="line">            CropUtil.startBackgroundJob(<span class="keyword">this</span>, <span class="keyword">null</span>, getResources().getString(R.string.crop__saving),</span><br><span class="line">                    <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            saveOutput(b);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, handler</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	</span><br><span class="line">  	<span class="comment">/**</span><br><span class="line">     * 保存bitmap</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> croppedImage</span><br><span class="line">     */</span></span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveOutput</span><span class="params">(Bitmap croppedImage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (saveUri != <span class="keyword">null</span>) &#123;</span><br><span class="line">            OutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream = getContentResolver().openOutputStream(saveUri);</span><br><span class="line">                <span class="keyword">if</span> (outputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    croppedImage.compress(Bitmap.CompressFormat.JPEG, <span class="number">90</span>, outputStream);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                setResultException(e);</span><br><span class="line">                Log.e(<span class="string">"Cannot open file: "</span> + saveUri, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                CropUtil.closeSilently(outputStream);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CropUtil.copyExifRotation(</span><br><span class="line">                    CropUtil.getFromMediaUri(<span class="keyword">this</span>, getContentResolver(), sourceUri),</span><br><span class="line">                    CropUtil.getFromMediaUri(<span class="keyword">this</span>, getContentResolver(), saveUri)</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            setResultUri(saveUri);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Bitmap b = croppedImage;</span><br><span class="line">        handler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                imageView.clear();</span><br><span class="line">                b.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>裁剪是通过 <code>BitmapRegionDecoder</code> 来实现的，<code>BitmapRegionDecoder.newInstance(InputStream is, boolean isShareable)</code> ，传入的参数是一个 <code>InputStream</code> ，这样做的好处是可以减少创建出原图大小的 Bitmap ，达到节省内存，<em>有效的防止 OOM</em>。</strong></p>
<h3 id="RotateBitmap"><a href="#RotateBitmap" class="headerlink" title="RotateBitmap"></a>RotateBitmap</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RotateBitmap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Bitmap bitmap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> rotation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RotateBitmap</span><span class="params">(Bitmap bitmap, <span class="keyword">int</span> rotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bitmap = bitmap;</span><br><span class="line">        <span class="keyword">this</span>.rotation = rotation % <span class="number">360</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRotation</span><span class="params">(<span class="keyword">int</span> rotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rotation = rotation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRotation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> rotation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bitmap = bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//得到旋转的矩阵</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Matrix <span class="title">getRotateMatrix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// By default this is an identity matrix</span></span><br><span class="line">        Matrix matrix = <span class="keyword">new</span> Matrix();</span><br><span class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span> &amp;&amp; rotation != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// We want to do the rotation at origin, but since the bounding</span></span><br><span class="line">            <span class="comment">// rectangle will be changed after rotation, so the delta values</span></span><br><span class="line">            <span class="comment">// are based on old &amp; new width/height respectively.</span></span><br><span class="line">            <span class="keyword">int</span> cx = bitmap.getWidth() / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> cy = bitmap.getHeight() / <span class="number">2</span>;</span><br><span class="line">            matrix.preTranslate(-cx, -cy);</span><br><span class="line">            matrix.postRotate(rotation);</span><br><span class="line">            matrix.postTranslate(getWidth() / <span class="number">2</span>, getHeight() / <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matrix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOrientationChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (rotation / <span class="number">90</span>) % <span class="number">2</span> != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//得到高度，要判断exif中是否要旋转</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (isOrientationChanged()) &#123;</span><br><span class="line">            <span class="keyword">return</span> bitmap.getWidth();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> bitmap.getHeight();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//得到宽度，要判断exif中是否要旋转</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (isOrientationChanged()) &#123;</span><br><span class="line">            <span class="keyword">return</span> bitmap.getHeight();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> bitmap.getWidth();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//回收bitmap</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bitmap.recycle();</span><br><span class="line">            bitmap = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="HighlightView"><a href="#HighlightView" class="headerlink" title="HighlightView"></a>HighlightView</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HighlightView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GROW_NONE = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>);<span class="comment">//没有状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GROW_LEFT_EDGE = (<span class="number">1</span> &lt;&lt; <span class="number">1</span>);<span class="comment">//触摸到左边边界状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GROW_RIGHT_EDGE = (<span class="number">1</span> &lt;&lt; <span class="number">2</span>);<span class="comment">//触摸到右边边界状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GROW_TOP_EDGE = (<span class="number">1</span> &lt;&lt; <span class="number">3</span>);<span class="comment">//触摸到上面边界状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GROW_BOTTOM_EDGE = (<span class="number">1</span> &lt;&lt; <span class="number">4</span>);<span class="comment">//触摸到下边边界状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVE = (<span class="number">1</span> &lt;&lt; <span class="number">5</span>);<span class="comment">//移动状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_HIGHLIGHT_COLOR = <span class="number">0xFF33B5E5</span>;<span class="comment">//默认颜色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> HANDLE_RADIUS_DP = <span class="number">12f</span>;<span class="comment">//默认handle的半径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> OUTLINE_DP = <span class="number">2f</span>;<span class="comment">//线的宽度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> ModifyMode &#123;None, Move, Grow&#125;<span class="comment">//当前触摸状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> HandleMode &#123;Changing, Always, Never&#125;</span><br><span class="line"></span><br><span class="line">    RectF cropRect; <span class="comment">// Image space</span></span><br><span class="line">    Rect drawRect; <span class="comment">// Screen space</span></span><br><span class="line">    Matrix matrix;</span><br><span class="line">    <span class="keyword">private</span> RectF imageRect; <span class="comment">// Image space</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Paint outsidePaint = <span class="keyword">new</span> Paint();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Paint outlinePaint = <span class="keyword">new</span> Paint();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Paint handlePaint = <span class="keyword">new</span> Paint();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> View viewContext; <span class="comment">// View displaying image</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> showThirds;<span class="comment">//是否绘制裁剪View里面的四条线</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> showCircle;<span class="comment">//是否绘制圆</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> highlightColor;<span class="comment">//裁剪View绘制的颜色</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ModifyMode modifyMode = ModifyMode.None;</span><br><span class="line">    <span class="keyword">private</span> HandleMode handleMode = HandleMode.Changing;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> maintainAspectRatio;<span class="comment">//是否希望变化的时候保存X/Y的比例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> initialAspectRatio;<span class="comment">//初始化的时候比例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> handleRadius;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> outlineWidth;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFocused;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HighlightView</span><span class="params">(View context)</span> </span>&#123;</span><br><span class="line">        viewContext = context;</span><br><span class="line">        initStyles(context.getContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initStyles</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//读取attr的值</span></span><br><span class="line">        TypedValue outValue = <span class="keyword">new</span> TypedValue();</span><br><span class="line">        context.getTheme().resolveAttribute(R.attr.cropImageStyle, outValue, <span class="keyword">true</span>);</span><br><span class="line">        TypedArray attributes = context.obtainStyledAttributes(outValue.resourceId, R.styleable.CropImageView);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            showThirds = attributes.getBoolean(R.styleable.CropImageView_showThirds, <span class="keyword">false</span>);</span><br><span class="line">            showCircle = attributes.getBoolean(R.styleable.CropImageView_showCircle, <span class="keyword">false</span>);</span><br><span class="line">            highlightColor = attributes.getColor(R.styleable.CropImageView_highlightColor,</span><br><span class="line">                    DEFAULT_HIGHLIGHT_COLOR);</span><br><span class="line">            handleMode = HandleMode.values()[attributes.getInt(R.styleable.CropImageView_showHandles, <span class="number">0</span>)];</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            attributes.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Matrix m, Rect imageRect, RectF cropRect, <span class="keyword">boolean</span> maintainAspectRatio)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//通过传进来的Matrix生成一个新的Matrix赋值给成员变量</span></span><br><span class="line">        matrix = <span class="keyword">new</span> Matrix(m);</span><br><span class="line">		<span class="comment">//裁剪的区域</span></span><br><span class="line">        <span class="keyword">this</span>.cropRect = cropRect;</span><br><span class="line">      	<span class="comment">//整个图的区域</span></span><br><span class="line">        <span class="keyword">this</span>.imageRect = <span class="keyword">new</span> RectF(imageRect);</span><br><span class="line">      	<span class="comment">//希望保持比例</span></span><br><span class="line">        <span class="keyword">this</span>.maintainAspectRatio = maintainAspectRatio;</span><br><span class="line">		<span class="comment">//得到初始化比例</span></span><br><span class="line">        initialAspectRatio = <span class="keyword">this</span>.cropRect.width() / <span class="keyword">this</span>.cropRect.height();</span><br><span class="line">      	<span class="comment">//匹配裁剪区域对应到屏幕坐标系上</span></span><br><span class="line">        drawRect = computeLayout();</span><br><span class="line">		<span class="comment">//初始化画笔</span></span><br><span class="line">        outsidePaint.setARGB(<span class="number">125</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>);</span><br><span class="line">        outlinePaint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        outlinePaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">        outlineWidth = dpToPx(OUTLINE_DP);</span><br><span class="line"></span><br><span class="line">        handlePaint.setColor(highlightColor);</span><br><span class="line">        handlePaint.setStyle(Paint.Style.FILL);</span><br><span class="line">        handlePaint.setAntiAlias(<span class="keyword">true</span>);</span><br><span class="line">        handleRadius = dpToPx(HANDLE_RADIUS_DP);</span><br><span class="line">		<span class="comment">//当前ModifyMode为None</span></span><br><span class="line">        modifyMode = ModifyMode.None;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">dpToPx</span><span class="params">(<span class="keyword">float</span> dp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dp * viewContext.getResources().getDisplayMetrics().density;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//保存</span></span><br><span class="line">        canvas.save();</span><br><span class="line">        Path path = <span class="keyword">new</span> Path();</span><br><span class="line">        outlinePaint.setStrokeWidth(outlineWidth);</span><br><span class="line">      	<span class="comment">//如果没有获得焦点，那么绘制黑色</span></span><br><span class="line">        <span class="keyword">if</span> (!hasFocus()) &#123;</span><br><span class="line">            outlinePaint.setColor(Color.BLACK);</span><br><span class="line">            canvas.drawRect(drawRect, outlinePaint);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//获得了焦点的情况下</span></span><br><span class="line">          	<span class="comment">//得到CropImageView的Rect区域</span></span><br><span class="line">            Rect viewDrawingRect = <span class="keyword">new</span> Rect();</span><br><span class="line">            viewContext.getDrawingRect(viewDrawingRect);</span><br><span class="line"></span><br><span class="line">            path.addRect(<span class="keyword">new</span> RectF(drawRect), Path.Direction.CW);</span><br><span class="line">            outlinePaint.setColor(highlightColor);</span><br><span class="line">			<span class="comment">//是否支持硬件加速</span></span><br><span class="line">            <span class="keyword">if</span> (isClipPathSupported(canvas)) &#123;</span><br><span class="line">              	<span class="comment">//clipPath取不属于RectF(drawRect)和viewDrawingRect的集合</span></span><br><span class="line">                canvas.clipPath(path, Region.Op.DIFFERENCE);</span><br><span class="line">                canvas.drawRect(viewDrawingRect, outsidePaint);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                drawOutsideFallback(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//回到保存之前的样子</span></span><br><span class="line">            canvas.restore();</span><br><span class="line">          	<span class="comment">//画path</span></span><br><span class="line">            canvas.drawPath(path, outlinePaint);</span><br><span class="line">			<span class="comment">//画中间的四条线</span></span><br><span class="line">            <span class="keyword">if</span> (showThirds) &#123;</span><br><span class="line">                drawThirds(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//画圆</span></span><br><span class="line">            <span class="keyword">if</span> (showCircle) &#123;</span><br><span class="line">                drawCircle(canvas);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (handleMode == HandleMode.Always || (handleMode == HandleMode.Changing &amp;&amp; modifyMode == ModifyMode.Grow)) &#123;</span><br><span class="line">				<span class="comment">//画handle的圆</span></span><br><span class="line">                drawHandles(canvas);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Fall back to naive method for darkening outside crop area</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawOutsideFallback</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        canvas.drawRect(<span class="number">0</span>, <span class="number">0</span>, canvas.getWidth(), drawRect.top, outsidePaint);</span><br><span class="line">        canvas.drawRect(<span class="number">0</span>, drawRect.bottom, canvas.getWidth(), canvas.getHeight(), outsidePaint);</span><br><span class="line">        canvas.drawRect(<span class="number">0</span>, drawRect.top, drawRect.left, drawRect.bottom, outsidePaint);</span><br><span class="line">        canvas.drawRect(drawRect.right, drawRect.top, canvas.getWidth(), drawRect.bottom, outsidePaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Clip path is broken, unreliable or not supported on:</span><br><span class="line">     * - JellyBean MR1</span><br><span class="line">     * - ICS &amp; ICS MR1 with hardware acceleration turned on</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@SuppressLint</span>(<span class="string">"NewApi"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isClipPathSupported</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT == Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.ICE_CREAM_SANDWICH)</span><br><span class="line">                || Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.ICE_CREAM_SANDWICH_MR1) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> !canvas.isHardwareAccelerated();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * 画handle的圆</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> canvas</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawHandles</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> xMiddle = drawRect.left + ((drawRect.right - drawRect.left) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> yMiddle = drawRect.top + ((drawRect.bottom - drawRect.top) / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        canvas.drawCircle(drawRect.left, yMiddle, handleRadius, handlePaint);</span><br><span class="line">        canvas.drawCircle(xMiddle, drawRect.top, handleRadius, handlePaint);</span><br><span class="line">        canvas.drawCircle(drawRect.right, yMiddle, handleRadius, handlePaint);</span><br><span class="line">        canvas.drawCircle(xMiddle, drawRect.bottom, handleRadius, handlePaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">     * 画里面的四条线</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> canvas</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawThirds</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        outlinePaint.setStrokeWidth(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">float</span> xThird = (drawRect.right - drawRect.left) / <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">float</span> yThird = (drawRect.bottom - drawRect.top) / <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        canvas.drawLine(drawRect.left + xThird, drawRect.top,</span><br><span class="line">                drawRect.left + xThird, drawRect.bottom, outlinePaint);</span><br><span class="line">        canvas.drawLine(drawRect.left + xThird * <span class="number">2</span>, drawRect.top,</span><br><span class="line">                drawRect.left + xThird * <span class="number">2</span>, drawRect.bottom, outlinePaint);</span><br><span class="line">        canvas.drawLine(drawRect.left, drawRect.top + yThird,</span><br><span class="line">                drawRect.right, drawRect.top + yThird, outlinePaint);</span><br><span class="line">        canvas.drawLine(drawRect.left, drawRect.top + yThird * <span class="number">2</span>,</span><br><span class="line">                drawRect.right, drawRect.top + yThird * <span class="number">2</span>, outlinePaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        outlinePaint.setStrokeWidth(<span class="number">1</span>);</span><br><span class="line">        canvas.drawOval(<span class="keyword">new</span> RectF(drawRect), outlinePaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMode</span><span class="params">(ModifyMode mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mode != modifyMode) &#123;</span><br><span class="line">            modifyMode = mode;</span><br><span class="line">            viewContext.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determines which edges are hit by touching at (x, y)</span></span><br><span class="line">  	<span class="comment">//在CropImageView的OnTouchEvent中，通过x，y判断是否有碰触到HighlightView</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHit</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">        Rect r = computeLayout();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> hysteresis = <span class="number">20F</span>;<span class="comment">//误差值，误差在这个范围内就算hit到了</span></span><br><span class="line">        <span class="keyword">int</span> retval = GROW_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// verticalCheck makes sure the position is between the top and</span></span><br><span class="line">        <span class="comment">// the bottom edge (with some tolerance). Similar for horizCheck.</span></span><br><span class="line">        <span class="keyword">boolean</span> verticalCheck = (y &gt;= r.top - hysteresis)</span><br><span class="line">                &amp;&amp; (y &lt; r.bottom + hysteresis);</span><br><span class="line">        <span class="keyword">boolean</span> horizCheck = (x &gt;= r.left - hysteresis)</span><br><span class="line">                &amp;&amp; (x &lt; r.right + hysteresis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check whether the position is near some edge(s)</span></span><br><span class="line">        <span class="keyword">if</span> ((Math.abs(r.left - x) &lt; hysteresis) &amp;&amp; verticalCheck) &#123;</span><br><span class="line">            retval |= GROW_LEFT_EDGE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((Math.abs(r.right - x) &lt; hysteresis) &amp;&amp; verticalCheck) &#123;</span><br><span class="line">            retval |= GROW_RIGHT_EDGE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((Math.abs(r.top - y) &lt; hysteresis) &amp;&amp; horizCheck) &#123;</span><br><span class="line">            retval |= GROW_TOP_EDGE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((Math.abs(r.bottom - y) &lt; hysteresis) &amp;&amp; horizCheck) &#123;</span><br><span class="line">            retval |= GROW_BOTTOM_EDGE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Not near any edge but inside the rectangle: move</span></span><br><span class="line">        <span class="keyword">if</span> (retval == GROW_NONE &amp;&amp; r.contains((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y)) &#123;</span><br><span class="line">            retval = MOVE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handles motion (dx, dy) in screen space.</span></span><br><span class="line">    <span class="comment">// The "edge" parameter specifies which edges the user is dragging.</span></span><br><span class="line">  	<span class="comment">//处理手势事件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleMotion</span><span class="params">(<span class="keyword">int</span> edge, <span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span> </span>&#123;</span><br><span class="line">        Rect r = computeLayout();</span><br><span class="line">      	<span class="comment">//如果触摸状态是MOVE的话，移动</span></span><br><span class="line">        <span class="keyword">if</span> (edge == MOVE) &#123;</span><br><span class="line">            <span class="comment">// Convert to image space before sending to moveBy()</span></span><br><span class="line">          	<span class="comment">//将坐标转换成相对于CropImageView的坐标</span></span><br><span class="line">            moveBy(dx * (cropRect.width() / r.width()),</span><br><span class="line">                    dy * (cropRect.height() / r.height()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">//不是触摸到左右边界，那么移动x方向为0</span></span><br><span class="line">            <span class="keyword">if</span> (((GROW_LEFT_EDGE | GROW_RIGHT_EDGE) &amp; edge) == <span class="number">0</span>) &#123;</span><br><span class="line">                dx = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//不是触摸到上下边界，那么移动y方向为0</span></span><br><span class="line">            <span class="keyword">if</span> (((GROW_TOP_EDGE | GROW_BOTTOM_EDGE) &amp; edge) == <span class="number">0</span>) &#123;</span><br><span class="line">                dy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Convert to image space before sending to growBy()</span></span><br><span class="line">            <span class="keyword">float</span> xDelta = dx * (cropRect.width() / r.width());</span><br><span class="line">            <span class="keyword">float</span> yDelta = dy * (cropRect.height() / r.height());</span><br><span class="line">          	<span class="comment">//放大缩小</span></span><br><span class="line">            growBy((((edge &amp; GROW_LEFT_EDGE) != <span class="number">0</span>) ? -<span class="number">1</span> : <span class="number">1</span>) * xDelta,</span><br><span class="line">                    (((edge &amp; GROW_TOP_EDGE) != <span class="number">0</span>) ? -<span class="number">1</span> : <span class="number">1</span>) * yDelta);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grows the cropping rectangle by (dx, dy) in image space</span></span><br><span class="line">  	<span class="comment">//cropRect移动dx，dy</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">moveBy</span><span class="params">(<span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span> </span>&#123;</span><br><span class="line">        Rect invalRect = <span class="keyword">new</span> Rect(drawRect);</span><br><span class="line"></span><br><span class="line">        cropRect.offset(dx, dy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Put the cropping rectangle inside image rectangle</span></span><br><span class="line">        cropRect.offset(</span><br><span class="line">                Math.max(<span class="number">0</span>, imageRect.left - cropRect.left),</span><br><span class="line">                Math.max(<span class="number">0</span>, imageRect.top - cropRect.top));</span><br><span class="line"></span><br><span class="line">        cropRect.offset(</span><br><span class="line">                Math.min(<span class="number">0</span>, imageRect.right - cropRect.right),</span><br><span class="line">                Math.min(<span class="number">0</span>, imageRect.bottom - cropRect.bottom));</span><br><span class="line"></span><br><span class="line">        drawRect = computeLayout();</span><br><span class="line">      	<span class="comment">//取并集</span></span><br><span class="line">        invalRect.union(drawRect);</span><br><span class="line">      	<span class="comment">//invalRect再缩小-handleRadius那么大</span></span><br><span class="line">        invalRect.inset(-(<span class="keyword">int</span>) handleRadius, -(<span class="keyword">int</span>) handleRadius);</span><br><span class="line">      	<span class="comment">//绘制</span></span><br><span class="line">        viewContext.invalidate(invalRect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grows the cropping rectangle by (dx, dy) in image space.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">growBy</span><span class="params">(<span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//如果要保持比例的话，重新计算dx或dy</span></span><br><span class="line">        <span class="keyword">if</span> (maintainAspectRatio) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dx != <span class="number">0</span>) &#123;</span><br><span class="line">                dy = dx / initialAspectRatio;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dy != <span class="number">0</span>) &#123;</span><br><span class="line">                dx = dy * initialAspectRatio;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don't let the cropping rectangle grow too fast.</span></span><br><span class="line">        <span class="comment">// Grow at most half of the difference between the image rectangle and</span></span><br><span class="line">        <span class="comment">// the cropping rectangle.</span></span><br><span class="line">        RectF r = <span class="keyword">new</span> RectF(cropRect);</span><br><span class="line">        <span class="keyword">if</span> (dx &gt; <span class="number">0F</span> &amp;&amp; r.width() + <span class="number">2</span> * dx &gt; imageRect.width()) &#123;</span><br><span class="line">            dx = (imageRect.width() - r.width()) / <span class="number">2F</span>;</span><br><span class="line">            <span class="keyword">if</span> (maintainAspectRatio) &#123;</span><br><span class="line">                dy = dx / initialAspectRatio;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dy &gt; <span class="number">0F</span> &amp;&amp; r.height() + <span class="number">2</span> * dy &gt; imageRect.height()) &#123;</span><br><span class="line">            dy = (imageRect.height() - r.height()) / <span class="number">2F</span>;</span><br><span class="line">            <span class="keyword">if</span> (maintainAspectRatio) &#123;</span><br><span class="line">                dx = dy * initialAspectRatio;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//左右缩小-dx，上下缩小-dy</span></span><br><span class="line">        r.inset(-dx, -dy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don't let the cropping rectangle shrink too fast</span></span><br><span class="line">      	<span class="comment">//不要收缩的太快</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> widthCap = <span class="number">25F</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.width() &lt; widthCap) &#123;</span><br><span class="line">            r.inset(-(widthCap - r.width()) / <span class="number">2F</span>, <span class="number">0F</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">float</span> heightCap = maintainAspectRatio</span><br><span class="line">                ? (widthCap / initialAspectRatio)</span><br><span class="line">                : widthCap;</span><br><span class="line">        <span class="keyword">if</span> (r.height() &lt; heightCap) &#123;</span><br><span class="line">            r.inset(<span class="number">0F</span>, -(heightCap - r.height()) / <span class="number">2F</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Put the cropping rectangle inside the image rectangle</span></span><br><span class="line">        <span class="keyword">if</span> (r.left &lt; imageRect.left) &#123;</span><br><span class="line">            r.offset(imageRect.left - r.left, <span class="number">0F</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.right &gt; imageRect.right) &#123;</span><br><span class="line">            r.offset(-(r.right - imageRect.right), <span class="number">0F</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.top &lt; imageRect.top) &#123;</span><br><span class="line">            r.offset(<span class="number">0F</span>, imageRect.top - r.top);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.bottom &gt; imageRect.bottom) &#123;</span><br><span class="line">            r.offset(<span class="number">0F</span>, -(r.bottom - imageRect.bottom));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cropRect.set(r);</span><br><span class="line">        drawRect = computeLayout();</span><br><span class="line">        viewContext.invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns the cropping rectangle in image space with specified scale</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Rect <span class="title">getScaledCropRect</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//得到传入参数放大后的的裁剪区域，scale一般传入的就是simpleSize</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Rect((<span class="keyword">int</span>) (cropRect.left * scale), (<span class="keyword">int</span>) (cropRect.top * scale),</span><br><span class="line">                (<span class="keyword">int</span>) (cropRect.right * scale), (<span class="keyword">int</span>) (cropRect.bottom * scale));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Maps the cropping rectangle from image space to screen space</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Rect <span class="title">computeLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RectF r = <span class="keyword">new</span> RectF(cropRect.left, cropRect.top,</span><br><span class="line">                cropRect.right, cropRect.bottom);</span><br><span class="line">        matrix.mapRect(r);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Rect(Math.round(r.left), Math.round(r.top),</span><br><span class="line">                Math.round(r.right), Math.round(r.bottom));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        drawRect = computeLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasFocus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isFocused;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFocus</span><span class="params">(<span class="keyword">boolean</span> isFocused)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isFocused = isFocused;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CropImageView"><a href="#CropImageView" class="headerlink" title="CropImageView"></a>CropImageView</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CropImageView</span> <span class="keyword">extends</span> <span class="title">ImageViewTouchBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;HighlightView&gt; highlightViews = <span class="keyword">new</span> ArrayList&lt;HighlightView&gt;();</span><br><span class="line">    HighlightView motionHighlightView;</span><br><span class="line">    Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> motionEdge;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> validPointerId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CropImageView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CropImageView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CropImageView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</span><br><span class="line">        <span class="keyword">if</span> (bitmapDisplayed.getBitmap() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (HighlightView hv : highlightViews) &#123;</span><br><span class="line">              	<span class="comment">//设置矩阵</span></span><br><span class="line">                hv.matrix.set(getUnrotatedMatrix());</span><br><span class="line">                hv.invalidate();</span><br><span class="line">                <span class="keyword">if</span> (hv.hasFocus()) &#123;</span><br><span class="line">                  	<span class="comment">//让HighlightView全部显示在屏幕上</span></span><br><span class="line">                    centerBasedOnHighlightView(hv);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomTo</span><span class="params">(<span class="keyword">float</span> scale, <span class="keyword">float</span> centerX, <span class="keyword">float</span> centerY)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//固定位置zoom</span></span><br><span class="line">        <span class="keyword">super</span>.zoomTo(scale, centerX, centerY);</span><br><span class="line">        <span class="keyword">for</span> (HighlightView hv : highlightViews) &#123;</span><br><span class="line">            hv.matrix.set(getUnrotatedMatrix());</span><br><span class="line">            hv.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomIn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//放大</span></span><br><span class="line">        <span class="keyword">super</span>.zoomIn();</span><br><span class="line">        <span class="keyword">for</span> (HighlightView hv : highlightViews) &#123;</span><br><span class="line">            hv.matrix.set(getUnrotatedMatrix());</span><br><span class="line">            hv.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//缩小</span></span><br><span class="line">        <span class="keyword">super</span>.zoomOut();</span><br><span class="line">        <span class="keyword">for</span> (HighlightView hv : highlightViews) &#123;</span><br><span class="line">            hv.matrix.set(getUnrotatedMatrix());</span><br><span class="line">            hv.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postTranslate</span><span class="params">(<span class="keyword">float</span> deltaX, <span class="keyword">float</span> deltaY)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//平移</span></span><br><span class="line">        <span class="keyword">super</span>.postTranslate(deltaX, deltaY);</span><br><span class="line">        <span class="keyword">for</span> (HighlightView hv : highlightViews) &#123;</span><br><span class="line">            hv.matrix.postTranslate(deltaX, deltaY);</span><br><span class="line">            hv.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(@NonNull MotionEvent event)</span> </span>&#123;</span><br><span class="line">        CropImageActivity cropImageActivity = (CropImageActivity) context;</span><br><span class="line">      	<span class="comment">//如果正在保存，则跳过</span></span><br><span class="line">        <span class="keyword">if</span> (cropImageActivity.isSaving()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            <span class="keyword">for</span> (HighlightView hv : highlightViews) &#123;</span><br><span class="line">              	<span class="comment">//判断触摸到了什么</span></span><br><span class="line">                <span class="keyword">int</span> edge = hv.getHit(event.getX(), event.getY());</span><br><span class="line">                <span class="keyword">if</span> (edge != HighlightView.GROW_NONE) &#123;</span><br><span class="line">                    motionEdge = edge;</span><br><span class="line">                    motionHighlightView = hv;</span><br><span class="line">                    lastX = event.getX();</span><br><span class="line">                    lastY = event.getY();</span><br><span class="line">                    <span class="comment">// Prevent multiple touches from interfering with crop area re-sizing</span></span><br><span class="line">                  	<span class="comment">//设置PointerId防止多指操作</span></span><br><span class="line">                    validPointerId = event.getPointerId(event.getActionIndex());</span><br><span class="line">                  	<span class="comment">//设置触摸状态</span></span><br><span class="line">                    motionHighlightView.setMode((edge == HighlightView.MOVE)</span><br><span class="line">                            ? HighlightView.ModifyMode.Move</span><br><span class="line">                            : HighlightView.ModifyMode.Grow);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="keyword">if</span> (motionHighlightView != <span class="keyword">null</span>) &#123;</span><br><span class="line">              	<span class="comment">//让HighlightView全部显示在屏幕上</span></span><br><span class="line">                centerBasedOnHighlightView(motionHighlightView);</span><br><span class="line">                motionHighlightView.setMode(HighlightView.ModifyMode.None);</span><br><span class="line">            &#125;</span><br><span class="line">            motionHighlightView = <span class="keyword">null</span>;</span><br><span class="line">            center();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            <span class="comment">//让HiglightView去处理手势</span></span><br><span class="line">            <span class="keyword">if</span> (motionHighlightView != <span class="keyword">null</span> &amp;&amp; event.getPointerId(event.getActionIndex()) == validPointerId) &#123;</span><br><span class="line">                motionHighlightView.handleMotion(motionEdge, event.getX()</span><br><span class="line">                        - lastX, event.getY() - lastY);</span><br><span class="line">                lastX = event.getX();</span><br><span class="line">                lastY = event.getY();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we're not zoomed then there's no point in even allowing the user to move the image around.</span></span><br><span class="line">            <span class="comment">// This call to center puts it back to the normalized location.</span></span><br><span class="line">            <span class="keyword">if</span> (getScale() == <span class="number">1F</span>) &#123;</span><br><span class="line">                center();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pan the displayed image to make sure the cropping rectangle is visible.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureVisible</span><span class="params">(HighlightView hv)</span> </span>&#123;</span><br><span class="line">        Rect r = hv.drawRect;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> panDeltaX1 = Math.max(<span class="number">0</span>, getLeft() - r.left);</span><br><span class="line">        <span class="keyword">int</span> panDeltaX2 = Math.min(<span class="number">0</span>, getRight() - r.right);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> panDeltaY1 = Math.max(<span class="number">0</span>, getTop() - r.top);</span><br><span class="line">        <span class="keyword">int</span> panDeltaY2 = Math.min(<span class="number">0</span>, getBottom() - r.bottom);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> panDeltaX = panDeltaX1 != <span class="number">0</span> ? panDeltaX1 : panDeltaX2;</span><br><span class="line">        <span class="keyword">int</span> panDeltaY = panDeltaY1 != <span class="number">0</span> ? panDeltaY1 : panDeltaY2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (panDeltaX != <span class="number">0</span> || panDeltaY != <span class="number">0</span>) &#123;</span><br><span class="line">            panBy(panDeltaX, panDeltaY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the cropping rectangle's size changed significantly, change the</span></span><br><span class="line">    <span class="comment">// view's center and scale according to the cropping rectangle.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">centerBasedOnHighlightView</span><span class="params">(HighlightView hv)</span> </span>&#123;</span><br><span class="line">        Rect drawRect = hv.drawRect;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> width = drawRect.width();</span><br><span class="line">        <span class="keyword">float</span> height = drawRect.height();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> thisWidth = getWidth();</span><br><span class="line">        <span class="keyword">float</span> thisHeight = getHeight();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> z1 = thisWidth / width * .<span class="number">6F</span>;</span><br><span class="line">        <span class="keyword">float</span> z2 = thisHeight / height * .<span class="number">6F</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> zoom = Math.min(z1, z2);</span><br><span class="line">        zoom = zoom * <span class="keyword">this</span>.getScale();</span><br><span class="line">        zoom = Math.max(<span class="number">1F</span>, zoom);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((Math.abs(zoom - getScale()) / zoom) &gt; .<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">float</span>[] coordinates = <span class="keyword">new</span> <span class="keyword">float</span>[] &#123; hv.cropRect.centerX(), hv.cropRect.centerY() &#125;;</span><br><span class="line">            getUnrotatedMatrix().mapPoints(coordinates);</span><br><span class="line">            zoomTo(zoom, coordinates[<span class="number">0</span>], coordinates[<span class="number">1</span>], <span class="number">300F</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ensureVisible(hv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(@NonNull Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">        <span class="keyword">for</span> (HighlightView highlightView : highlightViews) &#123;</span><br><span class="line">            highlightView.draw(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(HighlightView hv)</span> </span>&#123;</span><br><span class="line">        highlightViews.add(hv);</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ImageViewTouchBase"><a href="#ImageViewTouchBase" class="headerlink" title="ImageViewTouchBase"></a>ImageViewTouchBase</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTouchBase</span> <span class="keyword">extends</span> <span class="title">ImageView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> SCALE_RATE = <span class="number">1.25F</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the base transformation which is used to show the image</span></span><br><span class="line">    <span class="comment">// initially.  The current computation for this shows the image in</span></span><br><span class="line">    <span class="comment">// it's entirety, letterboxing as needed.  One could choose to</span></span><br><span class="line">    <span class="comment">// show the image as cropped instead.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This matrix is recomputed when we go from the thumbnail image to</span></span><br><span class="line">    <span class="comment">// the full size image.</span></span><br><span class="line">    <span class="keyword">protected</span> Matrix baseMatrix = <span class="keyword">new</span> Matrix();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the supplementary transformation which reflects what</span></span><br><span class="line">    <span class="comment">// the user has done in terms of zooming and panning.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This matrix remains the same when we go from the thumbnail image</span></span><br><span class="line">    <span class="comment">// to the full size image.</span></span><br><span class="line">    <span class="keyword">protected</span> Matrix suppMatrix = <span class="keyword">new</span> Matrix();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is the final matrix which is computed as the concatentation</span></span><br><span class="line">    <span class="comment">// of the base matrix and the supplementary matrix.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Matrix displayMatrix = <span class="keyword">new</span> Matrix();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Temporary buffer used for getting the values out of a matrix.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span>[] matrixValues = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The current bitmap being displayed.</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> RotateBitmap bitmapDisplayed = <span class="keyword">new</span> RotateBitmap(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> thisWidth = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> thisHeight = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> maxZoom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Runnable onLayoutRunnable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Handler handler = <span class="keyword">new</span> Handler();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ImageViewTouchBase will pass a Bitmap to the Recycler if it has finished</span></span><br><span class="line">    <span class="comment">// its use of that Bitmap</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Recycler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">(Bitmap b)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Recycler recycler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageViewTouchBase</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageViewTouchBase</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageViewTouchBase</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRecycler</span><span class="params">(Recycler recycler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.recycler = recycler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</span><br><span class="line">        thisWidth = right - left;</span><br><span class="line">        thisHeight = bottom - top;</span><br><span class="line">        Runnable r = onLayoutRunnable;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            onLayoutRunnable = <span class="keyword">null</span>;</span><br><span class="line">            r.run();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bitmapDisplayed.getBitmap() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            getProperBaseMatrix(bitmapDisplayed, baseMatrix, <span class="keyword">true</span>);</span><br><span class="line">            setImageMatrix(getImageViewMatrix());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; event.getRepeatCount() == <span class="number">0</span>) &#123;</span><br><span class="line">            event.startTracking();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onKeyDown(keyCode, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; event.isTracking() &amp;&amp; !event.isCanceled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getScale() &gt; <span class="number">1.0f</span>) &#123;</span><br><span class="line">                <span class="comment">// If we're zoomed in, pressing Back jumps out to show the</span></span><br><span class="line">                <span class="comment">// entire image, otherwise Back returns the user to the gallery</span></span><br><span class="line">                zoomTo(<span class="number">1.0f</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onKeyUp(keyCode, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">        setImageBitmap(bitmap, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//设置旋转的Bitmap</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap, <span class="keyword">int</span> rotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setImageBitmap(bitmap);</span><br><span class="line">        Drawable d = getDrawable();</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</span><br><span class="line">            d.setDither(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Bitmap old = bitmapDisplayed.getBitmap();</span><br><span class="line">        bitmapDisplayed.setBitmap(bitmap);</span><br><span class="line">        bitmapDisplayed.setRotation(rotation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old != bitmap &amp;&amp; recycler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            recycler.recycle(old);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//释放</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setImageBitmapResetBase(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function changes bitmap, reset base matrix according to the size</span></span><br><span class="line">    <span class="comment">// of the bitmap, and optionally reset the supplementary matrix</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImageBitmapResetBase</span><span class="params">(<span class="keyword">final</span> Bitmap bitmap, <span class="keyword">final</span> <span class="keyword">boolean</span> resetSupp)</span> </span>&#123;</span><br><span class="line">        setImageRotateBitmapResetBase(<span class="keyword">new</span> RotateBitmap(bitmap, <span class="number">0</span>), resetSupp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImageRotateBitmapResetBase</span><span class="params">(<span class="keyword">final</span> RotateBitmap bitmap, <span class="keyword">final</span> <span class="keyword">boolean</span> resetSupp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> viewWidth = getWidth();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (viewWidth &lt;= <span class="number">0</span>)  &#123;</span><br><span class="line">            onLayoutRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  	<span class="comment">//反复调用自己，知道得到view的宽度为止</span></span><br><span class="line">                    setImageRotateBitmapResetBase(bitmap, resetSupp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bitmap.getBitmap() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            getProperBaseMatrix(bitmap, baseMatrix, <span class="keyword">true</span>);</span><br><span class="line">            setImageBitmap(bitmap.getBitmap(), bitmap.getRotation());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            baseMatrix.reset();</span><br><span class="line">            setImageBitmap(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resetSupp) &#123;</span><br><span class="line">            suppMatrix.reset();</span><br><span class="line">        &#125;</span><br><span class="line">        setImageMatrix(getImageViewMatrix());</span><br><span class="line">        maxZoom = calculateMaxZoom();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Center as much as possible in one or both axis.  Centering is defined as follows:</span></span><br><span class="line">    <span class="comment">// * If the image is scaled down below the view's dimensions then center it.</span></span><br><span class="line">    <span class="comment">// * If the image is scaled larger than the view and is translated out of view then translate it back into view.</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">center</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Bitmap bitmap = bitmapDisplayed.getBitmap();</span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Matrix m = getImageViewMatrix();</span><br><span class="line"></span><br><span class="line">        RectF rect = <span class="keyword">new</span> RectF(<span class="number">0</span>, <span class="number">0</span>, bitmap.getWidth(), bitmap.getHeight());</span><br><span class="line">        m.mapRect(rect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> height = rect.height();</span><br><span class="line">        <span class="keyword">float</span> width  = rect.width();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> deltaX = <span class="number">0</span>, deltaY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        deltaY = centerVertical(rect, height, deltaY);</span><br><span class="line">        deltaX = centerHorizontal(rect, width, deltaX);</span><br><span class="line"></span><br><span class="line">        postTranslate(deltaX, deltaY);</span><br><span class="line">        setImageMatrix(getImageViewMatrix());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">centerVertical</span><span class="params">(RectF rect, <span class="keyword">float</span> height, <span class="keyword">float</span> deltaY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> viewHeight = getHeight();</span><br><span class="line">        <span class="keyword">if</span> (height &lt; viewHeight) &#123;</span><br><span class="line">            deltaY = (viewHeight - height) / <span class="number">2</span> - rect.top;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rect.top &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            deltaY = -rect.top;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rect.bottom &lt; viewHeight) &#123;</span><br><span class="line">            deltaY = getHeight() - rect.bottom;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> deltaY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">centerHorizontal</span><span class="params">(RectF rect, <span class="keyword">float</span> width, <span class="keyword">float</span> deltaX)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> viewWidth = getWidth();</span><br><span class="line">        <span class="keyword">if</span> (width &lt; viewWidth) &#123;</span><br><span class="line">            deltaX = (viewWidth - width) / <span class="number">2</span> - rect.left;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rect.left &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            deltaX = -rect.left;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rect.right &lt; viewWidth) &#123;</span><br><span class="line">            deltaX = viewWidth - rect.right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> deltaX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//初始化，设置ImageView的ScaleType</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setScaleType(ImageView.ScaleType.MATRIX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">float</span> <span class="title">getValue</span><span class="params">(Matrix matrix, <span class="keyword">int</span> whichValue)</span> </span>&#123;</span><br><span class="line">        matrix.getValues(matrixValues);</span><br><span class="line">        <span class="keyword">return</span> matrixValues[whichValue];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the scale factor out of the matrix.</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">float</span> <span class="title">getScale</span><span class="params">(Matrix matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getValue(matrix, Matrix.MSCALE_X);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">float</span> <span class="title">getScale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getScale(suppMatrix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup the base matrix so that the image is centered and scaled properly.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getProperBaseMatrix</span><span class="params">(RotateBitmap bitmap, Matrix matrix, <span class="keyword">boolean</span> includeRotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> viewWidth = getWidth();</span><br><span class="line">        <span class="keyword">float</span> viewHeight = getHeight();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> w = bitmap.getWidth();</span><br><span class="line">        <span class="keyword">float</span> h = bitmap.getHeight();</span><br><span class="line">        matrix.reset();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We limit up-scaling to 3x otherwise the result may look bad if it's a small icon</span></span><br><span class="line">        <span class="keyword">float</span> widthScale = Math.min(viewWidth / w, <span class="number">3.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> heightScale = Math.min(viewHeight / h, <span class="number">3.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> scale = Math.min(widthScale, heightScale);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (includeRotation) &#123;</span><br><span class="line">            matrix.postConcat(bitmap.getRotateMatrix());</span><br><span class="line">        &#125;</span><br><span class="line">        matrix.postScale(scale, scale);</span><br><span class="line">        matrix.postTranslate((viewWidth  - w * scale) / <span class="number">2F</span>, (viewHeight - h * scale) / <span class="number">2F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Combine the base matrix and the supp matrix to make the final matrix</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Matrix <span class="title">getImageViewMatrix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The final matrix is computed as the concatentation of the base matrix</span></span><br><span class="line">        <span class="comment">// and the supplementary matrix</span></span><br><span class="line">        displayMatrix.set(baseMatrix);</span><br><span class="line">        displayMatrix.postConcat(suppMatrix);</span><br><span class="line">        <span class="keyword">return</span> displayMatrix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Matrix <span class="title">getUnrotatedMatrix</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Matrix unrotated = <span class="keyword">new</span> Matrix();</span><br><span class="line">        getProperBaseMatrix(bitmapDisplayed, unrotated, <span class="keyword">false</span>);</span><br><span class="line">        unrotated.postConcat(suppMatrix);</span><br><span class="line">        <span class="keyword">return</span> unrotated;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">float</span> <span class="title">calculateMaxZoom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapDisplayed.getBitmap() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1F</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> fw = (<span class="keyword">float</span>) bitmapDisplayed.getWidth()  / (<span class="keyword">float</span>) thisWidth;</span><br><span class="line">        <span class="keyword">float</span> fh = (<span class="keyword">float</span>) bitmapDisplayed.getHeight() / (<span class="keyword">float</span>) thisHeight;</span><br><span class="line">        <span class="keyword">return</span> Math.max(fw, fh) * <span class="number">4</span>; <span class="comment">// 400%</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomTo</span><span class="params">(<span class="keyword">float</span> scale, <span class="keyword">float</span> centerX, <span class="keyword">float</span> centerY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (scale &gt; maxZoom) &#123;</span><br><span class="line">            scale = maxZoom;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> oldScale = getScale();</span><br><span class="line">        <span class="keyword">float</span> deltaScale = scale / oldScale;</span><br><span class="line"></span><br><span class="line">        suppMatrix.postScale(deltaScale, deltaScale, centerX, centerY);</span><br><span class="line">        setImageMatrix(getImageViewMatrix());</span><br><span class="line">        center();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomTo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">float</span> scale, <span class="keyword">final</span> <span class="keyword">float</span> centerX,</span><br><span class="line">                          <span class="keyword">final</span> <span class="keyword">float</span> centerY, <span class="keyword">final</span> <span class="keyword">float</span> durationMs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> incrementPerMs = (scale - getScale()) / durationMs;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> oldScale = getScale();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        handler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">float</span> currentMs = Math.min(durationMs, now - startTime);</span><br><span class="line">                <span class="keyword">float</span> target = oldScale + (incrementPerMs * currentMs);</span><br><span class="line">                zoomTo(target, centerX, centerY);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (currentMs &lt; durationMs) &#123;</span><br><span class="line">                    handler.post(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomTo</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> cx = getWidth() / <span class="number">2F</span>;</span><br><span class="line">        <span class="keyword">float</span> cy = getHeight() / <span class="number">2F</span>;</span><br><span class="line">        zoomTo(scale, cx, cy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomIn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        zoomIn(SCALE_RATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        zoomOut(SCALE_RATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomIn</span><span class="params">(<span class="keyword">float</span> rate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getScale() &gt;= maxZoom) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// Don't let the user zoom into the molecular level</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bitmapDisplayed.getBitmap() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> cx = getWidth() / <span class="number">2F</span>;</span><br><span class="line">        <span class="keyword">float</span> cy = getHeight() / <span class="number">2F</span>;</span><br><span class="line"></span><br><span class="line">        suppMatrix.postScale(rate, rate, cx, cy);</span><br><span class="line">        setImageMatrix(getImageViewMatrix());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">zoomOut</span><span class="params">(<span class="keyword">float</span> rate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapDisplayed.getBitmap() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> cx = getWidth() / <span class="number">2F</span>;</span><br><span class="line">        <span class="keyword">float</span> cy = getHeight() / <span class="number">2F</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zoom out to at most 1x</span></span><br><span class="line">        Matrix tmp = <span class="keyword">new</span> Matrix(suppMatrix);</span><br><span class="line">        tmp.postScale(<span class="number">1F</span> / rate, <span class="number">1F</span> / rate, cx, cy);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getScale(tmp) &lt; <span class="number">1F</span>) &#123;</span><br><span class="line">            suppMatrix.setScale(<span class="number">1F</span>, <span class="number">1F</span>, cx, cy);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            suppMatrix.postScale(<span class="number">1F</span> / rate, <span class="number">1F</span> / rate, cx, cy);</span><br><span class="line">        &#125;</span><br><span class="line">        setImageMatrix(getImageViewMatrix());</span><br><span class="line">        center();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postTranslate</span><span class="params">(<span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span> </span>&#123;</span><br><span class="line">        suppMatrix.postTranslate(dx, dy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">panBy</span><span class="params">(<span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span> </span>&#123;</span><br><span class="line">        postTranslate(dx, dy);</span><br><span class="line">        setImageMatrix(getImageViewMatrix());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>项目中裁剪的核心是 <code>BitmapRegionDecoder</code> ，还要许多可取之处，比如计算 <code>simpleSize</code> 的方法、得到 View 的宽度的方法等。</p>
<p>BitmapRegionDecoder 类用来编译(解码)在图片内不同的方形区域，BitmapRegionDecoder 类在使用较大图片只需要取得图片中的一小部分的内容是特别有效益的。我们创建一个 BitmapRegionDecoder 类，并调用 newInstance() 方法，就可以得到 BitmapRegionDecoder 的对象之后，我们就能调用 decodeRegion() 方法去多次获得位图的特定地区的小图片。</p>

  	</div>
	  
	  <div class="article-tags tags">
      
        <a href="/tags/Android图像处理/">Android图像处理</a>
      
        <a href="/tags/源码/">源码</a>
      
	  </div>
    
	</section>
	
</article>
<script>
	window.subData = {
		title: 'android-crop源码解析',
		tools: true
	}
</script>


    
      <div class="duoshuo" id="comments">
    <div id="container"></div>
	<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
	<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
	<script>
		var gitment = new Gitment({
		  id: 'location.href', // 可选。默认为 location.href
		  owner: 'yydcdut',
		  repo: 'yydcdut.github.io',
		  oauth: {
		    client_id: '7d4abafc7b38309d4fd1',
		    client_secret: 'be5f0be53b45a0de3440ebfde91bb0eb37cc430f',
		  },
		})
		gitment.render('container')
	</script>
</div>

    


      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>

<img class='avatar waves-image' src='/img/as.gif' />

<div class='header'>yydcdut</div>
<div class='content'>
<div class='desc'> (ง •̀_•́)ง </div>
</div>
</section>


  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="https://github.com/yydcdut">
            <div class='name'>Github</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://weibo.com/yydcdut">
            <div class='name'>Weibo</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="mailto:yydcdut@qq.com">
            <div class='name'>Email</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://stackoverflow.com/users/4364595/yydcdut">
            <div class='name'>StackOverflow</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/Android/"><div class='name'>Android</div><div class='badget'>20</div></a></li>
    
        <li><a class="flat-box" href="/categories/Gradle/"><div class='name'>Gradle</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/Java/"><div class='name'>Java</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/扯蛋/"><div class='name'>扯蛋</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/读书笔记/"><div class='name'>读书笔记</div><div class='badget'>1</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/Android图像处理/" style="font-size: 14px; color: #808080">Android图像处理</a> <a href="/tags/AsyncTask/" style="font-size: 14px; color: #808080">AsyncTask</a> <a href="/tags/Dex/" style="font-size: 16px; color: #555">Dex</a> <a href="/tags/ElasticScrollView/" style="font-size: 14px; color: #808080">ElasticScrollView</a> <a href="/tags/EventBus/" style="font-size: 14px; color: #808080">EventBus</a> <a href="/tags/ExplosionField/" style="font-size: 14px; color: #808080">ExplosionField</a> <a href="/tags/Gradle/" style="font-size: 16px; color: #555">Gradle</a> <a href="/tags/ListView/" style="font-size: 16px; color: #555">ListView</a> <a href="/tags/SwipeBack/" style="font-size: 14px; color: #808080">SwipeBack</a> <a href="/tags/TextView/" style="font-size: 14px; color: #808080">TextView</a> <a href="/tags/UI/" style="font-size: 14px; color: #808080">UI</a> <a href="/tags/Volley/" style="font-size: 14px; color: #808080">Volley</a> <a href="/tags/drag/" style="font-size: 14px; color: #808080">drag</a> <a href="/tags/support-v4/" style="font-size: 16px; color: #555">support-v4</a> <a href="/tags/传感器/" style="font-size: 14px; color: #808080">传感器</a> <a href="/tags/动画/" style="font-size: 14px; color: #808080">动画</a> <a href="/tags/扯蛋/" style="font-size: 14px; color: #808080">扯蛋</a> <a href="/tags/权限/" style="font-size: 14px; color: #808080">权限</a> <a href="/tags/流程/" style="font-size: 14px; color: #808080">流程</a> <a href="/tags/源码/" style="font-size: 20px; color: #000">源码</a> <a href="/tags/粒子爆炸/" style="font-size: 14px; color: #808080">粒子爆炸</a> <a href="/tags/自定义控件/" style="font-size: 18px; color: #2b2b2b">自定义控件</a> <a href="/tags/读书笔记/" style="font-size: 14px; color: #808080">读书笔记</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  
    <script type="text/javascript" src="/live2d/script.js"></script>
    <canvas id="live2dcanvas" width="150" height="300" class="live2d"></canvas>
    <style>
      #live2dcanvas {
        position: fixed;
        z-index: 999;
        pointer-events: none;
        bottom: -40px;
      }
    </style>
    <script>loadlive2d("live2dcanvas" ,"/live2d/assets/shizuku/shizuku.model.json")</script>
  
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/yydcdut" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="http://weibo.com/yydcdut" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
        <a href="mailto:yydcdut@qq.com" class="social mail"
          target="_blank" rel="external">
          <span class="icon icon-mail"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
    
  </div>
  
  <div>Theme <a href='https://github.com/stkevintan/hexo-theme-material-flow' class="codename">MaterialFlow</a> designed by <a href="http://keyin.me/" target="_blank">Kevin Tan</a>.</div>
  
</footer>


  <script>setLoadingBarProgress(80);</script>
  

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js" type="text/javascript"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js" type="text/javascript"></script>
<script src="/js/app.js" type="text/javascript"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
