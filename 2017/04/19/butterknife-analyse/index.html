<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ButterKnife源码简析 · Android杂文 - yydcdut</title><meta name="description" content="ButterKnife源码简析 - yydcdut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yydcdut.com/atom.xml" title="Android杂文 - yydcdut"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut/yydcdut.github.io/issues" target="_blank" class="nav-list-link">COMMENT</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ButterKnife源码简析</h1><div class="post-info">2017年4月19日</div><div class="post-content"><blockquote>
<p>Github: <a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="external">butterknife</a>      分析版本：<a href="https://github.com/JakeWharton/butterknife/tree/fc10f1674a08162ad7cf8c762c11a748c20c25d8" target="_blank" rel="external">fc10f16</a></p>
</blockquote>
<p>ButterKnife 是一个 Android 视图快速注入库，它通过给 View 字段添加注解，可以让我们丢掉 findViewById() 来获取 View 的方法，从而简化了代码。</p>
<a id="more"></a>
<h2 id="编译时注解"><a href="#编译时注解" class="headerlink" title="编译时注解"></a>编译时注解</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>编译时注解的核心依赖 APT ( Annotation Processing Tools ) 实现，原理是在某些代码元素上（如类型、函数、字段等）添加注解，在编译时编译器会检查 AbstractProcessor 的子类，并且调用该类型的 process 函数，然后将添加了注解的所有元素都传递到 process 函数中，使得开发人员可以在编译器进行相应的处理，例如，根据注解生成新的Java类，这也就是EventBus，Retrofit，Dragger等开源库的基本原理。 </p>
<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><h4 id="创建一个-Java-Library"><a href="#创建一个-Java-Library" class="headerlink" title="创建一个 Java Library"></a>创建一个 Java Library</h4><p>创建一个 annotationcompiler 的 java module</p>
<h4 id="配置-gradle"><a href="#配置-gradle" class="headerlink" title="配置 gradle"></a>配置 gradle</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sourceCompatibility = <span class="string">"1.7"</span></span><br><span class="line">targetCompatibility = <span class="string">"1.7"</span></span><br></pre></td></tr></table></figure>
<p>同时需要在 app 的 module 中配置一下 Java7</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compileOptions &#123;</span><br><span class="line">   sourceCompatibility JavaVersion.VERSION_1_7</span><br><span class="line">   targetCompatibility JavaVersion.VERSION_1_7</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建-Annotation"><a href="#创建-Annotation" class="headerlink" title="创建 Annotation"></a>创建 Annotation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yydcdut.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> InjectView &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建-AbstractProcessor"><a href="#创建-AbstractProcessor" class="headerlink" title="创建 AbstractProcessor"></a>创建 AbstractProcessor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yydcdut.process;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@SupportedAnnotationTypes</span>(<span class="string">"com.yydcdut.annotation.InjectView"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewInjectProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 初始化</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> processingEnvironment 提供了一些实用的工具类Elements, Types和Filer</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 指定使用的java版本</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 指定哪些注解应该被注解处理器注册</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getSupportedAnnotationTypes();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 主要的逻辑处理</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> set</span><br><span class="line">     * <span class="doctag">@param</span> env</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="注册处理器"><a href="#注册处理器" class="headerlink" title="注册处理器"></a>注册处理器</h4><p>在 java module 里的 main 目录中创建一个 <code>resources</code> 文件夹，然后下边在创建 <code>META-INF/services</code>，创建一个 <code>javax.annotation.processing.Processor</code> 文件，在此文件中写入注解处理器的类全称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.yydcdut.process.ViewInjectProcessor</span><br></pre></td></tr></table></figure>
<h4 id="添加-android-apt"><a href="#添加-android-apt" class="headerlink" title="添加 android-apt"></a>添加 android-apt</h4><p>在 project 下的 build.gradle 中添加 apt 插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></span><br></pre></td></tr></table></figure>
<p>然后在 app 中的 build.gradle 添加 apt 插件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.application'</span></span><br><span class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></span><br></pre></td></tr></table></figure>
<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在 app 中的 build.gradle 添加依赖</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile project(<span class="string">':annotationcompiler'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@SupportedAnnotationTypes</span>(<span class="string">"com.yydcdut.annotation.InjectView"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewInjectProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; types = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</span><br><span class="line">        types.add(InjectView.class.getCanonicalName());</span><br><span class="line">        <span class="keyword">return</span> types;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        generateCode(set, env);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder()</span><br><span class="line">                .append(<span class="string">"package com.yydcdut.test.generated;\n\n"</span>)</span><br><span class="line">                .append(<span class="string">"public class GeneratedClass &#123;\n\n"</span>) <span class="comment">// open class</span></span><br><span class="line">                .append(<span class="string">"\tpublic String getMessage() &#123;\n"</span>) <span class="comment">// open method</span></span><br><span class="line">                .append(<span class="string">"\t\treturn \""</span>);</span><br><span class="line">        <span class="comment">// for each javax.lang.model.element.Element annotated with the CustomAnnotation</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : roundEnv.getElementsAnnotatedWith(InjectView.class)) &#123;</span><br><span class="line">            <span class="keyword">int</span> id = element.getAnnotation(InjectView.class).value();</span><br><span class="line">            builder.append(id + <span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        builder.append(<span class="string">"\";\n"</span>) <span class="comment">// end return</span></span><br><span class="line">                .append(<span class="string">"\t&#125;\n"</span>) <span class="comment">// close method</span></span><br><span class="line">                .append(<span class="string">"&#125;\n"</span>); <span class="comment">// close class</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123; <span class="comment">// write the file</span></span><br><span class="line">            JavaFileObject source = processingEnv.getFiler().createSourceFile(<span class="string">"com.yydcdut.test.generated.GeneratedClass"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Writer writer = source.openWriter();</span><br><span class="line">            writer.write(builder.toString());</span><br><span class="line">            writer.flush();</span><br><span class="line">            writer.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// Note: calling e.printStackTrace() will print IO errors</span></span><br><span class="line">            <span class="comment">// that occur from the file already existing after its first run, this is normal</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被注解的部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yydcdut.textdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@InjectView</span>(value = <span class="number">123</span>)</span><br><span class="line">    <span class="keyword">private</span> EditText mEditText;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译之后查看 <code>app/build/generated/source/apt/debug/com/yydcdut/test/generated/GeneratedClass.java</code></p>
<p><img src="http://yydcdut.github.io/img/GeneratedClass.png" alt="GeneratedClass"></p>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="ButterKnifeProcessor"><a href="#ButterKnifeProcessor" class="headerlink" title="ButterKnifeProcessor"></a>ButterKnifeProcessor</h3><p>这里只分析 <code>BindView</code> 的过程</p>
<h4 id="ButterKnifeProcessor-1"><a href="#ButterKnifeProcessor-1" class="headerlink" title="ButterKnifeProcessor"></a>ButterKnifeProcessor</h4><p>根据上述创建注解器的流程，那么我们分析源码也有了一个流程，就直接看 ButterKnife 的 AbstractProcessor ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@AutoService</span>(Processor.class)<span class="comment">//自动注册处理器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Annotation&gt;&gt; LISTENERS = Arrays.asList(<span class="comment">//</span></span><br><span class="line">            OnCheckedChanged.class, <span class="comment">//</span></span><br><span class="line">            OnClick.class, <span class="comment">//</span></span><br><span class="line">            OnEditorAction.class, <span class="comment">//</span></span><br><span class="line">            OnFocusChange.class, <span class="comment">//</span></span><br><span class="line">            OnItemClick.class, <span class="comment">//</span></span><br><span class="line">            OnItemLongClick.class, <span class="comment">//</span></span><br><span class="line">            OnItemSelected.class, <span class="comment">//</span></span><br><span class="line">            OnLongClick.class, <span class="comment">//</span></span><br><span class="line">            OnPageChange.class, <span class="comment">//</span></span><br><span class="line">            OnTextChanged.class, <span class="comment">//</span></span><br><span class="line">            OnTouch.class <span class="comment">//</span></span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Elements elementUtils;<span class="comment">//处理Element的工具类</span></span><br><span class="line">    <span class="keyword">private</span> Types typeUtils;<span class="comment">//处理TypeMirror的工具类</span></span><br><span class="line">    <span class="keyword">private</span> Filer filer;<span class="comment">//可以创建.java文件</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment env)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(env);</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        elementUtils = env.getElementUtils();</span><br><span class="line">        typeUtils = env.getTypeUtils();</span><br><span class="line">        filer = env.getFiler();</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; types = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</span><br><span class="line">            types.add(annotation.getCanonicalName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> types;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; getSupportedAnnotations() &#123;</span><br><span class="line">        Set&lt;Class&lt;? extends Annotation&gt;&gt; annotations = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        annotations.add(BindArray.class);</span><br><span class="line">        annotations.add(BindBitmap.class);</span><br><span class="line">        annotations.add(BindBool.class);</span><br><span class="line">        annotations.add(BindColor.class);</span><br><span class="line">        annotations.add(BindDimen.class);</span><br><span class="line">        annotations.add(BindDrawable.class);</span><br><span class="line">        annotations.add(BindFloat.class);</span><br><span class="line">        annotations.add(BindInt.class);</span><br><span class="line">        annotations.add(BindString.class);</span><br><span class="line">        annotations.add(BindView.class);</span><br><span class="line">        annotations.add(BindViews.class);</span><br><span class="line">        annotations.addAll(LISTENERS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> annotations;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);<span class="comment">////查找所有的被注解，封装成BindingSet保存到map中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历步map的生成.java文件</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</span><br><span class="line">            TypeElement typeElement = entry.getKey();</span><br><span class="line">            BindingSet binding = entry.getValue();</span><br><span class="line"></span><br><span class="line">            JavaFile javaFile = binding.brewJava(sdk);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                javaFile.writeTo(filer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>process</code> 中主要做了两件事，第一是找出被注解的元素，封装成 <code>Map&lt;TypeElement, BindingSet&gt;</code> ，第一个参数可以想成类，第二个参数可以想成所有有关信息的封装；第二就是遍历这个 map ，然后针对每个类生成对应的 ViewBinder 类。</p>
<h4 id="ButterKnifeProcessor-findAndParseTargets"><a href="#ButterKnifeProcessor-findAndParseTargets" class="headerlink" title="ButterKnifeProcessor#findAndParseTargets"></a>ButterKnifeProcessor#findAndParseTargets</h4><p>那么主要的查找工作在 <code>findAndParseTargets()</code> 中进行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; findAndParseTargets(RoundEnvironment env) &#123;</span><br><span class="line">        Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">        <span class="comment">// .......</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// Process each @BindView element.</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;<span class="comment">//拿到被BindView注解的元素</span></span><br><span class="line">            <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></span><br><span class="line">            <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                parseBindView(element, builderMap, erasedTargetNames);<span class="comment">//解析</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logParsingError(element, BindView.class, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// .......</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> bindingMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RoundEnvironment</code> 可以理解成查询注解信息的类，而 <code>Element</code> 可以理解成程序中的元素，比如包、类、方法等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassA</span> </span>&#123; <span class="comment">// TypeElement</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> var; <span class="comment">// VariableElement</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassA</span><span class="params">()</span> </span>&#123;<span class="comment">// ExecuteableElement</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(<span class="keyword">int</span> newA // TypeElement</span><br><span class="line">    )</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TypeElement 代表源代码中元素类型，但是 TypeElement 并不包含类的相关信息，可以从 TypeElement 获取类的名称，但不能获取类的信息，比如说父类。这些信息可以通过 TypeMirror 获取。你可以通过调用 <code>element.asType()</code> 来获取一个 Element 的 TypeMirror 。</p>
<h4 id="ButterKnifeProcessor-parseBindView"><a href="#ButterKnifeProcessor-parseBindView" class="headerlink" title="ButterKnifeProcessor#parseBindView"></a>ButterKnifeProcessor#parseBindView</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, Set&lt;TypeElement&gt; erasedTargetNames)</span> </span>&#123;</span><br><span class="line">        TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();<span class="comment">//类 com.yydcdut.textdemo.MainActivity</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start by verifying common generated code restrictions.</span></span><br><span class="line">        <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</span><br><span class="line">                || isBindingInWrongPackage(BindView.class, element);<span class="comment">//检查合法性</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify that the target type extends from View.</span></span><br><span class="line">        TypeMirror elementType = element.asType();<span class="comment">//android.widget.EditText</span></span><br><span class="line">        <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;<span class="comment">//false (elementType.getKind()==DECLARED)</span></span><br><span class="line">            TypeVariable typeVariable = (TypeVariable) elementType;</span><br><span class="line">            elementType = typeVariable.getUpperBound();</span><br><span class="line">        &#125;</span><br><span class="line">        Name qualifiedName = enclosingElement.getQualifiedName();<span class="comment">//com.yydcdut.textdemo.MainActivity</span></span><br><span class="line">        Name simpleName = element.getSimpleName();<span class="comment">//mEditText</span></span><br><span class="line">        <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;<span class="comment">//必须为view类型的子类或者是接口</span></span><br><span class="line">            <span class="keyword">if</span> (elementType.getKind() == TypeKind.ERROR) &#123;</span><br><span class="line">                note(element, <span class="string">"@%s field with unresolved type (%s) "</span></span><br><span class="line">                                + <span class="string">"must elsewhere be generated as a View or interface. (%s.%s)"</span>, BindView.class.getSimpleName(), elementType, qualifiedName, simpleName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                error(element, <span class="string">"@%s fields must extend from View or be an interface. (%s.%s)"</span>, BindView.class.getSimpleName(), qualifiedName, simpleName);</span><br><span class="line">                hasError = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assemble information on the field.</span></span><br><span class="line">        <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();<span class="comment">//得到id</span></span><br><span class="line"></span><br><span class="line">        BindingSet.Builder builder = builderMap.get(enclosingElement);</span><br><span class="line">        QualifiedId qualifiedId = elementToQualifiedId(element, id);<span class="comment">//封装成QualifiedId</span></span><br><span class="line">        <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String existingBindingName = builder.findExistingBindingName(getId(qualifiedId));</span><br><span class="line">            <span class="keyword">if</span> (existingBindingName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>, BindView.class.getSimpleName(), id, existingBindingName, enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder = getOrCreateBindingBuilder(builderMap, enclosingElement);<span class="comment">//为这个类创建BindingSet.Builder</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String name = simpleName.toString();<span class="comment">//mEditText</span></span><br><span class="line">        TypeName type = TypeName.get(elementType);<span class="comment">//android.widget.EditText</span></span><br><span class="line">        <span class="keyword">boolean</span> required = isFieldRequired(element);</span><br><span class="line"></span><br><span class="line">        builder.addField(getId(qualifiedId), <span class="keyword">new</span> FieldViewBinding(name, type, required));<span class="comment">//封装后放入builder中</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the type-erased version to the valid binding targets set.</span></span><br><span class="line">        erasedTargetNames.add(enclosingElement);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 判断修饰符等</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> annotationClass</span><br><span class="line">     * <span class="doctag">@param</span> targetThing</span><br><span class="line">     * <span class="doctag">@param</span> element</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInaccessibleViaGeneratedCode</span><span class="params">(Class&lt;? extends Annotation&gt; annotationClass, String targetThing, Element element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasError = <span class="keyword">false</span>;</span><br><span class="line">        TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify method modifiers.</span></span><br><span class="line">        Set&lt;Modifier&gt; modifiers = element.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> (modifiers.contains(PRIVATE) || modifiers.contains(STATIC)) &#123;<span class="comment">//不能是private或者static的</span></span><br><span class="line">            error(element, <span class="string">"@%s %s must not be private or static. (%s.%s)"</span>, annotationClass.getSimpleName(), targetThing, enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">            hasError = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify containing type.</span></span><br><span class="line">        <span class="keyword">if</span> (enclosingElement.getKind() != CLASS) &#123;<span class="comment">//不能是class</span></span><br><span class="line">            error(enclosingElement, <span class="string">"@%s %s may only be contained in classes. (%s.%s)"</span>, annotationClass.getSimpleName(), targetThing, enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">            hasError = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify containing class visibility is not private.</span></span><br><span class="line">        <span class="keyword">if</span> (enclosingElement.getModifiers().contains(PRIVATE)) &#123;<span class="comment">//不能是private</span></span><br><span class="line">            error(enclosingElement, <span class="string">"@%s %s may not be contained in private classes. (%s.%s)"</span>, annotationClass.getSimpleName(), targetThing, enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">            hasError = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hasError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 判断是否弄错了包名</span><br><span class="line">     * 弄成android或者java的</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> annotationClass</span><br><span class="line">     * <span class="doctag">@param</span> element</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBindingInWrongPackage</span><span class="params">(Class&lt;? extends Annotation&gt; annotationClass, Element element)</span> </span>&#123;</span><br><span class="line">        TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line">        String qualifiedName = enclosingElement.getQualifiedName().toString();<span class="comment">//com.yydcdut.textdemo.MainActivity</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (qualifiedName.startsWith(<span class="string">"android."</span>)) &#123;</span><br><span class="line">            error(element, <span class="string">"@%s-annotated class incorrectly in Android framework package. (%s)"</span>,</span><br><span class="line">                    annotationClass.getSimpleName(), qualifiedName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (qualifiedName.startsWith(<span class="string">"java."</span>)) &#123;</span><br><span class="line">            error(element, <span class="string">"@%s-annotated class incorrectly in Java framework package. (%s)"</span>,</span><br><span class="line">                    annotationClass.getSimpleName(), qualifiedName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 是不是otherType的子类型</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> typeMirror</span><br><span class="line">     * <span class="doctag">@param</span> otherType</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSubtypeOfType</span><span class="params">(TypeMirror typeMirror, String otherType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isTypeEqual(typeMirror, otherType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (typeMirror.getKind() != TypeKind.DECLARED) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DeclaredType declaredType = (DeclaredType) typeMirror;</span><br><span class="line">        List&lt;? extends TypeMirror&gt; typeArguments = declaredType.getTypeArguments();</span><br><span class="line">        <span class="keyword">if</span> (typeArguments.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder typeString = <span class="keyword">new</span> StringBuilder(declaredType.asElement().toString());</span><br><span class="line">            typeString.append(<span class="string">'&lt;'</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; typeArguments.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    typeString.append(<span class="string">','</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                typeString.append(<span class="string">'?'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            typeString.append(<span class="string">'&gt;'</span>);</span><br><span class="line">            <span class="keyword">if</span> (typeString.toString().equals(otherType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Element element = declaredType.asElement();</span><br><span class="line">        <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> TypeElement)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TypeElement typeElement = (TypeElement) element;</span><br><span class="line">        TypeMirror superType = typeElement.getSuperclass();</span><br><span class="line">        <span class="keyword">if</span> (isSubtypeOfType(superType, otherType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (TypeMirror interfaceType : typeElement.getInterfaces()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSubtypeOfType(interfaceType, otherType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 是不是接口</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> typeMirror</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInterface</span><span class="params">(TypeMirror typeMirror)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> typeMirror <span class="keyword">instanceof</span> DeclaredType</span><br><span class="line">                &amp;&amp; ((DeclaredType) typeMirror).asElement().getKind() == INTERFACE;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> QualifiedId <span class="title">elementToQualifiedId</span><span class="params">(Element element, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QualifiedId(elementUtils.getPackageOf(element).getQualifiedName().toString(), id);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 判断有没有被Nullable修饰</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> element</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isFieldRequired</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !hasAnnotationWithName(element, NULLABLE_ANNOTATION_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BindingSet.<span class="function">Builder <span class="title">getOrCreateBindingBuilder</span><span class="params">(</span><br><span class="line">            Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, TypeElement enclosingElement)</span> </span>&#123;</span><br><span class="line">        BindingSet.Builder builder = builderMap.get(enclosingElement);</span><br><span class="line">        <span class="keyword">if</span> (builder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            builder = BindingSet.newBuilder(enclosingElement);</span><br><span class="line">            builderMap.put(enclosingElement, builder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是解析被 <code>BindView</code> 修饰的元素，将信息都封装成 <code>BindingSet.Builder</code> 。</p>
<h4 id="BindingSet-newBuilder"><a href="#BindingSet-newBuilder" class="headerlink" title="BindingSet#newBuilder"></a>BindingSet#newBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BindingSet</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeName targetTypeName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassName bindingClassName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isFinal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isView;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isActivity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isDialog;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImmutableList&lt;ViewBinding&gt; viewBindings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImmutableList&lt;FieldCollectionViewBinding&gt; collectionBindings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImmutableList&lt;ResourceBinding&gt; resourceBindings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BindingSet parentBinding;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BindingSet</span><span class="params">(TypeName targetTypeName, ClassName bindingClassName, <span class="keyword">boolean</span> isFinal,</span><br><span class="line">                       <span class="keyword">boolean</span> isView, <span class="keyword">boolean</span> isActivity, <span class="keyword">boolean</span> isDialog, ImmutableList&lt;ViewBinding&gt; viewBindings,</span><br><span class="line">                       ImmutableList&lt;FieldCollectionViewBinding&gt; collectionBindings,</span><br><span class="line">                       ImmutableList&lt;ResourceBinding&gt; resourceBindings, BindingSet parentBinding)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isFinal = isFinal;</span><br><span class="line">        <span class="keyword">this</span>.targetTypeName = targetTypeName;</span><br><span class="line">        <span class="keyword">this</span>.bindingClassName = bindingClassName;</span><br><span class="line">        <span class="keyword">this</span>.isView = isView;</span><br><span class="line">        <span class="keyword">this</span>.isActivity = isActivity;</span><br><span class="line">        <span class="keyword">this</span>.isDialog = isDialog;</span><br><span class="line">        <span class="keyword">this</span>.viewBindings = viewBindings;</span><br><span class="line">        <span class="keyword">this</span>.collectionBindings = collectionBindings;</span><br><span class="line">        <span class="keyword">this</span>.resourceBindings = resourceBindings;</span><br><span class="line">        <span class="keyword">this</span>.parentBinding = parentBinding;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Builder <span class="title">newBuilder</span><span class="params">(TypeElement enclosingElement)</span> </span>&#123;</span><br><span class="line">        TypeMirror typeMirror = enclosingElement.asType();<span class="comment">//android.widget.EditText</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isView = isSubtypeOfType(typeMirror, VIEW_TYPE);<span class="comment">//是不是View</span></span><br><span class="line">        <span class="keyword">boolean</span> isActivity = isSubtypeOfType(typeMirror, ACTIVITY_TYPE);<span class="comment">//是不是Activity</span></span><br><span class="line">        <span class="keyword">boolean</span> isDialog = isSubtypeOfType(typeMirror, DIALOG_TYPE);<span class="comment">//是不是Dialog</span></span><br><span class="line"></span><br><span class="line">        TypeName targetType = TypeName.get(typeMirror);</span><br><span class="line">        <span class="keyword">if</span> (targetType <span class="keyword">instanceof</span> ParameterizedTypeName) &#123;</span><br><span class="line">            targetType = ((ParameterizedTypeName) targetType).rawType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String packageName = getPackage(enclosingElement).getQualifiedName().toString();<span class="comment">//com.yydcdut.textdemo</span></span><br><span class="line">        String className = enclosingElement.getQualifiedName().toString().substring(</span><br><span class="line">                packageName.length() + <span class="number">1</span>).replace(<span class="string">'.'</span>, <span class="string">'$'</span>);<span class="comment">//MainActivity</span></span><br><span class="line">        ClassName bindingClassName = ClassName.get(packageName, className + <span class="string">"_ViewBinding"</span>);<span class="comment">//com.yydcdut.textdemo.MainActivity_ViewBinding</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isFinal = enclosingElement.getModifiers().contains(Modifier.FINAL);<span class="comment">//是不是final修饰的</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Builder(targetType, bindingClassName, isFinal, isView, isActivity, isDialog);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TypeName targetTypeName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ClassName bindingClassName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isFinal;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isView;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isActivity;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isDialog;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Id, ViewBinding.Builder&gt; viewIdMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(TypeName targetTypeName, ClassName bindingClassName, <span class="keyword">boolean</span> isFinal,</span><br><span class="line">                        <span class="keyword">boolean</span> isView, <span class="keyword">boolean</span> isActivity, <span class="keyword">boolean</span> isDialog)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.targetTypeName = targetTypeName;</span><br><span class="line">            <span class="keyword">this</span>.bindingClassName = bindingClassName;</span><br><span class="line">            <span class="keyword">this</span>.isFinal = isFinal;</span><br><span class="line">            <span class="keyword">this</span>.isView = isView;</span><br><span class="line">            <span class="keyword">this</span>.isActivity = isActivity;</span><br><span class="line">            <span class="keyword">this</span>.isDialog = isDialog;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addField</span><span class="params">(Id id, FieldViewBinding binding)</span> </span>&#123;</span><br><span class="line">            getOrCreateViewBindings(id).setFieldBinding(binding);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">private</span> ViewBinding.<span class="function">Builder <span class="title">getOrCreateViewBindings</span><span class="params">(Id id)</span> </span>&#123;</span><br><span class="line">            ViewBinding.Builder viewId = viewIdMap.get(id);</span><br><span class="line">            <span class="keyword">if</span> (viewId == <span class="keyword">null</span>) &#123;</span><br><span class="line">                viewId = <span class="keyword">new</span> ViewBinding.Builder(id);</span><br><span class="line">                viewIdMap.put(id, viewId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> viewId;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="function">BindingSet <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ImmutableList.Builder&lt;ViewBinding&gt; viewBindings = ImmutableList.builder();</span><br><span class="line">            <span class="keyword">for</span> (ViewBinding.Builder builder : viewIdMap.values()) &#123;</span><br><span class="line">                viewBindings.add(builder.build());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BindingSet(targetTypeName, bindingClassName, isFinal, isView, isActivity, isDialog, viewBindings.build(), collectionBindings.build(), resourceBindings.build(), parentBinding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ButterKnifeProcessor-findAndParseTargets-1"><a href="#ButterKnifeProcessor-findAndParseTargets-1" class="headerlink" title="ButterKnifeProcessor#findAndParseTargets"></a>ButterKnifeProcessor#findAndParseTargets</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">        <span class="comment">// Associate superclass binders with their subclass binders. This is a queue-based tree walk</span></span><br><span class="line">        <span class="comment">// which starts at the roots (superclasses) and walks to the leafs (subclasses).</span></span><br><span class="line">        Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</span><br><span class="line">                <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entrySet());</span><br><span class="line">        Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (!entries.isEmpty()) &#123;</span><br><span class="line">            Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();<span class="comment">//拿到第一个</span></span><br><span class="line"></span><br><span class="line">            TypeElement type = entry.getKey();<span class="comment">//com.yydcdut.textdemo.MainActivity</span></span><br><span class="line">            BindingSet.Builder builder = entry.getValue();</span><br><span class="line"></span><br><span class="line">            TypeElement parentType = findParentType(type, erasedTargetNames);<span class="comment">//父类</span></span><br><span class="line">            <span class="keyword">if</span> (parentType == <span class="keyword">null</span>) &#123;<span class="comment">//自己就是了</span></span><br><span class="line">                bindingMap.put(type, builder.build());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                BindingSet parentBinding = bindingMap.get(parentType);<span class="comment">//拿到父类的BindingSet</span></span><br><span class="line">                <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    builder.setParent(parentBinding);</span><br><span class="line">                    bindingMap.put(type, builder.build());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Has a superclass binding but we haven't built it yet. Re-enqueue for later.</span></span><br><span class="line">                    entries.addLast(entry);<span class="comment">//放到最后（先解析父类的）</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bindingMap;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span><br><span class="line">     * Finds the parent binder type in the supplied set, if any.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TypeElement <span class="title">findParentType</span><span class="params">(TypeElement typeElement, Set&lt;TypeElement&gt; parents)</span> </span>&#123;</span><br><span class="line">        TypeMirror type;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            type = typeElement.getSuperclass();</span><br><span class="line">            <span class="keyword">if</span> (type.getKind() == TypeKind.NONE) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            typeElement = (TypeElement) ((DeclaredType) type).asElement();</span><br><span class="line">            <span class="keyword">if</span> (parents.contains(typeElement)) &#123;</span><br><span class="line">                <span class="keyword">return</span> typeElement;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ButterKnifeProcessor-process"><a href="#ButterKnifeProcessor-process" class="headerlink" title="ButterKnifeProcessor#process"></a>ButterKnifeProcessor#process</h4><p>findAndParseTargets 算是解析完了，再回过头来看第二步，生成文件的步骤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">        Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</span><br><span class="line">            TypeElement typeElement = entry.getKey();</span><br><span class="line">            BindingSet binding = entry.getValue();</span><br><span class="line"></span><br><span class="line">            JavaFile javaFile = binding.brewJava(sdk);<span class="comment">//变成JavaFile</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                javaFile.writeTo(filer);<span class="comment">//生成文件</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将信息转变成 <code>JavaFile</code> ，通过 filer 完成。</p>
<h4 id="write过程"><a href="#write过程" class="headerlink" title="write过程"></a>write过程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BindingSet</span> </span>&#123;</span><br><span class="line">    <span class="function">JavaFile <span class="title">brewJava</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JavaFile.builder(bindingClassName.packageName(), createType(sdk))<span class="comment">//packageName--&gt;com.yydcdut.textdemo</span></span><br><span class="line">                .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createType</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">        TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())</span><br><span class="line">                .addModifiers(PUBLIC);<span class="comment">//申明类</span></span><br><span class="line">        <span class="keyword">if</span> (isFinal) &#123;</span><br><span class="line">            result.addModifiers(FINAL);<span class="comment">//添加final关键字</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.superclass(parentBinding.bindingClassName);<span class="comment">//继承父类</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.addSuperinterface(UNBINDER);<span class="comment">//实现Unbinder接口</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasTargetField()) &#123;</span><br><span class="line">            result.addField(targetTypeName, <span class="string">"target"</span>, PRIVATE);<span class="comment">//设置private的target变量</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isView) &#123;</span><br><span class="line">            result.addMethod(createBindingConstructorForView());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isActivity) &#123;</span><br><span class="line">            result.addMethod(createBindingConstructorForActivity());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDialog) &#123;</span><br><span class="line">            result.addMethod(createBindingConstructorForDialog());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!constructorNeedsView()) &#123;</span><br><span class="line">            <span class="comment">// Add a delegating constructor with a target type + view signature for reflective use.</span></span><br><span class="line">            result.addMethod(createBindingViewDelegateConstructor());</span><br><span class="line">        &#125;</span><br><span class="line">        result.addMethod(createBindingConstructor(sdk));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasViewBindings() || parentBinding == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.addMethod(createBindingUnbindMethod(result));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result.build();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingConstructorForView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MethodSpec.Builder builder = MethodSpec.constructorBuilder()<span class="comment">//创建构造器</span></span><br><span class="line">                .addAnnotation(UI_THREAD)<span class="comment">//添加UIThread的注解</span></span><br><span class="line">                .addModifiers(PUBLIC)<span class="comment">//为public</span></span><br><span class="line">                .addParameter(targetTypeName, <span class="string">"target"</span>);<span class="comment">//构造函数中得有target参数</span></span><br><span class="line">        <span class="keyword">if</span> (constructorNeedsView()) &#123;<span class="comment">//构造函数中的方法</span></span><br><span class="line">            builder.addStatement(<span class="string">"this(target, target)"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.addStatement(<span class="string">"this(target, target.getContext())"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * True if this binding requires a view. Otherwise only a context is needed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">constructorNeedsView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasViewBindings() <span class="comment">//</span></span><br><span class="line">                || parentBinding != <span class="keyword">null</span> &amp;&amp; parentBinding.constructorNeedsView();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingViewDelegateConstructor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MethodSpec.constructorBuilder()</span><br><span class="line">                .addJavadoc(<span class="string">"@deprecated Use &#123;@link #$T($T, $T)&#125; for direct creation.\n    "</span></span><br><span class="line">                                + <span class="string">"Only present for runtime invocation through &#123;@code ButterKnife.bind()&#125;.\n"</span>,</span><br><span class="line">                        bindingClassName, targetTypeName, CONTEXT)</span><br><span class="line">                .addAnnotation(Deprecated.class)</span><br><span class="line">                .addAnnotation(UI_THREAD)</span><br><span class="line">                .addModifiers(PUBLIC)</span><br><span class="line">                .addParameter(targetTypeName, <span class="string">"target"</span>)</span><br><span class="line">                .addParameter(VIEW, <span class="string">"source"</span>)</span><br><span class="line">                .addStatement((<span class="string">"this(target, source.getContext())"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingConstructor</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">        MethodSpec.Builder constructor = MethodSpec.constructorBuilder()<span class="comment">//构造方法</span></span><br><span class="line">                .addAnnotation(UI_THREAD)<span class="comment">//UIThread注解</span></span><br><span class="line">                .addModifiers(PUBLIC);<span class="comment">//public</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasMethodBindings()) &#123;</span><br><span class="line">            constructor.addParameter(targetTypeName, <span class="string">"target"</span>, FINAL);<span class="comment">//final的target变量</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            constructor.addParameter(targetTypeName, <span class="string">"target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (constructorNeedsView()) &#123;</span><br><span class="line">            constructor.addParameter(VIEW, <span class="string">"source"</span>);<span class="comment">//变量名为source的View</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            constructor.addParameter(CONTEXT, <span class="string">"context"</span>);<span class="comment">//变量名为context的Context</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasUnqualifiedResourceBindings()) &#123;</span><br><span class="line">            <span class="comment">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span></span><br><span class="line">            constructor.addAnnotation(AnnotationSpec.builder(SuppressWarnings.class)</span><br><span class="line">                    .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ResourceType"</span>)</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasOnTouchMethodBindings()) &#123;</span><br><span class="line">            constructor.addAnnotation(AnnotationSpec.builder(SUPPRESS_LINT)</span><br><span class="line">                    .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ClickableViewAccessibility"</span>)</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;<span class="comment">//如果有父类，则调用super</span></span><br><span class="line">            <span class="keyword">if</span> (parentBinding.constructorNeedsView()) &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"super(target, source)"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constructorNeedsView()) &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"super(target, source.getContext())"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"super(target, context)"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            constructor.addCode(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasTargetField()) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">"this.target = target"</span>);<span class="comment">//赋值</span></span><br><span class="line">            constructor.addCode(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasViewBindings()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasViewLocal()) &#123;</span><br><span class="line">                <span class="comment">// Local variable in which all views will be temporarily stored.</span></span><br><span class="line">                constructor.addStatement(<span class="string">"$T view"</span>, VIEW);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</span><br><span class="line">                addViewBinding(constructor, binding);<span class="comment">//View的初始化</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"$L"</span>, binding.render());<span class="comment">//资源的初始化</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</span><br><span class="line">                constructor.addCode(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (constructorNeedsView()) &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"$T context = source.getContext()"</span>, CONTEXT);<span class="comment">//赋值</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (hasResourceBindingsNeedingResource(sdk)) &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"$T res = context.getResources()"</span>, RESOURCES);<span class="comment">//赋值</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (ResourceBinding binding : resourceBindings) &#123;</span><br><span class="line">                constructor.addStatement(<span class="string">"$L"</span>, binding.render(sdk));<span class="comment">//通过不同的SDK版本实现Resource相关(Drawable,Color等)的初始化</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> constructor.build();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addViewBinding</span><span class="params">(MethodSpec.Builder result, ViewBinding binding)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (binding.isSingleFieldBinding()) &#123;<span class="comment">//只有findView的情况，没有监听器</span></span><br><span class="line">            <span class="comment">// Optimize the common case where there's a single binding directly to a field.</span></span><br><span class="line">            FieldViewBinding fieldBinding = binding.getFieldBinding();</span><br><span class="line">            CodeBlock.Builder builder = CodeBlock.builder()</span><br><span class="line">                    .add(<span class="string">"target.$L = "</span>, fieldBinding.getName());<span class="comment">//(target--&gt;MainActivity) ($L--&gt;mEditText)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> requiresCast = requiresCast(fieldBinding.getType());<span class="comment">//是否需要强转</span></span><br><span class="line">            <span class="keyword">if</span> (!requiresCast &amp;&amp; !fieldBinding.isRequired()) &#123;</span><br><span class="line">                builder.add(<span class="string">"source.findViewById($L)"</span>, binding.getId().code);<span class="comment">//findViewById</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                builder.add(<span class="string">"$T.find"</span>, UTILS);</span><br><span class="line">                builder.add(fieldBinding.isRequired() ? <span class="string">"RequiredView"</span> : <span class="string">"OptionalView"</span>);</span><br><span class="line">                <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">                    builder.add(<span class="string">"AsType"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                builder.add(<span class="string">"(source, $L"</span>, binding.getId().code);</span><br><span class="line">                <span class="keyword">if</span> (fieldBinding.isRequired() || requiresCast) &#123;</span><br><span class="line">                    builder.add(<span class="string">", $S"</span>, asHumanDescription(singletonList(fieldBinding)));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">                    builder.add(<span class="string">", $T.class"</span>, fieldBinding.getRawType());</span><br><span class="line">                &#125;</span><br><span class="line">                builder.add(<span class="string">")"</span>);<span class="comment">//target.mEditText = Utils.findRequiredViewAsType(source, R.id.edit, "field 'mEditText'", EditText.class);</span></span><br><span class="line">            &#125;</span><br><span class="line">            result.addStatement(<span class="string">"$L"</span>, builder.build());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;MemberViewBinding&gt; requiredBindings = binding.getRequiredBindings();</span><br><span class="line">        <span class="keyword">if</span> (requiredBindings.isEmpty()) &#123;</span><br><span class="line">            result.addStatement(<span class="string">"view = source.findViewById($L)"</span>, binding.getId().code);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!binding.isBoundToRoot()) &#123;</span><br><span class="line">            result.addStatement(<span class="string">"view = $T.findRequiredView(source, $L, $S)"</span>, UTILS,</span><br><span class="line">                    binding.getId().code, asHumanDescription(requiredBindings));<span class="comment">//view = Utils.findRequiredView(source, R.id.hello, "field 'hello', method 'sayHello', and method 'sayGetOffMe'");</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addFieldBinding(result, binding);<span class="comment">//强转</span></span><br><span class="line">        addMethodBindings(result, binding);<span class="comment">//各种监听器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFieldBinding</span><span class="params">(MethodSpec.Builder result, ViewBinding binding)</span> </span>&#123;</span><br><span class="line">        FieldViewBinding fieldBinding = binding.getFieldBinding();</span><br><span class="line">        <span class="keyword">if</span> (fieldBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requiresCast(fieldBinding.getType())) &#123;</span><br><span class="line">                result.addStatement(<span class="string">"target.$L = $T.castView(view, $L, $S, $T.class)"</span>,</span><br><span class="line">                        fieldBinding.getName(), UTILS, binding.getId().code,</span><br><span class="line">                        asHumanDescription(singletonList(fieldBinding)), fieldBinding.getRawType());<span class="comment">// target.hello = Utils.castView(view, R.id.hello, "field 'hello'", Button.class);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result.addStatement(<span class="string">"target.$L = view"</span>, fieldBinding.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后文件的生成是通过 <code>com.squareup.javapoet.JavaFile</code> 生成的。</p>
<h4 id="官方-demo-的栗子"><a href="#官方-demo-的栗子" class="headerlink" title="官方 demo 的栗子"></a>官方 demo 的栗子</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.butterknife.library;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.animation.AlphaAnimation;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> butterknife.BindView;</span><br><span class="line"><span class="keyword">import</span> butterknife.BindViews;</span><br><span class="line"><span class="keyword">import</span> butterknife.ButterKnife;</span><br><span class="line"><span class="keyword">import</span> butterknife.OnClick;</span><br><span class="line"><span class="keyword">import</span> butterknife.OnItemClick;</span><br><span class="line"><span class="keyword">import</span> butterknife.OnLongClick;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> android.widget.Toast.LENGTH_SHORT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ButterKnife.Action&lt;View&gt; ALPHA_FADE = <span class="keyword">new</span> ButterKnife.Action&lt;View&gt;() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(@NonNull View view, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">            AlphaAnimation alphaAnimation = <span class="keyword">new</span> AlphaAnimation(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            alphaAnimation.setFillBefore(<span class="keyword">true</span>);</span><br><span class="line">            alphaAnimation.setDuration(<span class="number">500</span>);</span><br><span class="line">            alphaAnimation.setStartOffset(index * <span class="number">100</span>);</span><br><span class="line">            view.startAnimation(alphaAnimation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BindView</span>(R2.id.title)</span><br><span class="line">    TextView title;</span><br><span class="line">    <span class="annotation">@BindView</span>(R2.id.subtitle)</span><br><span class="line">    TextView subtitle;</span><br><span class="line">    <span class="annotation">@BindView</span>(R2.id.hello)</span><br><span class="line">    Button hello;</span><br><span class="line">    <span class="annotation">@BindView</span>(R2.id.list_of_things)</span><br><span class="line">    ListView listOfThings;</span><br><span class="line">    <span class="annotation">@BindView</span>(R2.id.footer)</span><br><span class="line">    TextView footer;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@BindViews</span>(&#123;R2.id.title, R2.id.subtitle, R2.id.hello&#125;)</span><br><span class="line">    List&lt;View&gt; headerViews;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SimpleAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@OnClick</span>(R2.id.hello)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"Hello, views!"</span>, LENGTH_SHORT).show();</span><br><span class="line">        ButterKnife.apply(headerViews, ALPHA_FADE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@OnLongClick</span>(R2.id.hello)</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">sayGetOffMe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"Let go of me!"</span>, LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@OnItemClick</span>(R2.id.list_of_things)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"You clicked: "</span> + adapter.getItem(position), LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.simple_activity);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Contrived code to use the bound fields.</span></span><br><span class="line">        title.setText(<span class="string">"Butter Knife"</span>);</span><br><span class="line">        subtitle.setText(<span class="string">"Field and method binding for Android views."</span>);</span><br><span class="line">        footer.setText(<span class="string">"by Jake Wharton"</span>);</span><br><span class="line">        hello.setText(<span class="string">"Say Hello"</span>);</span><br><span class="line"></span><br><span class="line">        adapter = <span class="keyword">new</span> SimpleAdapter(<span class="keyword">this</span>);</span><br><span class="line">        listOfThings.setAdapter(adapter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="官方-demo-的-apt-生成类的栗子"><a href="#官方-demo-的-apt-生成类的栗子" class="headerlink" title="官方 demo 的 apt 生成类的栗子"></a>官方 demo 的 apt 生成类的栗子</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generated code from Butter Knife. Do not modify!</span></span><br><span class="line"><span class="keyword">package</span> com.example.butterknife.library;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.annotation.CallSuper;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.UiThread;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.AdapterView;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> butterknife.Unbinder;</span><br><span class="line"><span class="keyword">import</span> butterknife.internal.DebouncingOnClickListener;</span><br><span class="line"><span class="keyword">import</span> butterknife.internal.Utils;</span><br><span class="line"><span class="keyword">import</span> java.lang.IllegalStateException;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinding</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> T target;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> View view2130968578;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> View view2130968579;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@UiThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SimpleActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> T target, View source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.target = target;</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    target.title = Utils.findRequiredViewAsType(source, R.id.title, <span class="string">"field 'title'"</span>, TextView.class);</span><br><span class="line">    target.subtitle = Utils.findRequiredViewAsType(source, R.id.subtitle, <span class="string">"field 'subtitle'"</span>, TextView.class);</span><br><span class="line">    view = Utils.findRequiredView(source, R.id.hello, <span class="string">"field 'hello', method 'sayHello', and method 'sayGetOffMe'"</span>);</span><br><span class="line">    target.hello = Utils.castView(view, R.id.hello, <span class="string">"field 'hello'"</span>, Button.class);</span><br><span class="line">    view2130968578 = view;</span><br><span class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</span><br><span class="line">        target.sayHello();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    view.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target.sayGetOffMe();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    view = Utils.findRequiredView(source, R.id.list_of_things, <span class="string">"field 'listOfThings' and method 'onItemClick'"</span>);</span><br><span class="line">    target.listOfThings = Utils.castView(view, R.id.list_of_things, <span class="string">"field 'listOfThings'"</span>, ListView.class);</span><br><span class="line">    view2130968579 = view;</span><br><span class="line">    ((AdapterView&lt;?&gt;) view).setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</span><br><span class="line">        target.onItemClick(p2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    target.footer = Utils.findRequiredViewAsType(source, R.id.footer, <span class="string">"field 'footer'"</span>, TextView.class);</span><br><span class="line">    target.headerViews = Utils.listOf(</span><br><span class="line">        Utils.findRequiredView(source, R.id.title, <span class="string">"field 'headerViews'"</span>), </span><br><span class="line">        Utils.findRequiredView(source, R.id.subtitle, <span class="string">"field 'headerViews'"</span>), </span><br><span class="line">        Utils.findRequiredView(source, R.id.hello, <span class="string">"field 'headerViews'"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="annotation">@CallSuper</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T target = <span class="keyword">this</span>.target;</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</span><br><span class="line"></span><br><span class="line">    target.title = <span class="keyword">null</span>;</span><br><span class="line">    target.subtitle = <span class="keyword">null</span>;</span><br><span class="line">    target.hello = <span class="keyword">null</span>;</span><br><span class="line">    target.listOfThings = <span class="keyword">null</span>;</span><br><span class="line">    target.footer = <span class="keyword">null</span>;</span><br><span class="line">    target.headerViews = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    view2130968578.setOnClickListener(<span class="keyword">null</span>);</span><br><span class="line">    view2130968578.setOnLongClickListener(<span class="keyword">null</span>);</span><br><span class="line">    view2130968578 = <span class="keyword">null</span>;</span><br><span class="line">    ((AdapterView&lt;?&gt;) view2130968579).setOnItemClickListener(<span class="keyword">null</span>);</span><br><span class="line">    view2130968579 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ButterKnife"><a href="#ButterKnife" class="headerlink" title="ButterKnife"></a>ButterKnife</h3><p>当要进行 bind 的时候，都需要在 Activity 或 View 等的初始化函数中进行绑定，这里就拿 Activity 为栗子进行分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnife</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> Activity&#125;. The current content</span><br><span class="line">     * view is used as the view root.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> target Target activity for view binding.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@UiThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</span><br><span class="line">        View sourceView = target.getWindow().getDecorView();</span><br><span class="line">        <span class="keyword">return</span> createBinding(target, sourceView);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; targetClass = target.getClass();</span><br><span class="line">        <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"Looking up binding for "</span> + targetClass.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Unbinder.EMPTY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> constructor.newInstance(target, source);<span class="comment">//申明实例</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            Throwable cause = e.getCause();</span><br><span class="line">            <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create binding instance."</span>, cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="annotation">@Nullable</span></span><br><span class="line">    <span class="annotation">@CheckResult</span></span><br><span class="line">    <span class="annotation">@UiThread</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</span><br><span class="line">        Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);<span class="comment">//判断绑定过了没有</span></span><br><span class="line">        <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"HIT: Cached in binding map."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> bindingCtor;</span><br><span class="line">        &#125;</span><br><span class="line">        String clsName = cls.getName();</span><br><span class="line">        <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;<span class="comment">//排除android和java的包</span></span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; bindingClass = cls.getClassLoader().loadClass(clsName + <span class="string">"_ViewBinding"</span>);<span class="comment">//加载后面加"_ViewBinding"的累</span></span><br><span class="line">            <span class="comment">//noinspection unchecked</span></span><br><span class="line">            bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);<span class="comment">//初始化</span></span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"HIT: Loaded binding class and constructor."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</span><br><span class="line">            &#125;</span><br><span class="line">            bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find binding constructor for "</span> + clsName, e);</span><br><span class="line">        &#125;</span><br><span class="line">        BINDINGS.put(cls, bindingCtor);</span><br><span class="line">        <span class="keyword">return</span> bindingCtor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终通过 ClassLoader 的方式将类加载出来，最后 constructor.newInstance 方法来调用该类的构造函数。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>平时了解到更多的是运行时注解，即声明注解的生命周期为 RUNTIME ，然后在运行的时候通过反射完成注入，这种方式虽然简单，但是设计到比较多的反射，必然多多少少会有性能的损耗。而 ButterKnife 用的 APT 编译时解析技术，比较好的解决了反射这些问题。</p>
<p>APT 大概就是声明的注解的生命周期为 CLASS ，然后继承 AbstractProcessor 类。继承这个类后，在编译的时候，编译器会扫描所有带有你要处理的注解的类，然后再调用 AbstractProcessor 的 process 方法，对注解进行处理，那么就可以在处理的时候，动态生成绑定事件或者控件的 java 代码，然后在运行的时候，直接调用 bind 方法完成绑定。<br>其实这种方式的好处是我们不用再一遍一遍地写 findViewById 和 onClick 等代码了，这个框架在编译的时候帮我们自动生成了这些代码，然后在运行的时候调用就行了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/28/gradle-recipes-for-android/" class="prev">PREV</a><a href="/2017/03/10/ui-optimize/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yydcdut.com">yydcdut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>