<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ijkplayer框架简析 -- avcodec_open2 · Android杂文 - yydcdut</title><meta name="description" content="ijkplayer框架简析 -- avcodec_open2 - yydcdut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yydcdut.com/atom.xml" title="Android杂文 - yydcdut"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut/yydcdut.github.io/issues" target="_blank" class="nav-list-link">COMMENT</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ijkplayer框架简析 -- avcodec_open2</h1><div class="post-info">2019年3月3日</div><div class="post-content"><p><code>avcodec_open2()</code> 主要作用是初始化一个视音频编解码器的 AVCodecContext</p>
<a id="more"></a>
<h2 id="avcodec-open2"><a href="#avcodec-open2" class="headerlink" title="avcodec_open2"></a>avcodec_open2</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line">int attribute_align_arg avcodec_open2(AVCodecContext *avctx, const AVCodec *codec, AVDictionary **options)</span><br><span class="line">&#123;</span><br><span class="line">    int ret = 0;</span><br><span class="line">    AVDictionary *tmp = NULL;</span><br><span class="line">    const AVPixFmtDescriptor *pixdesc;</span><br><span class="line"></span><br><span class="line">    if (avcodec_is_open(avctx))</span><br><span class="line">        return 0;</span><br><span class="line"></span><br><span class="line">    if ((!codec &amp;&amp; !avctx-&gt;codec)) &#123;</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR, "No codec provided to avcodec_open2()\n");</span><br><span class="line">        return AVERROR(EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line">    if ((codec &amp;&amp; avctx-&gt;codec &amp;&amp; codec != avctx-&gt;codec)) &#123;</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR, "This AVCodecContext was allocated for %s, "</span><br><span class="line">                                    "but %s passed to avcodec_open2()\n", avctx-&gt;codec-&gt;name, codec-&gt;name);</span><br><span class="line">        return AVERROR(EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!codec)</span><br><span class="line">        codec = avctx-&gt;codec;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;extradata_size &lt; 0 || avctx-&gt;extradata_size &gt;= FF_MAX_EXTRADATA_SIZE)</span><br><span class="line">        return AVERROR(EINVAL);</span><br><span class="line"></span><br><span class="line">    if (options)</span><br><span class="line">        av_dict_copy(&amp;tmp, *options, 0);</span><br><span class="line"></span><br><span class="line">    ret = ff_lock_avcodec(avctx, codec);</span><br><span class="line">    if (ret &lt; 0)</span><br><span class="line">        return ret;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal = av_mallocz(sizeof(AVCodecInternal));</span><br><span class="line">    if (!avctx-&gt;internal) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;pool = av_mallocz(sizeof(*avctx-&gt;internal-&gt;pool));</span><br><span class="line">    if (!avctx-&gt;internal-&gt;pool) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;to_free = av_frame_alloc();</span><br><span class="line">    if (!avctx-&gt;internal-&gt;to_free) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;compat_decode_frame = av_frame_alloc();</span><br><span class="line">    if (!avctx-&gt;internal-&gt;compat_decode_frame) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;buffer_frame = av_frame_alloc();</span><br><span class="line">    if (!avctx-&gt;internal-&gt;buffer_frame) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;buffer_pkt = av_packet_alloc();</span><br><span class="line">    if (!avctx-&gt;internal-&gt;buffer_pkt) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;ds.in_pkt = av_packet_alloc();</span><br><span class="line">    if (!avctx-&gt;internal-&gt;ds.in_pkt) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;last_pkt_props = av_packet_alloc();</span><br><span class="line">    if (!avctx-&gt;internal-&gt;last_pkt_props) &#123;</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;internal-&gt;skip_samples_multiplier = 1;</span><br><span class="line"></span><br><span class="line">    if (codec-&gt;priv_data_size &gt; 0) &#123;</span><br><span class="line">        if (!avctx-&gt;priv_data) &#123;</span><br><span class="line">            avctx-&gt;priv_data = av_mallocz(codec-&gt;priv_data_size);</span><br><span class="line">            if (!avctx-&gt;priv_data) &#123;</span><br><span class="line">                ret = AVERROR(ENOMEM);</span><br><span class="line">                goto end;</span><br><span class="line">            &#125;</span><br><span class="line">            if (codec-&gt;priv_class) &#123;</span><br><span class="line">                *(const AVClass **)avctx-&gt;priv_data = codec-&gt;priv_class;</span><br><span class="line">                av_opt_set_defaults(avctx-&gt;priv_data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (codec-&gt;priv_class &amp;&amp; (ret = av_opt_set_dict(avctx-&gt;priv_data, &amp;tmp)) &lt; 0)</span><br><span class="line">            goto free_and_end;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        avctx-&gt;priv_data = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // 将输入的 AVDictionary 形式的选项设置到 AVCodecContext</span><br><span class="line">    if ((ret = av_opt_set_dict(avctx, &amp;tmp)) &lt; 0)</span><br><span class="line">        goto free_and_end;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;codec_whitelist &amp;&amp; av_match_list(codec-&gt;name, avctx-&gt;codec_whitelist, ',') &lt;= 0) &#123;</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR, "Codec (%s) not on whitelist \'%s\'\n", codec-&gt;name, avctx-&gt;codec_whitelist);</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // only call ff_set_dimensions() for non H.264/VP6F/DXV codecs so as not to overwrite previously setup dimensions</span><br><span class="line">    if (!(avctx-&gt;coded_width &amp;&amp; avctx-&gt;coded_height &amp;&amp; avctx-&gt;width &amp;&amp; avctx-&gt;height &amp;&amp;</span><br><span class="line">          (avctx-&gt;codec_id == AV_CODEC_ID_H264 || avctx-&gt;codec_id == AV_CODEC_ID_VP6F || avctx-&gt;codec_id == AV_CODEC_ID_DXV))) &#123;</span><br><span class="line">    if (avctx-&gt;coded_width &amp;&amp; avctx-&gt;coded_height)</span><br><span class="line">        ret = ff_set_dimensions(avctx, avctx-&gt;coded_width, avctx-&gt;coded_height);</span><br><span class="line">    else if (avctx-&gt;width &amp;&amp; avctx-&gt;height)</span><br><span class="line">        ret = ff_set_dimensions(avctx, avctx-&gt;width, avctx-&gt;height);</span><br><span class="line">    if (ret &lt; 0)</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 检查宽和高</span><br><span class="line">    if ((avctx-&gt;coded_width || avctx-&gt;coded_height || avctx-&gt;width || avctx-&gt;height)</span><br><span class="line">        &amp;&amp; (  av_image_check_size2(avctx-&gt;coded_width, avctx-&gt;coded_height, avctx-&gt;max_pixels, AV_PIX_FMT_NONE, 0, avctx) &lt; 0</span><br><span class="line">           || av_image_check_size2(avctx-&gt;width,       avctx-&gt;height,       avctx-&gt;max_pixels, AV_PIX_FMT_NONE, 0, avctx) &lt; 0)) &#123;</span><br><span class="line">        av_log(avctx, AV_LOG_WARNING, "Ignoring invalid width/height values\n");</span><br><span class="line">        ff_set_dimensions(avctx, 0, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 检查宽高比</span><br><span class="line">    if (avctx-&gt;width &gt; 0 &amp;&amp; avctx-&gt;height &gt; 0) &#123;</span><br><span class="line">        if (av_image_check_sar(avctx-&gt;width, avctx-&gt;height,</span><br><span class="line">                               avctx-&gt;sample_aspect_ratio) &lt; 0) &#123;</span><br><span class="line">            av_log(avctx, AV_LOG_WARNING, "ignoring invalid SAR: %u/%u\n",</span><br><span class="line">                   avctx-&gt;sample_aspect_ratio.num,</span><br><span class="line">                   avctx-&gt;sample_aspect_ratio.den);</span><br><span class="line">            avctx-&gt;sample_aspect_ratio = (AVRational)&#123; 0, 1 &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* if the decoder init function was already called previously,</span><br><span class="line">     * free the already allocated subtitle_header before overwriting it */</span><br><span class="line">    if (av_codec_is_decoder(codec))</span><br><span class="line">        av_freep(&amp;avctx-&gt;subtitle_header);</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;channels &gt; FF_SANE_NB_CHANNELS) &#123;</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;codec = codec;</span><br><span class="line">    if ((avctx-&gt;codec_type == AVMEDIA_TYPE_UNKNOWN || avctx-&gt;codec_type == codec-&gt;type) &amp;&amp;</span><br><span class="line">        avctx-&gt;codec_id == AV_CODEC_ID_NONE) &#123;</span><br><span class="line">        avctx-&gt;codec_type = codec-&gt;type;</span><br><span class="line">        avctx-&gt;codec_id   = codec-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line">    if (avctx-&gt;codec_id != codec-&gt;id || (avctx-&gt;codec_type != codec-&gt;type</span><br><span class="line">                                         &amp;&amp; avctx-&gt;codec_type != AVMEDIA_TYPE_ATTACHMENT)) &#123;</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR, "Codec type or id mismatches\n");</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line">    avctx-&gt;frame_number = 0;</span><br><span class="line">    avctx-&gt;codec_descriptor = avcodec_descriptor_get(avctx-&gt;codec_id);</span><br><span class="line"></span><br><span class="line">    // 检查编码器是否出于“实验”阶段</span><br><span class="line">    if ((avctx-&gt;codec-&gt;capabilities &amp; AV_CODEC_CAP_EXPERIMENTAL) &amp;&amp;</span><br><span class="line">        avctx-&gt;strict_std_compliance &gt; FF_COMPLIANCE_EXPERIMENTAL) &#123;</span><br><span class="line">        const char *codec_string = av_codec_is_encoder(codec) ? "encoder" : "decoder";</span><br><span class="line">        AVCodec *codec2;</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR,</span><br><span class="line">               "The %s '%s' is experimental but experimental codecs are not enabled, "</span><br><span class="line">               "add '-strict %d' if you want to use it.\n",</span><br><span class="line">               codec_string, codec-&gt;name, FF_COMPLIANCE_EXPERIMENTAL);</span><br><span class="line">        codec2 = av_codec_is_encoder(codec) ? avcodec_find_encoder(codec-&gt;id) : avcodec_find_decoder(codec-&gt;id);</span><br><span class="line">        if (!(codec2-&gt;capabilities &amp; AV_CODEC_CAP_EXPERIMENTAL))</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR, "Alternatively use the non experimental %s '%s'.\n",</span><br><span class="line">                codec_string, codec2-&gt;name);</span><br><span class="line">        ret = AVERROR_EXPERIMENTAL;</span><br><span class="line">        goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;codec_type == AVMEDIA_TYPE_AUDIO &amp;&amp;</span><br><span class="line">        (!avctx-&gt;time_base.num || !avctx-&gt;time_base.den)) &#123;</span><br><span class="line">        avctx-&gt;time_base.num = 1;</span><br><span class="line">        avctx-&gt;time_base.den = avctx-&gt;sample_rate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!HAVE_THREADS)</span><br><span class="line">        av_log(avctx, AV_LOG_WARNING, "Warning: not compiled with thread support, using thread emulation\n");</span><br><span class="line"></span><br><span class="line">    if (CONFIG_FRAME_THREAD_ENCODER &amp;&amp; av_codec_is_encoder(avctx-&gt;codec)) &#123;</span><br><span class="line">        ff_unlock_avcodec(codec); //we will instantiate a few encoders thus kick the counter to prevent false detection of a problem</span><br><span class="line">        ret = ff_frame_thread_encoder_init(avctx, options ? *options : NULL);</span><br><span class="line">        ff_lock_avcodec(avctx, codec);</span><br><span class="line">        if (ret &lt; 0)</span><br><span class="line">            goto free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (HAVE_THREADS</span><br><span class="line">        &amp;&amp; !(avctx-&gt;internal-&gt;frame_thread_encoder &amp;&amp; (avctx-&gt;active_thread_type&amp;FF_THREAD_FRAME))) &#123;</span><br><span class="line">        ret = ff_thread_init(avctx);</span><br><span class="line">        if (ret &lt; 0) &#123;</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!HAVE_THREADS &amp;&amp; !(codec-&gt;capabilities &amp; AV_CODEC_CAP_AUTO_THREADS))</span><br><span class="line">        avctx-&gt;thread_count = 1;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;codec-&gt;max_lowres &lt; avctx-&gt;lowres || avctx-&gt;lowres &lt; 0) &#123;</span><br><span class="line">        av_log(avctx, AV_LOG_WARNING, "The maximum value for lowres supported by the decoder is %d\n",</span><br><span class="line">               avctx-&gt;codec-&gt;max_lowres);</span><br><span class="line">        avctx-&gt;lowres = avctx-&gt;codec-&gt;max_lowres;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#if FF_API_VISMV</span><br><span class="line">    if (avctx-&gt;debug_mv)</span><br><span class="line">        av_log(avctx, AV_LOG_WARNING, "The 'vismv' option is deprecated, "</span><br><span class="line">               "see the codecview filter instead.\n");</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    // 检查输入参数是否符合【编码器】要求</span><br><span class="line">    if (av_codec_is_encoder(avctx-&gt;codec)) &#123;</span><br><span class="line">        int i;</span><br><span class="line">#if FF_API_CODED_FRAME</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">        avctx-&gt;coded_frame = av_frame_alloc();</span><br><span class="line">        if (!avctx-&gt;coded_frame) &#123;</span><br><span class="line">            ret = AVERROR(ENOMEM);</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        if (avctx-&gt;time_base.num &lt;= 0 || avctx-&gt;time_base.den &lt;= 0) &#123;</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR, "The encoder timebase is not set.\n");</span><br><span class="line">            ret = AVERROR(EINVAL);</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 如果包含采样率参数（表明是音频），检查采样率是否符合要求</span><br><span class="line">        if (avctx-&gt;codec-&gt;sample_fmts) &#123;</span><br><span class="line">            // 遍历编码器支持的所有采样率</span><br><span class="line">            for (i = 0; avctx-&gt;codec-&gt;sample_fmts[i] != AV_SAMPLE_FMT_NONE; i++) &#123;</span><br><span class="line">                // 如果设置的采样率 == 编码器支持的采样率，跳出循环</span><br><span class="line">                if (avctx-&gt;sample_fmt == avctx-&gt;codec-&gt;sample_fmts[i])</span><br><span class="line">                    break;</span><br><span class="line">                if (avctx-&gt;channels == 1 &amp;&amp;</span><br><span class="line">                    av_get_planar_sample_fmt(avctx-&gt;sample_fmt) ==</span><br><span class="line">                    av_get_planar_sample_fmt(avctx-&gt;codec-&gt;sample_fmts[i])) &#123;</span><br><span class="line">                    avctx-&gt;sample_fmt = avctx-&gt;codec-&gt;sample_fmts[i];</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // 采样率取值是否正确</span><br><span class="line">            if (avctx-&gt;codec-&gt;sample_fmts[i] == AV_SAMPLE_FMT_NONE) &#123;</span><br><span class="line">                char buf[128];</span><br><span class="line">                snprintf(buf, sizeof(buf), "%d", avctx-&gt;sample_fmt);</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR, "Specified sample format %s is invalid or not supported\n",</span><br><span class="line">                       (char *)av_x_if_null(av_get_sample_fmt_name(avctx-&gt;sample_fmt), buf));</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 像素格式</span><br><span class="line">        if (avctx-&gt;codec-&gt;pix_fmts) &#123;</span><br><span class="line">            for (i = 0; avctx-&gt;codec-&gt;pix_fmts[i] != AV_PIX_FMT_NONE; i++)</span><br><span class="line">                if (avctx-&gt;pix_fmt == avctx-&gt;codec-&gt;pix_fmts[i])</span><br><span class="line">                    break;</span><br><span class="line">            if (avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_NONE</span><br><span class="line">                &amp;&amp; !((avctx-&gt;codec_id == AV_CODEC_ID_MJPEG || avctx-&gt;codec_id == AV_CODEC_ID_LJPEG)</span><br><span class="line">                     &amp;&amp; avctx-&gt;strict_std_compliance &lt;= FF_COMPLIANCE_UNOFFICIAL)) &#123;</span><br><span class="line">                char buf[128];</span><br><span class="line">                snprintf(buf, sizeof(buf), "%d", avctx-&gt;pix_fmt);</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR, "Specified pixel format %s is invalid or not supported\n",</span><br><span class="line">                       (char *)av_x_if_null(av_get_pix_fmt_name(avctx-&gt;pix_fmt), buf));</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">            if (avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ420P ||</span><br><span class="line">                avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ411P ||</span><br><span class="line">                avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ422P ||</span><br><span class="line">                avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ440P ||</span><br><span class="line">                avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ444P)</span><br><span class="line">                avctx-&gt;color_range = AVCOL_RANGE_JPEG;</span><br><span class="line">        &#125;</span><br><span class="line">        // 采样率</span><br><span class="line">        if (avctx-&gt;codec-&gt;supported_samplerates) &#123;</span><br><span class="line">            for (i = 0; avctx-&gt;codec-&gt;supported_samplerates[i] != 0; i++)</span><br><span class="line">                if (avctx-&gt;sample_rate == avctx-&gt;codec-&gt;supported_samplerates[i])</span><br><span class="line">                    break;</span><br><span class="line">            if (avctx-&gt;codec-&gt;supported_samplerates[i] == 0) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR, "Specified sample rate %d is not supported\n",</span><br><span class="line">                       avctx-&gt;sample_rate);</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (avctx-&gt;sample_rate &lt; 0) &#123;</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR, "Specified sample rate %d is not supported\n",</span><br><span class="line">                    avctx-&gt;sample_rate);</span><br><span class="line">            ret = AVERROR(EINVAL);</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line">        // 声道布局</span><br><span class="line">        if (avctx-&gt;codec-&gt;channel_layouts) &#123;</span><br><span class="line">            if (!avctx-&gt;channel_layout) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_WARNING, "Channel layout not specified\n");</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                for (i = 0; avctx-&gt;codec-&gt;channel_layouts[i] != 0; i++)</span><br><span class="line">                    if (avctx-&gt;channel_layout == avctx-&gt;codec-&gt;channel_layouts[i])</span><br><span class="line">                        break;</span><br><span class="line">                if (avctx-&gt;codec-&gt;channel_layouts[i] == 0) &#123;</span><br><span class="line">                    char buf[512];</span><br><span class="line">                    av_get_channel_layout_string(buf, sizeof(buf), -1, avctx-&gt;channel_layout);</span><br><span class="line">                    av_log(avctx, AV_LOG_ERROR, "Specified channel layout '%s' is not supported\n", buf);</span><br><span class="line">                    ret = AVERROR(EINVAL);</span><br><span class="line">                    goto free_and_end;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 声道</span><br><span class="line">        if (avctx-&gt;channel_layout &amp;&amp; avctx-&gt;channels) &#123;</span><br><span class="line">            int channels = av_get_channel_layout_nb_channels(avctx-&gt;channel_layout);</span><br><span class="line">            if (channels != avctx-&gt;channels) &#123;</span><br><span class="line">                char buf[512];</span><br><span class="line">                av_get_channel_layout_string(buf, sizeof(buf), -1, avctx-&gt;channel_layout);</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR,</span><br><span class="line">                       "Channel layout '%s' with %d channels does not match number of specified channels %d\n",</span><br><span class="line">                       buf, channels, avctx-&gt;channels);</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (avctx-&gt;channel_layout) &#123;</span><br><span class="line">            avctx-&gt;channels = av_get_channel_layout_nb_channels(avctx-&gt;channel_layout);</span><br><span class="line">        &#125;</span><br><span class="line">        if (avctx-&gt;channels &lt; 0) &#123;</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR, "Specified number of channels %d is not supported\n",</span><br><span class="line">                    avctx-&gt;channels);</span><br><span class="line">            ret = AVERROR(EINVAL);</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line">        if(avctx-&gt;codec_type == AVMEDIA_TYPE_VIDEO) &#123;</span><br><span class="line">            pixdesc = av_pix_fmt_desc_get(avctx-&gt;pix_fmt);</span><br><span class="line">            if (    avctx-&gt;bits_per_raw_sample &lt; 0</span><br><span class="line">                || (avctx-&gt;bits_per_raw_sample &gt; 8 &amp;&amp; pixdesc-&gt;comp[0].depth &lt;= 8)) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_WARNING, "Specified bit depth %d not possible with the specified pixel formats depth %d\n",</span><br><span class="line">                    avctx-&gt;bits_per_raw_sample, pixdesc-&gt;comp[0].depth);</span><br><span class="line">                avctx-&gt;bits_per_raw_sample = pixdesc-&gt;comp[0].depth;</span><br><span class="line">            &#125;</span><br><span class="line">            // 宽高</span><br><span class="line">            if (avctx-&gt;width &lt;= 0 || avctx-&gt;height &lt;= 0) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR, "dimensions not set\n");</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 码率</span><br><span class="line">        if (   (avctx-&gt;codec_type == AVMEDIA_TYPE_VIDEO || avctx-&gt;codec_type == AVMEDIA_TYPE_AUDIO)</span><br><span class="line">            &amp;&amp; avctx-&gt;bit_rate&gt;0 &amp;&amp; avctx-&gt;bit_rate&lt;1000) &#123;</span><br><span class="line">            av_log(avctx, AV_LOG_WARNING, "Bitrate %"PRId64" is extremely low, maybe you mean %"PRId64"k\n", avctx-&gt;bit_rate, avctx-&gt;bit_rate);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!avctx-&gt;rc_initial_buffer_occupancy)</span><br><span class="line">            avctx-&gt;rc_initial_buffer_occupancy = avctx-&gt;rc_buffer_size * 3LL / 4;</span><br><span class="line"></span><br><span class="line">        if (avctx-&gt;ticks_per_frame &amp;&amp; avctx-&gt;time_base.num &amp;&amp;</span><br><span class="line">            avctx-&gt;ticks_per_frame &gt; INT_MAX / avctx-&gt;time_base.num) &#123;</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR,</span><br><span class="line">                   "ticks_per_frame %d too large for the timebase %d/%d.",</span><br><span class="line">                   avctx-&gt;ticks_per_frame,</span><br><span class="line">                   avctx-&gt;time_base.num,</span><br><span class="line">                   avctx-&gt;time_base.den);</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (avctx-&gt;hw_frames_ctx) &#123;</span><br><span class="line">            AVHWFramesContext *frames_ctx = (AVHWFramesContext*)avctx-&gt;hw_frames_ctx-&gt;data;</span><br><span class="line">            if (frames_ctx-&gt;format != avctx-&gt;pix_fmt) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR,</span><br><span class="line">                       "Mismatching AVCodecContext.pix_fmt and AVHWFramesContext.format\n");</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">            if (avctx-&gt;sw_pix_fmt != AV_PIX_FMT_NONE &amp;&amp;</span><br><span class="line">                avctx-&gt;sw_pix_fmt != frames_ctx-&gt;sw_format) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR,</span><br><span class="line">                       "Mismatching AVCodecContext.sw_pix_fmt (%s) "</span><br><span class="line">                       "and AVHWFramesContext.sw_format (%s)\n",</span><br><span class="line">                       av_get_pix_fmt_name(avctx-&gt;sw_pix_fmt),</span><br><span class="line">                       av_get_pix_fmt_name(frames_ctx-&gt;sw_format));</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125;</span><br><span class="line">            avctx-&gt;sw_pix_fmt = frames_ctx-&gt;sw_format;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;pts_correction_num_faulty_pts =</span><br><span class="line">    avctx-&gt;pts_correction_num_faulty_dts = 0;</span><br><span class="line">    avctx-&gt;pts_correction_last_pts =</span><br><span class="line">    avctx-&gt;pts_correction_last_dts = INT64_MIN;</span><br><span class="line"></span><br><span class="line">    if (   !CONFIG_GRAY &amp;&amp; avctx-&gt;flags &amp; AV_CODEC_FLAG_GRAY</span><br><span class="line">        &amp;&amp; avctx-&gt;codec_descriptor-&gt;type == AVMEDIA_TYPE_VIDEO)</span><br><span class="line">        av_log(avctx, AV_LOG_WARNING,</span><br><span class="line">               "gray decoding requested but not enabled at configuration time\n");</span><br><span class="line"></span><br><span class="line">    // 一切检查都无误之后，调用编解码器初始化函数</span><br><span class="line">    if (   avctx-&gt;codec-&gt;init &amp;&amp; (!(avctx-&gt;active_thread_type&amp;FF_THREAD_FRAME)</span><br><span class="line">        || avctx-&gt;internal-&gt;frame_thread_encoder)) &#123;</span><br><span class="line">        ret = avctx-&gt;codec-&gt;init(avctx);</span><br><span class="line">        if (ret &lt; 0) &#123;</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret=0;</span><br><span class="line"></span><br><span class="line">#if FF_API_AUDIOENC_DELAY</span><br><span class="line">    if (av_codec_is_encoder(avctx-&gt;codec))</span><br><span class="line">        avctx-&gt;delay = avctx-&gt;initial_padding;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    // 解码器的参数大部分都是由系统自动设定而不是由用户设定，因而不怎么需要检查</span><br><span class="line">    if (av_codec_is_decoder(avctx-&gt;codec)) &#123;</span><br><span class="line">        if (!avctx-&gt;bit_rate)</span><br><span class="line">            avctx-&gt;bit_rate = get_bit_rate(avctx);</span><br><span class="line">        /* validate channel layout from the decoder */</span><br><span class="line">        if (avctx-&gt;channel_layout) &#123;</span><br><span class="line">            int channels = av_get_channel_layout_nb_channels(avctx-&gt;channel_layout);</span><br><span class="line">            if (!avctx-&gt;channels)</span><br><span class="line">                avctx-&gt;channels = channels;</span><br><span class="line">            else if (channels != avctx-&gt;channels) &#123;</span><br><span class="line">                char buf[512];</span><br><span class="line">                av_get_channel_layout_string(buf, sizeof(buf), -1, avctx-&gt;channel_layout);</span><br><span class="line">                av_log(avctx, AV_LOG_WARNING,</span><br><span class="line">                       "Channel layout '%s' with %d channels does not match specified number of channels %d: "</span><br><span class="line">                       "ignoring specified channel layout\n",</span><br><span class="line">                       buf, channels, avctx-&gt;channels);</span><br><span class="line">                avctx-&gt;channel_layout = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (avctx-&gt;channels &amp;&amp; avctx-&gt;channels &lt; 0 ||</span><br><span class="line">            avctx-&gt;channels &gt; FF_SANE_NB_CHANNELS) &#123;</span><br><span class="line">            ret = AVERROR(EINVAL);</span><br><span class="line">            goto free_and_end;</span><br><span class="line">        &#125;</span><br><span class="line">        if (avctx-&gt;sub_charenc) &#123;</span><br><span class="line">            if (avctx-&gt;codec_type != AVMEDIA_TYPE_SUBTITLE) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_ERROR, "Character encoding is only "</span><br><span class="line">                       "supported with subtitles codecs\n");</span><br><span class="line">                ret = AVERROR(EINVAL);</span><br><span class="line">                goto free_and_end;</span><br><span class="line">            &#125; else if (avctx-&gt;codec_descriptor-&gt;props &amp; AV_CODEC_PROP_BITMAP_SUB) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_WARNING, "Codec '%s' is bitmap-based, "</span><br><span class="line">                       "subtitles character encoding will be ignored\n",</span><br><span class="line">                       avctx-&gt;codec_descriptor-&gt;name);</span><br><span class="line">                avctx-&gt;sub_charenc_mode = FF_SUB_CHARENC_MODE_DO_NOTHING;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                /* input character encoding is set for a text based subtitle</span><br><span class="line">                 * codec at this point */</span><br><span class="line">                if (avctx-&gt;sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)</span><br><span class="line">                    avctx-&gt;sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;</span><br><span class="line"></span><br><span class="line">                if (avctx-&gt;sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) &#123;</span><br><span class="line">#if CONFIG_ICONV</span><br><span class="line">                    iconv_t cd = iconv_open("UTF-8", avctx-&gt;sub_charenc);</span><br><span class="line">                    if (cd == (iconv_t)-1) &#123;</span><br><span class="line">                        ret = AVERROR(errno);</span><br><span class="line">                        av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context "</span><br><span class="line">                               "with input character encoding \"%s\"\n", avctx-&gt;sub_charenc);</span><br><span class="line">                        goto free_and_end;</span><br><span class="line">                    &#125;</span><br><span class="line">                    iconv_close(cd);</span><br><span class="line">#else</span><br><span class="line">                    av_log(avctx, AV_LOG_ERROR, "Character encoding subtitles "</span><br><span class="line">                           "conversion needs a libavcodec built with iconv support "</span><br><span class="line">                           "for this codec\n");</span><br><span class="line">                    ret = AVERROR(ENOSYS);</span><br><span class="line">                    goto free_and_end;</span><br><span class="line">#endif</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if FF_API_AVCTX_TIMEBASE</span><br><span class="line">        if (avctx-&gt;framerate.num &gt; 0 &amp;&amp; avctx-&gt;framerate.den &gt; 0)</span><br><span class="line">            avctx-&gt;time_base = av_inv_q(av_mul_q(avctx-&gt;framerate, (AVRational)&#123;avctx-&gt;ticks_per_frame, 1&#125;));</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line">    if (codec-&gt;priv_data_size &gt; 0 &amp;&amp; avctx-&gt;priv_data &amp;&amp; codec-&gt;priv_class) &#123;</span><br><span class="line">        av_assert0(*(const AVClass **)avctx-&gt;priv_data == codec-&gt;priv_class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">    ff_unlock_avcodec(codec);</span><br><span class="line">    if (options) &#123;</span><br><span class="line">        av_dict_free(options);</span><br><span class="line">        *options = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ret;</span><br><span class="line">free_and_end:</span><br><span class="line">    if (avctx-&gt;codec &amp;&amp;</span><br><span class="line">        (avctx-&gt;codec-&gt;caps_internal &amp; FF_CODEC_CAP_INIT_CLEANUP))</span><br><span class="line">        avctx-&gt;codec-&gt;close(avctx);</span><br><span class="line"></span><br><span class="line">    if (codec-&gt;priv_class &amp;&amp; codec-&gt;priv_data_size)</span><br><span class="line">        av_opt_free(avctx-&gt;priv_data);</span><br><span class="line">    av_opt_free(avctx);</span><br><span class="line"></span><br><span class="line">#if FF_API_CODED_FRAME</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    av_frame_free(&amp;avctx-&gt;coded_frame);</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    av_dict_free(&amp;tmp);</span><br><span class="line">    av_freep(&amp;avctx-&gt;priv_data);</span><br><span class="line">    if (avctx-&gt;internal) &#123;</span><br><span class="line">        av_frame_free(&amp;avctx-&gt;internal-&gt;to_free);</span><br><span class="line">        av_frame_free(&amp;avctx-&gt;internal-&gt;compat_decode_frame);</span><br><span class="line">        av_frame_free(&amp;avctx-&gt;internal-&gt;buffer_frame);</span><br><span class="line">        av_packet_free(&amp;avctx-&gt;internal-&gt;buffer_pkt);</span><br><span class="line">        av_packet_free(&amp;avctx-&gt;internal-&gt;last_pkt_props);</span><br><span class="line"></span><br><span class="line">        av_packet_free(&amp;avctx-&gt;internal-&gt;ds.in_pkt);</span><br><span class="line"></span><br><span class="line">        av_freep(&amp;avctx-&gt;internal-&gt;pool);</span><br><span class="line">    &#125;</span><br><span class="line">    av_freep(&amp;avctx-&gt;internal);</span><br><span class="line">    avctx-&gt;codec = NULL;</span><br><span class="line">    goto end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中最主要是调用了 AVCodec 的 init() 初始化，其他还做的有：</p>
<ul>
<li>为各种结构体分配内存 <code>av_malloc()</code></li>
<li>将输入的 AVDictionary 形式的选项设置到 AVCodecContext</li>
<li>一系列检查，比如采样率，宽高等</li>
<li>如果是编码器，检查输入参数是否符合编码器的要求</li>
</ul>
<h3 id="av-codec-is-encoder"><a href="#av-codec-is-encoder" class="headerlink" title="av_codec_is_encoder"></a>av_codec_is_encoder</h3><p>当满足了 <code>av_codec_is_encoder()</code> 满足的情况下，进行了参数是否满足编码器规范要求的检查，如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (avctx-&gt;codec-&gt;pix_fmts) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; avctx-&gt;codec-&gt;pix_fmts[i] != AV_PIX_FMT_NONE; i++)</span><br><span class="line">        <span class="keyword">if</span> (avctx-&gt;pix_fmt == avctx-&gt;codec-&gt;pix_fmts[i])</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_NONE</span><br><span class="line">        &amp;&amp; !((avctx-&gt;codec_id == AV_CODEC_ID_MJPEG || avctx-&gt;codec_id == AV_CODEC_ID_LJPEG)</span><br><span class="line">             &amp;&amp; avctx-&gt;strict_std_compliance &lt;= FF_COMPLIANCE_UNOFFICIAL)) &#123;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"%d"</span>, avctx-&gt;pix_fmt);</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR, <span class="string">"Specified pixel format %s is invalid or not supported\n"</span>,</span><br><span class="line">               (<span class="keyword">char</span> *)av_x_if_null(av_get_pix_fmt_name(avctx-&gt;pix_fmt), buf));</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        <span class="keyword">goto</span> free_and_end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ420P ||</span><br><span class="line">        avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ411P ||</span><br><span class="line">        avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ422P ||</span><br><span class="line">        avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ440P ||</span><br><span class="line">        avctx-&gt;codec-&gt;pix_fmts[i] == AV_PIX_FMT_YUVJ444P)</span><br><span class="line">        avctx-&gt;color_range = AVCOL_RANGE_JPEG;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 AVCodecContext 中的 pix_fmt 与编码器 AVCodec 中的 pix_fmts 数组中的元素进行对比，其中 AVCodec 中的 pix_fmts 数组存储了该种编码器支持的像素格式，并且规定以 AV_PIX_FMT_NONE（AV_PIX_FMT_NONE 取值为 - 1）为结尾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">enum</span> AVPixelFormat pix_fmts_8bit[] = &#123;</span><br><span class="line">    AV_PIX_FMT_YUV420P,</span><br><span class="line">    AV_PIX_FMT_YUVJ420P,</span><br><span class="line">    AV_PIX_FMT_YUV422P,</span><br><span class="line">    AV_PIX_FMT_YUVJ422P,</span><br><span class="line">    AV_PIX_FMT_YUV444P,</span><br><span class="line">    AV_PIX_FMT_YUVJ444P,</span><br><span class="line">    AV_PIX_FMT_NV12,</span><br><span class="line">    AV_PIX_FMT_NV16,</span><br><span class="line">    AV_PIX_FMT_NONE</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以 libx264 的 pix_fmts 数组为例，从 pix_fmts_8bit 的定义可以看出 libx264 主要支持的是以 YUV 为主的像素格式</p>
<h2 id="avctx-gt-codec-gt-init"><a href="#avctx-gt-codec-gt-init" class="headerlink" title="avctx-&gt;codec-&gt;init"></a>avctx-&gt;codec-&gt;init</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">AVCodec ff_libx264_encoder = &#123;</span><br><span class="line">    .name             = <span class="string">"libx264"</span>,</span><br><span class="line">    .long_name        = NULL_IF_CONFIG_SMALL(<span class="string">"libx264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10"</span>),</span><br><span class="line">    .type             = AVMEDIA_TYPE_VIDEO,</span><br><span class="line">    .id               = AV_CODEC_ID_H264,</span><br><span class="line">    .priv_data_size   = <span class="keyword">sizeof</span>(X264Context),</span><br><span class="line">    .init             = X264_init,</span><br><span class="line">    .encode2          = X264_frame,</span><br><span class="line">    .close            = X264_close,</span><br><span class="line">    .capabilities     = AV_CODEC_CAP_DELAY | AV_CODEC_CAP_AUTO_THREADS,</span><br><span class="line">    .priv_class       = &amp;x264_class,</span><br><span class="line">    .defaults         = x264_defaults,</span><br><span class="line">    .init_static_data = X264_init_static,</span><br><span class="line">    .caps_internal    = FF_CODEC_CAP_INIT_THREADSAFE |</span><br><span class="line">                        FF_CODEC_CAP_INIT_CLEANUP,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以 libx264 为例，<code>init</code> 方法对应的是 <code>X264_init</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line">static av_cold int X264_init(AVCodecContext *avctx)</span><br><span class="line">&#123;</span><br><span class="line">    X264Context *x4 = avctx-&gt;priv_data;</span><br><span class="line">    AVCPBProperties *cpb_props;</span><br><span class="line">    int sw,sh;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;global_quality &gt; 0)</span><br><span class="line">        av_log(avctx, AV_LOG_WARNING, "-qscale is ignored, -crf is recommended.\n");</span><br><span class="line"></span><br><span class="line">#if CONFIG_LIBX262_ENCODER</span><br><span class="line">    if (avctx-&gt;codec_id == AV_CODEC_ID_MPEG2VIDEO) &#123;</span><br><span class="line">        x4-&gt;params.b_mpeg2 = 1;</span><br><span class="line">        x264_param_default_mpeg2(&amp;x4-&gt;params);</span><br><span class="line">    &#125; else</span><br><span class="line">#endif</span><br><span class="line">    x264_param_default(&amp;x4-&gt;params);</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.b_deblocking_filter         = avctx-&gt;flags &amp; AV_CODEC_FLAG_LOOP_FILTER;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;preset || x4-&gt;tune)</span><br><span class="line">        if (x264_param_default_preset(&amp;x4-&gt;params, x4-&gt;preset, x4-&gt;tune) &lt; 0) &#123;</span><br><span class="line">            int i;</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR, "Error setting preset/tune %s/%s.\n", x4-&gt;preset, x4-&gt;tune);</span><br><span class="line">            av_log(avctx, AV_LOG_INFO, "Possible presets:");</span><br><span class="line">            for (i = 0; x264_preset_names[i]; i++)</span><br><span class="line">                av_log(avctx, AV_LOG_INFO, " %s", x264_preset_names[i]);</span><br><span class="line">            av_log(avctx, AV_LOG_INFO, "\n");</span><br><span class="line">            av_log(avctx, AV_LOG_INFO, "Possible tunes:");</span><br><span class="line">            for (i = 0; x264_tune_names[i]; i++)</span><br><span class="line">                av_log(avctx, AV_LOG_INFO, " %s", x264_tune_names[i]);</span><br><span class="line">            av_log(avctx, AV_LOG_INFO, "\n");</span><br><span class="line">            return AVERROR(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;level &gt; 0)</span><br><span class="line">        x4-&gt;params.i_level_idc = avctx-&gt;level;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.pf_log               = X264_log;</span><br><span class="line">    x4-&gt;params.p_log_private        = avctx;</span><br><span class="line">    x4-&gt;params.i_log_level          = X264_LOG_DEBUG;</span><br><span class="line">    x4-&gt;params.i_csp                = convert_pix_fmt(avctx-&gt;pix_fmt);</span><br><span class="line"></span><br><span class="line">    PARSE_X264_OPT("weightp", wpredp);</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;bit_rate) &#123;</span><br><span class="line">        x4-&gt;params.rc.i_bitrate   = avctx-&gt;bit_rate / 1000;</span><br><span class="line">        x4-&gt;params.rc.i_rc_method = X264_RC_ABR;</span><br><span class="line">    &#125;</span><br><span class="line">    x4-&gt;params.rc.i_vbv_buffer_size = avctx-&gt;rc_buffer_size / 1000;</span><br><span class="line">    x4-&gt;params.rc.i_vbv_max_bitrate = avctx-&gt;rc_max_rate    / 1000;</span><br><span class="line">    x4-&gt;params.rc.b_stat_write      = avctx-&gt;flags &amp; AV_CODEC_FLAG_PASS1;</span><br><span class="line">    if (avctx-&gt;flags &amp; AV_CODEC_FLAG_PASS2) &#123;</span><br><span class="line">        x4-&gt;params.rc.b_stat_read = 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (x4-&gt;crf &gt;= 0) &#123;</span><br><span class="line">            x4-&gt;params.rc.i_rc_method   = X264_RC_CRF;</span><br><span class="line">            x4-&gt;params.rc.f_rf_constant = x4-&gt;crf;</span><br><span class="line">        &#125; else if (x4-&gt;cqp &gt;= 0) &#123;</span><br><span class="line">            x4-&gt;params.rc.i_rc_method   = X264_RC_CQP;</span><br><span class="line">            x4-&gt;params.rc.i_qp_constant = x4-&gt;cqp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (x4-&gt;crf_max &gt;= 0)</span><br><span class="line">            x4-&gt;params.rc.f_rf_constant_max = x4-&gt;crf_max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;rc_buffer_size &amp;&amp; avctx-&gt;rc_initial_buffer_occupancy &gt; 0 &amp;&amp;</span><br><span class="line">        (avctx-&gt;rc_initial_buffer_occupancy &lt;= avctx-&gt;rc_buffer_size)) &#123;</span><br><span class="line">        x4-&gt;params.rc.f_vbv_buffer_init =</span><br><span class="line">            (float)avctx-&gt;rc_initial_buffer_occupancy / avctx-&gt;rc_buffer_size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PARSE_X264_OPT("level", level);</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;i_quant_factor &gt; 0)</span><br><span class="line">        x4-&gt;params.rc.f_ip_factor         = 1 / fabs(avctx-&gt;i_quant_factor);</span><br><span class="line">    if (avctx-&gt;b_quant_factor &gt; 0)</span><br><span class="line">        x4-&gt;params.rc.f_pb_factor         = avctx-&gt;b_quant_factor;</span><br><span class="line"></span><br><span class="line">#if FF_API_PRIVATE_OPT</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    if (avctx-&gt;chromaoffset &gt;= 0)</span><br><span class="line">        x4-&gt;chroma_offset = avctx-&gt;chromaoffset;</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line">    if (x4-&gt;chroma_offset &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_chroma_qp_offset = x4-&gt;chroma_offset;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;gop_size &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_keyint_max         = avctx-&gt;gop_size;</span><br><span class="line">    if (avctx-&gt;max_b_frames &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_bframe             = avctx-&gt;max_b_frames;</span><br><span class="line"></span><br><span class="line">#if FF_API_PRIVATE_OPT</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    if (avctx-&gt;scenechange_threshold &gt;= 0)</span><br><span class="line">        x4-&gt;scenechange_threshold = avctx-&gt;scenechange_threshold;</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line">    if (x4-&gt;scenechange_threshold &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_scenecut_threshold = x4-&gt;scenechange_threshold;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;qmin &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.i_qp_min          = avctx-&gt;qmin;</span><br><span class="line">    if (avctx-&gt;qmax &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.i_qp_max          = avctx-&gt;qmax;</span><br><span class="line">    if (avctx-&gt;max_qdiff &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.i_qp_step         = avctx-&gt;max_qdiff;</span><br><span class="line">    if (avctx-&gt;qblur &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.f_qblur           = avctx-&gt;qblur;     /* temporally blur quants */</span><br><span class="line">    if (avctx-&gt;qcompress &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.f_qcompress       = avctx-&gt;qcompress; /* 0.0 =&gt; cbr, 1.0 =&gt; constant qp */</span><br><span class="line">    if (avctx-&gt;refs &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_frame_reference    = avctx-&gt;refs;</span><br><span class="line">    else if (x4-&gt;level) &#123;</span><br><span class="line">        int i;</span><br><span class="line">        int mbn = AV_CEIL_RSHIFT(avctx-&gt;width, 4) * AV_CEIL_RSHIFT(avctx-&gt;height, 4);</span><br><span class="line">        int level_id = -1;</span><br><span class="line">        char *tail;</span><br><span class="line">        int scale = X264_BUILD &lt; 129 ? 384 : 1;</span><br><span class="line"></span><br><span class="line">        if (!strcmp(x4-&gt;level, "1b")) &#123;</span><br><span class="line">            level_id = 9;</span><br><span class="line">        &#125; else if (strlen(x4-&gt;level) &lt;= 3)&#123;</span><br><span class="line">            level_id = av_strtod(x4-&gt;level, &amp;tail) * 10 + 0.5;</span><br><span class="line">            if (*tail)</span><br><span class="line">                level_id = -1;</span><br><span class="line">        &#125;</span><br><span class="line">        if (level_id &lt;= 0)</span><br><span class="line">            av_log(avctx, AV_LOG_WARNING, "Failed to parse level\n");</span><br><span class="line"></span><br><span class="line">        for (i = 0; i&lt;x264_levels[i].level_idc; i++)</span><br><span class="line">            if (x264_levels[i].level_idc == level_id)</span><br><span class="line">                x4-&gt;params.i_frame_reference = av_clip(x264_levels[i].dpb / mbn / scale, 1, x4-&gt;params.i_frame_reference);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;trellis &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_trellis    = avctx-&gt;trellis;</span><br><span class="line">    if (avctx-&gt;me_range &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_me_range   = avctx-&gt;me_range;</span><br><span class="line">#if FF_API_PRIVATE_OPT</span><br><span class="line">    FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    if (avctx-&gt;noise_reduction &gt;= 0)</span><br><span class="line">        x4-&gt;noise_reduction = avctx-&gt;noise_reduction;</span><br><span class="line">    FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line">    if (x4-&gt;noise_reduction &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_noise_reduction = x4-&gt;noise_reduction;</span><br><span class="line">    if (avctx-&gt;me_subpel_quality &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_subpel_refine   = avctx-&gt;me_subpel_quality;</span><br><span class="line">#if FF_API_PRIVATE_OPT</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    if (avctx-&gt;b_frame_strategy &gt;= 0)</span><br><span class="line">        x4-&gt;b_frame_strategy = avctx-&gt;b_frame_strategy;</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line">    if (avctx-&gt;keyint_min &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_keyint_min = avctx-&gt;keyint_min;</span><br><span class="line">#if FF_API_CODER_TYPE</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    if (avctx-&gt;coder_type &gt;= 0)</span><br><span class="line">        x4-&gt;coder = avctx-&gt;coder_type == FF_CODER_TYPE_AC;</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line">    if (avctx-&gt;me_cmp &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_chroma_me = avctx-&gt;me_cmp &amp; FF_CMP_CHROMA;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;aq_mode &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.i_aq_mode = x4-&gt;aq_mode;</span><br><span class="line">    if (x4-&gt;aq_strength &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.f_aq_strength = x4-&gt;aq_strength;</span><br><span class="line">    PARSE_X264_OPT("psy-rd", psy_rd);</span><br><span class="line">    PARSE_X264_OPT("deblock", deblock);</span><br><span class="line">    PARSE_X264_OPT("partitions", partitions);</span><br><span class="line">    PARSE_X264_OPT("stats", stats);</span><br><span class="line">    if (x4-&gt;psy &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_psy  = x4-&gt;psy;</span><br><span class="line">    if (x4-&gt;rc_lookahead &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.i_lookahead = x4-&gt;rc_lookahead;</span><br><span class="line">    if (x4-&gt;weightp &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_weighted_pred = x4-&gt;weightp;</span><br><span class="line">    if (x4-&gt;weightb &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_weighted_bipred = x4-&gt;weightb;</span><br><span class="line">    if (x4-&gt;cplxblur &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.f_complexity_blur = x4-&gt;cplxblur;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;ssim &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_ssim = x4-&gt;ssim;</span><br><span class="line">    if (x4-&gt;intra_refresh &gt;= 0)</span><br><span class="line">        x4-&gt;params.b_intra_refresh = x4-&gt;intra_refresh;</span><br><span class="line">    if (x4-&gt;bluray_compat &gt;= 0) &#123;</span><br><span class="line">        x4-&gt;params.b_bluray_compat = x4-&gt;bluray_compat;</span><br><span class="line">        x4-&gt;params.b_vfr_input = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (x4-&gt;avcintra_class &gt;= 0)</span><br><span class="line">#if X264_BUILD &gt;= 142</span><br><span class="line">        x4-&gt;params.i_avcintra_class = x4-&gt;avcintra_class;</span><br><span class="line">#else</span><br><span class="line">        av_log(avctx, AV_LOG_ERROR,</span><br><span class="line">               "x264 too old for AVC Intra, at least version 142 needed\n");</span><br><span class="line">#endif</span><br><span class="line">    if (x4-&gt;b_bias != INT_MIN)</span><br><span class="line">        x4-&gt;params.i_bframe_bias              = x4-&gt;b_bias;</span><br><span class="line">    if (x4-&gt;b_pyramid &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_bframe_pyramid = x4-&gt;b_pyramid;</span><br><span class="line">    if (x4-&gt;mixed_refs &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_mixed_references = x4-&gt;mixed_refs;</span><br><span class="line">    if (x4-&gt;dct8x8 &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_transform_8x8    = x4-&gt;dct8x8;</span><br><span class="line">    if (x4-&gt;fast_pskip &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.b_fast_pskip       = x4-&gt;fast_pskip;</span><br><span class="line">    if (x4-&gt;aud &gt;= 0)</span><br><span class="line">        x4-&gt;params.b_aud                      = x4-&gt;aud;</span><br><span class="line">    if (x4-&gt;mbtree &gt;= 0)</span><br><span class="line">        x4-&gt;params.rc.b_mb_tree               = x4-&gt;mbtree;</span><br><span class="line">    if (x4-&gt;direct_pred &gt;= 0)</span><br><span class="line">        x4-&gt;params.analyse.i_direct_mv_pred   = x4-&gt;direct_pred;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;slice_max_size &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_slice_max_size =  x4-&gt;slice_max_size;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;fastfirstpass)</span><br><span class="line">        x264_param_apply_fastfirstpass(&amp;x4-&gt;params);</span><br><span class="line"></span><br><span class="line">    /* Allow specifying the x264 profile through AVCodecContext. */</span><br><span class="line">    if (!x4-&gt;profile)</span><br><span class="line">        switch (avctx-&gt;profile) &#123;</span><br><span class="line">        case FF_PROFILE_H264_BASELINE:</span><br><span class="line">            x4-&gt;profile = av_strdup("baseline");</span><br><span class="line">            break;</span><br><span class="line">        case FF_PROFILE_H264_HIGH:</span><br><span class="line">            x4-&gt;profile = av_strdup("high");</span><br><span class="line">            break;</span><br><span class="line">        case FF_PROFILE_H264_HIGH_10:</span><br><span class="line">            x4-&gt;profile = av_strdup("high10");</span><br><span class="line">            break;</span><br><span class="line">        case FF_PROFILE_H264_HIGH_422:</span><br><span class="line">            x4-&gt;profile = av_strdup("high422");</span><br><span class="line">            break;</span><br><span class="line">        case FF_PROFILE_H264_HIGH_444:</span><br><span class="line">            x4-&gt;profile = av_strdup("high444");</span><br><span class="line">            break;</span><br><span class="line">        case FF_PROFILE_H264_MAIN:</span><br><span class="line">            x4-&gt;profile = av_strdup("main");</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;nal_hrd &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_nal_hrd = x4-&gt;nal_hrd;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;motion_est &gt;= 0) &#123;</span><br><span class="line">        x4-&gt;params.analyse.i_me_method = x4-&gt;motion_est;</span><br><span class="line">#if FF_API_MOTION_EST</span><br><span class="line">FF_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (avctx-&gt;me_method == ME_EPZS)</span><br><span class="line">            x4-&gt;params.analyse.i_me_method = X264_ME_DIA;</span><br><span class="line">        else if (avctx-&gt;me_method == ME_HEX)</span><br><span class="line">            x4-&gt;params.analyse.i_me_method = X264_ME_HEX;</span><br><span class="line">        else if (avctx-&gt;me_method == ME_UMH)</span><br><span class="line">            x4-&gt;params.analyse.i_me_method = X264_ME_UMH;</span><br><span class="line">        else if (avctx-&gt;me_method == ME_FULL)</span><br><span class="line">            x4-&gt;params.analyse.i_me_method = X264_ME_ESA;</span><br><span class="line">        else if (avctx-&gt;me_method == ME_TESA)</span><br><span class="line">            x4-&gt;params.analyse.i_me_method = X264_ME_TESA;</span><br><span class="line">FF_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;coder &gt;= 0)</span><br><span class="line">        x4-&gt;params.b_cabac = x4-&gt;coder;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;b_frame_strategy &gt;= 0)</span><br><span class="line">        x4-&gt;params.i_bframe_adaptive = x4-&gt;b_frame_strategy;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;profile)</span><br><span class="line">        if (x264_param_apply_profile(&amp;x4-&gt;params, x4-&gt;profile) &lt; 0) &#123;</span><br><span class="line">            int i;</span><br><span class="line">            av_log(avctx, AV_LOG_ERROR, "Error setting profile %s.\n", x4-&gt;profile);</span><br><span class="line">            av_log(avctx, AV_LOG_INFO, "Possible profiles:");</span><br><span class="line">            for (i = 0; x264_profile_names[i]; i++)</span><br><span class="line">                av_log(avctx, AV_LOG_INFO, " %s", x264_profile_names[i]);</span><br><span class="line">            av_log(avctx, AV_LOG_INFO, "\n");</span><br><span class="line">            return AVERROR(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.i_width          = avctx-&gt;width;</span><br><span class="line">    x4-&gt;params.i_height         = avctx-&gt;height;</span><br><span class="line">    av_reduce(&amp;sw, &amp;sh, avctx-&gt;sample_aspect_ratio.num, avctx-&gt;sample_aspect_ratio.den, 4096);</span><br><span class="line">    x4-&gt;params.vui.i_sar_width  = sw;</span><br><span class="line">    x4-&gt;params.vui.i_sar_height = sh;</span><br><span class="line">    x4-&gt;params.i_timebase_den = avctx-&gt;time_base.den;</span><br><span class="line">    x4-&gt;params.i_timebase_num = avctx-&gt;time_base.num;</span><br><span class="line">    x4-&gt;params.i_fps_num = avctx-&gt;time_base.den;</span><br><span class="line">    x4-&gt;params.i_fps_den = avctx-&gt;time_base.num * avctx-&gt;ticks_per_frame;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.analyse.b_psnr = avctx-&gt;flags &amp; AV_CODEC_FLAG_PSNR;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.i_threads      = avctx-&gt;thread_count;</span><br><span class="line">    if (avctx-&gt;thread_type)</span><br><span class="line">        x4-&gt;params.b_sliced_threads = avctx-&gt;thread_type == FF_THREAD_SLICE;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.b_interlaced   = avctx-&gt;flags &amp; AV_CODEC_FLAG_INTERLACED_DCT;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.b_open_gop     = !(avctx-&gt;flags &amp; AV_CODEC_FLAG_CLOSED_GOP);</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.i_slice_count  = avctx-&gt;slices;</span><br><span class="line"></span><br><span class="line">    x4-&gt;params.vui.b_fullrange = avctx-&gt;pix_fmt == AV_PIX_FMT_YUVJ420P ||</span><br><span class="line">                                 avctx-&gt;pix_fmt == AV_PIX_FMT_YUVJ422P ||</span><br><span class="line">                                 avctx-&gt;pix_fmt == AV_PIX_FMT_YUVJ444P ||</span><br><span class="line">                                 avctx-&gt;color_range == AVCOL_RANGE_JPEG;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;colorspace != AVCOL_SPC_UNSPECIFIED)</span><br><span class="line">        x4-&gt;params.vui.i_colmatrix = avctx-&gt;colorspace;</span><br><span class="line">    if (avctx-&gt;color_primaries != AVCOL_PRI_UNSPECIFIED)</span><br><span class="line">        x4-&gt;params.vui.i_colorprim = avctx-&gt;color_primaries;</span><br><span class="line">    if (avctx-&gt;color_trc != AVCOL_TRC_UNSPECIFIED)</span><br><span class="line">        x4-&gt;params.vui.i_transfer  = avctx-&gt;color_trc;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;flags &amp; AV_CODEC_FLAG_GLOBAL_HEADER)</span><br><span class="line">        x4-&gt;params.b_repeat_headers = 0;</span><br><span class="line"></span><br><span class="line">    if(x4-&gt;x264opts)&#123;</span><br><span class="line">        const char *p= x4-&gt;x264opts;</span><br><span class="line">        while(p)&#123;</span><br><span class="line">            char param[4096]=&#123;0&#125;, val[4096]=&#123;0&#125;;</span><br><span class="line">            if(sscanf(p, "%4095[^:=]=%4095[^:]", param, val) == 1)&#123;</span><br><span class="line">                OPT_STR(param, "1");</span><br><span class="line">            &#125;else</span><br><span class="line">                OPT_STR(param, val);</span><br><span class="line">            p= strchr(p, ':');</span><br><span class="line">            p+=!!p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (x4-&gt;x264_params) &#123;</span><br><span class="line">        AVDictionary *dict    = NULL;</span><br><span class="line">        AVDictionaryEntry *en = NULL;</span><br><span class="line"></span><br><span class="line">        if (!av_dict_parse_string(&amp;dict, x4-&gt;x264_params, "=", ":", 0)) &#123;</span><br><span class="line">            while ((en = av_dict_get(dict, "", en, AV_DICT_IGNORE_SUFFIX))) &#123;</span><br><span class="line">                if (x264_param_parse(&amp;x4-&gt;params, en-&gt;key, en-&gt;value) &lt; 0)</span><br><span class="line">                    av_log(avctx, AV_LOG_WARNING,</span><br><span class="line">                           "Error parsing option '%s = %s'.\n",</span><br><span class="line">                            en-&gt;key, en-&gt;value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            av_dict_free(&amp;dict);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // update AVCodecContext with x264 parameters</span><br><span class="line">    avctx-&gt;has_b_frames = x4-&gt;params.i_bframe ?</span><br><span class="line">        x4-&gt;params.i_bframe_pyramid ? 2 : 1 : 0;</span><br><span class="line">    if (avctx-&gt;max_b_frames &lt; 0)</span><br><span class="line">        avctx-&gt;max_b_frames = 0;</span><br><span class="line"></span><br><span class="line">    avctx-&gt;bit_rate = x4-&gt;params.rc.i_bitrate*1000;</span><br><span class="line"></span><br><span class="line">    x4-&gt;enc = x264_encoder_open(&amp;x4-&gt;params);</span><br><span class="line">    if (!x4-&gt;enc)</span><br><span class="line">        return AVERROR_EXTERNAL;</span><br><span class="line"></span><br><span class="line">    if (avctx-&gt;flags &amp; AV_CODEC_FLAG_GLOBAL_HEADER) &#123;</span><br><span class="line">        x264_nal_t *nal;</span><br><span class="line">        uint8_t *p;</span><br><span class="line">        int nnal, s, i;</span><br><span class="line"></span><br><span class="line">        s = x264_encoder_headers(x4-&gt;enc, &amp;nal, &amp;nnal);</span><br><span class="line">        avctx-&gt;extradata = p = av_mallocz(s + AV_INPUT_BUFFER_PADDING_SIZE);</span><br><span class="line">        if (!p)</span><br><span class="line">            return AVERROR(ENOMEM);</span><br><span class="line"></span><br><span class="line">        for (i = 0; i &lt; nnal; i++) &#123;</span><br><span class="line">            /* Don't put the SEI in extradata. */</span><br><span class="line">            if (nal[i].i_type == NAL_SEI) &#123;</span><br><span class="line">                av_log(avctx, AV_LOG_INFO, "%s\n", nal[i].p_payload+25);</span><br><span class="line">                x4-&gt;sei_size = nal[i].i_payload;</span><br><span class="line">                x4-&gt;sei      = av_malloc(x4-&gt;sei_size);</span><br><span class="line">                if (!x4-&gt;sei)</span><br><span class="line">                    return AVERROR(ENOMEM);</span><br><span class="line">                memcpy(x4-&gt;sei, nal[i].p_payload, nal[i].i_payload);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            memcpy(p, nal[i].p_payload, nal[i].i_payload);</span><br><span class="line">            p += nal[i].i_payload;</span><br><span class="line">        &#125;</span><br><span class="line">        avctx-&gt;extradata_size = p - avctx-&gt;extradata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cpb_props = ff_add_cpb_side_data(avctx);</span><br><span class="line">    if (!cpb_props)</span><br><span class="line">        return AVERROR(ENOMEM);</span><br><span class="line">    cpb_props-&gt;buffer_size = x4-&gt;params.rc.i_vbv_buffer_size * 1000;</span><br><span class="line">    cpb_props-&gt;max_bitrate = x4-&gt;params.rc.i_vbv_max_bitrate * 1000;</span><br><span class="line">    cpb_props-&gt;avg_bitrate = x4-&gt;params.rc.i_bitrate         * 1000;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大概的工作</p>
<ul>
<li>设置 X264Context 的参数。X264Context 主要完成了 libx264 和 FFmpeg 对接的功能。可以看出代码主要在设置一个 params 结构体变量，该变量的类型即是 x264 中存储参数的结构体 x264_param_t。</li>
<li>调用 libx264 的 API 进行编码器的初始化工作。例如调用 x264_param_default() 设置默认参数，调用 x264_param_apply_profile() 设置 profile，调用 x264_encoder_open() 打开编码器等等。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://me.csdn.net/leixiaohua1020" target="_blank" rel="external">雷霄骅 - FFMPEG</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/03/09/ijkplayer-ffmpeg-av-read-frame/" class="prev">上一篇</a><a href="/2019/02/24/ijkplayer-ffmpeg-avformat-find-stream-info/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yydcdut.com">yydcdut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>