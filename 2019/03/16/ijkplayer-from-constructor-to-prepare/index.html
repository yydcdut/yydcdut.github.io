<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ijkplayer框架简析 -- 从构造到 onPrepared · Android杂文 - yydcdut</title><meta name="description" content="ijkplayer框架简析 -- 从构造到 onPrepared - yydcdut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yydcdut.com/atom.xml" title="Android杂文 - yydcdut"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut/yydcdut.github.io/issues" target="_blank" class="nav-list-link">COMMENT</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ijkplayer框架简析 -- 从构造到 onPrepared</h1><div class="post-info">2019年3月16日</div><div class="post-content"><p>从本文开始讲解 ijkplayer 相关的，本篇主要将播放器从初始化到 <code>onPrepared</code> 回调回来之间的操作</p>
<a id="more"></a>
<h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title">AbstractMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Default library loader</span><br><span class="line">     * Load them by yourself, if your libraries are not installed at default place.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IjkLibLoader sLocalLibLoader = <span class="keyword">new</span> IjkLibLoader() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadLibrary</span><span class="params">(String libName)</span> <span class="keyword">throws</span> UnsatisfiedLinkError, SecurityException </span>&#123;</span><br><span class="line">            System.loadLibrary(libName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Default constructor. Consider using one of the create() methods for</span><br><span class="line">     * synchronously instantiating a IjkMediaPlayer from a Uri or resource.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * When done with the IjkMediaPlayer, you should call &#123;<span class="doctag">@link</span> #release()&#125;, to</span><br><span class="line">     * free the resources. If not released, too many IjkMediaPlayer instances</span><br><span class="line">     * may result in an exception.</span><br><span class="line">     * &lt;/p&gt;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IjkMediaPlayer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(sLocalLibLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * do not loadLibaray</span><br><span class="line">     * <span class="doctag">@param</span> libLoader</span><br><span class="line">     *              custom library loader, can be null.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IjkMediaPlayer</span><span class="params">(IjkLibLoader libLoader)</span> </span>&#123;</span><br><span class="line">        initPlayer(libLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPlayer</span><span class="params">(IjkLibLoader libLoader)</span> </span>&#123;</span><br><span class="line">        loadLibrariesOnce(libLoader);</span><br><span class="line">        initNativeOnce();</span><br><span class="line"></span><br><span class="line">        Looper looper;</span><br><span class="line">        <span class="keyword">if</span> ((looper = Looper.myLooper()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mEventHandler = <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>, looper);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((looper = Looper.getMainLooper()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mEventHandler = <span class="keyword">new</span> EventHandler(<span class="keyword">this</span>, looper);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mEventHandler = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * Native setup requires a weak reference to our object. It's easier to</span><br><span class="line">         * create it here than in C++.</span><br><span class="line">         */</span></span><br><span class="line">        native_setup(<span class="keyword">new</span> WeakReference&lt;IjkMediaPlayer&gt;(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在构造方法的 <code>initPlayer()</code> 方法中，一次调用了 <code>loadLibrariesOnce()</code> 、 <code>initNativeOnce()</code> 、 创建 Looper 和 <code>native_setup</code></p>
<h3 id="loadLibrariesOnce"><a href="#loadLibrariesOnce" class="headerlink" title="loadLibrariesOnce"></a>loadLibrariesOnce</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title">AbstractMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mIsLibLoaded = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadLibrariesOnce</span><span class="params">(IjkLibLoader libLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (IjkMediaPlayer.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mIsLibLoaded) &#123;</span><br><span class="line">                <span class="keyword">if</span> (libLoader == <span class="keyword">null</span>)</span><br><span class="line">                    libLoader = sLocalLibLoader;</span><br><span class="line"></span><br><span class="line">                libLoader.loadLibrary(<span class="string">"ijkffmpeg"</span>);</span><br><span class="line">                libLoader.loadLibrary(<span class="string">"ijksdl"</span>);</span><br><span class="line">                libLoader.loadLibrary(<span class="string">"ijkplayer"</span>);</span><br><span class="line">                mIsLibLoaded = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>loadLibrariesOnce()</code> 中通过调用 IjkLibLoader 的 <code>loadLibrary()</code> 方法来加载 ijkplayer 的三个 so 库，最终是通过调用 <code>System.loadLibrary()</code> 来加载的 so</p>
<p>同时在 native 层与 java 方法的对应是通过 <code>JNI_OnLoad()</code> 来匹配的，卸载时会调用 <code>JNI_UnLoad()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    g_jvm = vm;</span><br><span class="line">    <span class="keyword">if</span> ((*vm)-&gt;GetEnv(vm, (<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(env != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;g_clazz.mutex, <span class="literal">NULL</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FindClass returns LocalReference</span></span><br><span class="line">    IJK_FIND_JAVA_CLASS(env, g_clazz.clazz, JNI_CLASS_IJKPLAYER);</span><br><span class="line">    (*env)-&gt;RegisterNatives(env, g_clazz.clazz, g_methods, NELEM(g_methods) );</span><br><span class="line"></span><br><span class="line">    ijkmp_global_init();</span><br><span class="line">    ijkmp_global_set_inject_callback(inject_callback);</span><br><span class="line"></span><br><span class="line">    FFmpegApi_global_init(env);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> <span class="title">JNI_OnUnload</span><span class="params">(JavaVM *jvm, <span class="keyword">void</span> *reserved)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    ijkmp_global_uninit();</span><br><span class="line"></span><br><span class="line">    pthread_mutex_destroy(&amp;g_clazz.mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先 <code>RegisterNatives</code> 注册 <code>g_methods</code> 中的 native 方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod g_methods[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"_setDataSource"</span>,</span><br><span class="line">        <span class="string">"(Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/String;)V"</span>,</span><br><span class="line">        (<span class="keyword">void</span> *) IjkMediaPlayer_setDataSourceAndHeaders</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="string">"_setDataSourceFd"</span>,       <span class="string">"(I)V"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_setDataSourceFd &#125;,</span><br><span class="line">    &#123; <span class="string">"_setDataSource"</span>,         <span class="string">"(Ltv/danmaku/ijk/media/player/misc/IMediaDataSource;)V"</span>, (<span class="keyword">void</span> *)IjkMediaPlayer_setDataSourceCallback &#125;,</span><br><span class="line">    &#123; <span class="string">"_setAndroidIOCallback"</span>,  <span class="string">"(Ltv/danmaku/ijk/media/player/misc/IAndroidIO;)V"</span>, (<span class="keyword">void</span> *)IjkMediaPlayer_setAndroidIOCallback &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_setVideoSurface"</span>,       <span class="string">"(Landroid/view/Surface;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setVideoSurface &#125;,</span><br><span class="line">    &#123; <span class="string">"_prepareAsync"</span>,          <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_prepareAsync &#125;,</span><br><span class="line">    &#123; <span class="string">"_start"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_start &#125;,</span><br><span class="line">    &#123; <span class="string">"_stop"</span>,                  <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_stop &#125;,</span><br><span class="line">    &#123; <span class="string">"seekTo"</span>,                 <span class="string">"(J)V"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_seekTo &#125;,</span><br><span class="line">    &#123; <span class="string">"_pause"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_pause &#125;,</span><br><span class="line">    &#123; <span class="string">"isPlaying"</span>,              <span class="string">"()Z"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_isPlaying &#125;,</span><br><span class="line">    &#123; <span class="string">"getCurrentPosition"</span>,     <span class="string">"()J"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getCurrentPosition &#125;,</span><br><span class="line">    &#123; <span class="string">"getDuration"</span>,            <span class="string">"()J"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getDuration &#125;,</span><br><span class="line">    &#123; <span class="string">"_release"</span>,               <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_release &#125;,</span><br><span class="line">    &#123; <span class="string">"_reset"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_reset &#125;,</span><br><span class="line">    &#123; <span class="string">"setVolume"</span>,              <span class="string">"(FF)V"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_setVolume &#125;,</span><br><span class="line">    &#123; <span class="string">"getAudioSessionId"</span>,      <span class="string">"()I"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getAudioSessionId &#125;,</span><br><span class="line">    &#123; <span class="string">"native_init"</span>,            <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_native_init &#125;,</span><br><span class="line">    &#123; <span class="string">"native_setup"</span>,           <span class="string">"(Ljava/lang/Object;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_native_setup &#125;,</span><br><span class="line">    &#123; <span class="string">"native_finalize"</span>,        <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_native_finalize &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_setOption"</span>,             <span class="string">"(ILjava/lang/String;Ljava/lang/String;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setOption &#125;,</span><br><span class="line">    &#123; <span class="string">"_setOption"</span>,             <span class="string">"(ILjava/lang/String;J)V"</span>,                  (<span class="keyword">void</span> *) IjkMediaPlayer_setOptionLong &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_getColorFormatName"</span>,    <span class="string">"(I)Ljava/lang/String;"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_getColorFormatName &#125;,</span><br><span class="line">    &#123; <span class="string">"_getVideoCodecInfo"</span>,     <span class="string">"()Ljava/lang/String;"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_getVideoCodecInfo &#125;,</span><br><span class="line">    &#123; <span class="string">"_getAudioCodecInfo"</span>,     <span class="string">"()Ljava/lang/String;"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_getAudioCodecInfo &#125;,</span><br><span class="line">    &#123; <span class="string">"_getMediaMeta"</span>,          <span class="string">"()Landroid/os/Bundle;"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_getMediaMeta &#125;,</span><br><span class="line">    &#123; <span class="string">"_setLoopCount"</span>,          <span class="string">"(I)V"</span>,                     (<span class="keyword">void</span> *) IjkMediaPlayer_setLoopCount &#125;,</span><br><span class="line">    &#123; <span class="string">"_getLoopCount"</span>,          <span class="string">"()I"</span>,                      (<span class="keyword">void</span> *) IjkMediaPlayer_getLoopCount &#125;,</span><br><span class="line">    &#123; <span class="string">"_getPropertyFloat"</span>,      <span class="string">"(IF)F"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_getPropertyFloat &#125;,</span><br><span class="line">    &#123; <span class="string">"_setPropertyFloat"</span>,      <span class="string">"(IF)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setPropertyFloat &#125;,</span><br><span class="line">    &#123; <span class="string">"_getPropertyLong"</span>,       <span class="string">"(IJ)J"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_getPropertyLong &#125;,</span><br><span class="line">    &#123; <span class="string">"_setPropertyLong"</span>,       <span class="string">"(IJ)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setPropertyLong &#125;,</span><br><span class="line">    &#123; <span class="string">"_setStreamSelected"</span>,     <span class="string">"(IZ)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setStreamSelected &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"native_profileBegin"</span>,    <span class="string">"(Ljava/lang/String;)V"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_native_profileBegin &#125;,</span><br><span class="line">    &#123; <span class="string">"native_profileEnd"</span>,      <span class="string">"()V"</span>,                      (<span class="keyword">void</span> *) IjkMediaPlayer_native_profileEnd &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"native_setLogLevel"</span>,     <span class="string">"(I)V"</span>,                     (<span class="keyword">void</span> *) IjkMediaPlayer_native_setLogLevel &#125;,</span><br><span class="line">    &#123; <span class="string">"_setFrameAtTime"</span>,        <span class="string">"(Ljava/lang/String;JJII)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setFrameAtTime &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注册之后 native 和 java 方法就对应起来了</p>
<p>接着调用了一些 init 方法</p>
<ul>
<li><code>ijkmp_global_init()</code> 初始化 ffmpeg</li>
<li><code>ijkmp_global_set_inject_callback()</code> 赋值 inject_callback</li>
<li><code>FFmpegApi_global_init()</code> 初始化 <code>FFmpegApi#av_base64_encode()</code></li>
</ul>
<h4 id="ijkmp-global-init"><a href="#ijkmp-global-init" class="headerlink" title="ijkmp_global_init"></a>ijkmp_global_init</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ijkmp_global_init</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    ffp_global_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ffp_global_init</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_ffmpeg_global_inited)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"ijkmediaplayer version : %s"</span>, ijkmp_version());</span><br><span class="line">    <span class="comment">/* register all codecs, demux and protocols */</span></span><br><span class="line">    avcodec_register_all();</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> CONFIG_AVDEVICE</span></span><br><span class="line">    avdevice_register_all();</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> CONFIG_AVFILTER</span></span><br><span class="line">    avfilter_register_all();</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    av_register_all();</span><br><span class="line"></span><br><span class="line">    ijkav_register_all();</span><br><span class="line"></span><br><span class="line">    avformat_network_init();</span><br><span class="line"></span><br><span class="line">    av_lockmgr_register(lockmgr);</span><br><span class="line">    av_log_set_callback(ffp_log_callback_brief);</span><br><span class="line"></span><br><span class="line">    av_init_packet(&amp;flush_pkt);</span><br><span class="line">    flush_pkt.data = (<span class="keyword">uint8_t</span> *)&amp;flush_pkt;</span><br><span class="line"></span><br><span class="line">    g_ffmpeg_global_inited = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>ffp_global_init()</code> 方法中进行了一系列的 register 和 init，其中就包括了 <code>av_register_all()</code></p>
<h3 id="initNativeOnce"><a href="#initNativeOnce" class="headerlink" title="initNativeOnce"></a>initNativeOnce</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title">AbstractMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mIsNativeInitialized = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initNativeOnce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (IjkMediaPlayer.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mIsNativeInitialized) &#123;</span><br><span class="line">                native_init();</span><br><span class="line">                mIsNativeInitialized = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">native_init</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>initNativeOnce()</code> 最终调用了 native 的 <code>IjkMediaPlayer_native_init()</code> 方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">IjkMediaPlayer_native_init</span><span class="params">(JNIEnv *env)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="native-setup"><a href="#native-setup" class="headerlink" title="native_setup"></a>native_setup</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">IjkMediaPlayer_native_setup</span><span class="params">(JNIEnv *env, jobject thiz, jobject weak_this)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    IjkMediaPlayer *mp = ijkmp_android_create(message_loop);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/OutOfMemoryError"</span>, <span class="string">"mpjni: native_setup: ijkmp_create() failed"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    jni_set_media_player(env, thiz, mp);</span><br><span class="line">    ijkmp_set_weak_thiz(mp, (*env)-&gt;NewGlobalRef(env, weak_this));</span><br><span class="line">    ijkmp_set_inject_opaque(mp, ijkmp_get_weak_thiz(mp));</span><br><span class="line">    ijkmp_set_ijkio_inject_opaque(mp, ijkmp_get_weak_thiz(mp));</span><br><span class="line">    ijkmp_android_set_mediacodec_select_callback(mp, mediacodec_select_callback, ijkmp_get_weak_thiz(mp));</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看 <code>ijkmp_android_create()</code> 方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">IjkMediaPlayer *ijkmp_android_create(int(*msg_loop)(void*))</span><br><span class="line">&#123;</span><br><span class="line">    IjkMediaPlayer *mp = ijkmp_create(msg_loop);</span><br><span class="line">    if (!mp)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    mp-&gt;ffplayer-&gt;vout = SDL_VoutAndroid_CreateForAndroidSurface();</span><br><span class="line">    if (!mp-&gt;ffplayer-&gt;vout)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    mp-&gt;ffplayer-&gt;pipeline = ffpipeline_create_from_android(mp-&gt;ffplayer);</span><br><span class="line">    if (!mp-&gt;ffplayer-&gt;pipeline)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    ffpipeline_set_vout(mp-&gt;ffplayer-&gt;pipeline, mp-&gt;ffplayer-&gt;vout);</span><br><span class="line"></span><br><span class="line">    return mp;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ijkmp_create()</code> 就是去创建个 IjkMediaPlayer 对象，指定了 msg_loop 对象，同时指定了 ffplayer 对象；接下来通过 <code>SDL_VoutAndroid_CreateForAndroidSurface()</code> 创建 vout，在 <code>ffpipeline_set_vout()</code> 对 ffplayer 的输出 vout 进行配置</p>
<h2 id="setDataSource"><a href="#setDataSource" class="headerlink" title="setDataSource"></a>setDataSource</h2><p><code>setDataSource()</code> 设置视频源，对应到 native 层是 <code>IjkMediaPlayer_setDataSourceCallback()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">IjkMediaPlayer_setDataSourceCallback</span><span class="params">(JNIEnv *env, jobject thiz, jobject callback)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> uri[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">int64_t</span> nativeMediaDataSource = <span class="number">0</span>;</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(callback, env, <span class="string">"java/lang/IllegalArgumentException"</span>, <span class="string">"mpjni: setDataSourceCallback: null fd"</span>, LABEL_RETURN);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: setDataSourceCallback: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    nativeMediaDataSource = jni_set_media_data_source(env, thiz, callback);</span><br><span class="line">    JNI_CHECK_GOTO(nativeMediaDataSource, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: jni_set_media_data_source: NewGlobalRef"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"setDataSourceCallback: %"</span>PRId64<span class="string">"\n"</span>, nativeMediaDataSource);</span><br><span class="line">    <span class="built_in">snprintf</span>(uri, <span class="keyword">sizeof</span>(uri), <span class="string">"ijkmediadatasource:%"</span>PRId64, nativeMediaDataSource);</span><br><span class="line"></span><br><span class="line">    retval = ijkmp_set_data_source(mp, uri);</span><br><span class="line"></span><br><span class="line">    IJK_CHECK_MPRET_GOTO(retval, env, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟到 <code>ijkmp_set_data_source()</code> 去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ijkmp_set_data_source_l</span><span class="params">(IjkMediaPlayer *mp, <span class="keyword">const</span> <span class="keyword">char</span> *url)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    assert(mp);</span><br><span class="line">    assert(url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_IDLE);</span></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_INITIALIZED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_ASYNC_PREPARING);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_PREPARED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_STARTED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_PAUSED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_COMPLETED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_STOPPED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_ERROR);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_END);</span><br><span class="line"></span><br><span class="line">    freep((<span class="keyword">void</span>**)&amp;mp-&gt;data_source);</span><br><span class="line">    mp-&gt;data_source = strdup(url);</span><br><span class="line">    <span class="keyword">if</span> (!mp-&gt;data_source)</span><br><span class="line">        <span class="keyword">return</span> EIJK_OUT_OF_MEMORY;</span><br><span class="line"></span><br><span class="line">    ijkmp_change_state_l(mp, MP_STATE_INITIALIZED);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看出 IjkMediaPlayer 中也应该是又一套状态机，默认情况是 <code>MP_STATE_IDLE</code>，接着看 <code>ijkmp_change_state_l()</code> 方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ijkmp_change_state_l</span><span class="params">(IjkMediaPlayer *mp, <span class="keyword">int</span> new_state)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    mp-&gt;mp_state = new_state;</span><br><span class="line">    ffp_notify_msg1(mp-&gt;ffplayer, FFP_MSG_PLAYBACK_STATE_CHANGED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将播放器的状态改为 <code>MP_STATE_INITIALIZED</code> ，然后再将 <code>FFP_MSG_PLAYBACK_STATE_CHANGED</code> 消息通过 <code>ffp_notify_msg1()</code> 传出去</p>
<p>对应接收的地方：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">message_loop_n</span><span class="params">(JNIEnv *env, IjkMediaPlayer *mp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    jobject weak_thiz = (jobject) ijkmp_get_weak_thiz(mp);</span><br><span class="line">    JNI_CHECK_GOTO(weak_thiz, env, <span class="literal">NULL</span>, <span class="string">"mpjni: message_loop_n: null weak_thiz"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        AVMessage msg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> retval = ijkmp_get_msg(mp, &amp;msg, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// block-get should never return 0</span></span><br><span class="line">        assert(retval &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="comment">// ..........</span></span><br><span class="line">        <span class="keyword">case</span> FFP_MSG_PLAYBACK_STATE_CHANGED:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ALOGE(<span class="string">"unknown FFP_MSG_xxx(%d)\n"</span>, msg.what);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        msg_free_res(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="prepareAsync"><a href="#prepareAsync" class="headerlink" title="prepareAsync"></a>prepareAsync</h2><p><code>prepareAsync()</code> 是去准备视频，对应到 native 层是 <code>IjkMediaPlayer_prepareAsync()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line"><span class="title">IjkMediaPlayer_prepareAsync</span><span class="params">(JNIEnv *env, jobject thiz)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: prepareAsync: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    retval = ijkmp_prepare_async(mp);</span><br><span class="line">    IJK_CHECK_MPRET_GOTO(retval, env, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着看 <code>ijkmp_prepare_async()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ijkmp_prepare_async</span><span class="params">(IjkMediaPlayer *mp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    assert(mp);</span><br><span class="line">    MPTRACE(<span class="string">"ijkmp_prepare_async()\n"</span>);</span><br><span class="line">    pthread_mutex_lock(&amp;mp-&gt;mutex);</span><br><span class="line">    <span class="keyword">int</span> retval = ijkmp_prepare_async_l(mp);</span><br><span class="line">    pthread_mutex_unlock(&amp;mp-&gt;mutex);</span><br><span class="line">    MPTRACE(<span class="string">"ijkmp_prepare_async()=%d\n"</span>, retval);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用的是 <code>ijkmp_prepare_async_l()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ijkmp_prepare_async_l</span><span class="params">(IjkMediaPlayer *mp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    assert(mp);</span><br><span class="line"></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_IDLE);</span><br><span class="line">    <span class="comment">// MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_INITIALIZED);</span></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_ASYNC_PREPARING);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_PREPARED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_STARTED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_PAUSED);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_COMPLETED);</span><br><span class="line">    <span class="comment">// MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_STOPPED);</span></span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_ERROR);</span><br><span class="line">    MPST_RET_IF_EQ(mp-&gt;mp_state, MP_STATE_END);</span><br><span class="line"></span><br><span class="line">    assert(mp-&gt;data_source);</span><br><span class="line"></span><br><span class="line">    ijkmp_change_state_l(mp, MP_STATE_ASYNC_PREPARING);</span><br><span class="line"></span><br><span class="line">    msg_queue_start(&amp;mp-&gt;ffplayer-&gt;msg_queue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// released in msg_loop</span></span><br><span class="line">    ijkmp_inc_ref(mp);</span><br><span class="line">    mp-&gt;msg_thread = SDL_CreateThreadEx(&amp;mp-&gt;_msg_thread, ijkmp_msg_loop, mp, <span class="string">"ff_msg_loop"</span>);</span><br><span class="line">    <span class="comment">// msg_thread is detached inside msg_loop</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 9 release weak_thiz if pthread_create() failed;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> retval = ffp_prepare_async_l(mp-&gt;ffplayer, mp-&gt;data_source);</span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ijkmp_change_state_l(mp, MP_STATE_ERROR);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进行状态的判断</li>
<li>将播放器状态改为 <code>MP_STATE_ASYNC_PREPARING</code> </li>
<li>启动 ffplayer 中的 msg_queue</li>
<li>创建 ff_msg_loop 线程</li>
<li>调用 <code>ffp_prepare_async_l()</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ffp_prepare_async_l</span><span class="params">(FFPlayer *ffp, <span class="keyword">const</span> <span class="keyword">char</span> *file_name)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    assert(ffp);</span><br><span class="line">    assert(!ffp-&gt;is);</span><br><span class="line">    assert(file_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (av_stristart(file_name, <span class="string">"rtmp"</span>, <span class="literal">NULL</span>) ||</span><br><span class="line">        av_stristart(file_name, <span class="string">"rtsp"</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="comment">// There is total different meaning for 'timeout' option in rtmp</span></span><br><span class="line">        av_log(ffp, AV_LOG_WARNING, <span class="string">"remove 'timeout' option for rtmp.\n"</span>);</span><br><span class="line">        av_dict_set(&amp;ffp-&gt;format_opts, <span class="string">"timeout"</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* there is a length limit in avformat */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(file_name) + <span class="number">1</span> &gt; <span class="number">1024</span>) &#123;</span><br><span class="line">        av_log(ffp, AV_LOG_ERROR, <span class="string">"%s too long url\n"</span>, __func__);</span><br><span class="line">        <span class="keyword">if</span> (avio_find_protocol_name(<span class="string">"ijklongurl:"</span>)) &#123;</span><br><span class="line">            av_dict_set(&amp;ffp-&gt;format_opts, <span class="string">"ijklongurl-url"</span>, file_name, <span class="number">0</span>);</span><br><span class="line">            file_name = <span class="string">"ijklongurl:"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"===== versions =====\n"</span>);</span><br><span class="line">    ffp_show_version_str(ffp, <span class="string">"ijkplayer"</span>,      ijk_version_info());</span><br><span class="line">    ffp_show_version_str(ffp, <span class="string">"FFmpeg"</span>,         av_version_info());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libavutil"</span>,      avutil_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libavcodec"</span>,     avcodec_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libavformat"</span>,    avformat_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libswscale"</span>,     swscale_version());</span><br><span class="line">    ffp_show_version_int(ffp, <span class="string">"libswresample"</span>,  swresample_version());</span><br><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"===== options =====\n"</span>);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"player-opts"</span>, ffp-&gt;player_opts);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"format-opts"</span>, ffp-&gt;format_opts);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"codec-opts "</span>, ffp-&gt;codec_opts);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"sws-opts   "</span>, ffp-&gt;sws_dict);</span><br><span class="line">    ffp_show_dict(ffp, <span class="string">"swr-opts   "</span>, ffp-&gt;swr_opts);</span><br><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"===================\n"</span>);</span><br><span class="line"></span><br><span class="line">    av_opt_set_dict(ffp, &amp;ffp-&gt;player_opts);</span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;aout) &#123;</span><br><span class="line">        ffp-&gt;aout = ffpipeline_open_audio_output(ffp-&gt;pipeline, ffp);</span><br><span class="line">        <span class="keyword">if</span> (!ffp-&gt;aout)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> CONFIG_AVFILTER</span></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;vfilter0) &#123;</span><br><span class="line">        GROW_ARRAY(ffp-&gt;vfilters_list, ffp-&gt;nb_vfilters);</span><br><span class="line">        ffp-&gt;vfilters_list[ffp-&gt;nb_vfilters - <span class="number">1</span>] = ffp-&gt;vfilter0;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    VideoState *is = stream_open(ffp, file_name, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!is) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING, <span class="string">"ffp_prepare_async_l: stream_open failed OOM"</span>);</span><br><span class="line">        <span class="keyword">return</span> EIJK_OUT_OF_MEMORY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ffp-&gt;is = is;</span><br><span class="line">    ffp-&gt;input_filename = av_strdup(file_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>针对 rtmp 或 rtsp 协议去掉超时 timeout 的 options</li>
<li>对长 url 进行处理</li>
<li>打印 log 信息</li>
<li>调用 <code>stream_open()</code> 方法，<strong>如果该方法失败，则播放失败</strong></li>
</ul>
<h3 id="stream-open"><a href="#stream-open" class="headerlink" title="stream_open"></a>stream_open</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">static VideoState *stream_open(FFPlayer *ffp, const char *filename, AVInputFormat *iformat)</span><br><span class="line">&#123;</span><br><span class="line">    assert(!ffp-&gt;is);</span><br><span class="line">    VideoState *is;</span><br><span class="line"></span><br><span class="line">    is = av_mallocz(sizeof(VideoState));</span><br><span class="line">    if (!is)</span><br><span class="line">        return NULL;</span><br><span class="line">    is-&gt;filename = av_strdup(filename);</span><br><span class="line">    if (!is-&gt;filename)</span><br><span class="line">        goto fail;</span><br><span class="line">    is-&gt;iformat = iformat;</span><br><span class="line">    is-&gt;ytop    = 0;</span><br><span class="line">    is-&gt;xleft   = 0;</span><br><span class="line">#if defined(__ANDROID__)</span><br><span class="line">    if (ffp-&gt;soundtouch_enable) &#123;</span><br><span class="line">        is-&gt;handle = ijk_soundtouch_create();</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    /* start video display */</span><br><span class="line">    if (frame_queue_init(&amp;is-&gt;pictq, &amp;is-&gt;videoq, ffp-&gt;pictq_size, 1) &lt; 0)</span><br><span class="line">        goto fail;</span><br><span class="line">    if (frame_queue_init(&amp;is-&gt;subpq, &amp;is-&gt;subtitleq, SUBPICTURE_QUEUE_SIZE, 0) &lt; 0)</span><br><span class="line">        goto fail;</span><br><span class="line">    if (frame_queue_init(&amp;is-&gt;sampq, &amp;is-&gt;audioq, SAMPLE_QUEUE_SIZE, 1) &lt; 0)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    if (packet_queue_init(&amp;is-&gt;videoq) &lt; 0 ||</span><br><span class="line">        packet_queue_init(&amp;is-&gt;audioq) &lt; 0 ||</span><br><span class="line">        packet_queue_init(&amp;is-&gt;subtitleq) &lt; 0)</span><br><span class="line">        goto fail;</span><br><span class="line"></span><br><span class="line">    if (!(is-&gt;continue_read_thread = SDL_CreateCond())) &#123;</span><br><span class="line">        av_log(NULL, AV_LOG_FATAL, "SDL_CreateCond(): %s\n", SDL_GetError());</span><br><span class="line">        goto fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!(is-&gt;video_accurate_seek_cond = SDL_CreateCond())) &#123;</span><br><span class="line">        av_log(NULL, AV_LOG_FATAL, "SDL_CreateCond(): %s\n", SDL_GetError());</span><br><span class="line">        ffp-&gt;enable_accurate_seek = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!(is-&gt;audio_accurate_seek_cond = SDL_CreateCond())) &#123;</span><br><span class="line">        av_log(NULL, AV_LOG_FATAL, "SDL_CreateCond(): %s\n", SDL_GetError());</span><br><span class="line">        ffp-&gt;enable_accurate_seek = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    init_clock(&amp;is-&gt;vidclk, &amp;is-&gt;videoq.serial);</span><br><span class="line">    init_clock(&amp;is-&gt;audclk, &amp;is-&gt;audioq.serial);</span><br><span class="line">    init_clock(&amp;is-&gt;extclk, &amp;is-&gt;extclk.serial);</span><br><span class="line">    is-&gt;audio_clock_serial = -1;</span><br><span class="line">    if (ffp-&gt;startup_volume &lt; 0)</span><br><span class="line">        av_log(NULL, AV_LOG_WARNING, "-volume=%d &lt; 0, setting to 0\n", ffp-&gt;startup_volume);</span><br><span class="line">    if (ffp-&gt;startup_volume &gt; 100)</span><br><span class="line">        av_log(NULL, AV_LOG_WARNING, "-volume=%d &gt; 100, setting to 100\n", ffp-&gt;startup_volume);</span><br><span class="line">    ffp-&gt;startup_volume = av_clip(ffp-&gt;startup_volume, 0, 100);</span><br><span class="line">    ffp-&gt;startup_volume = av_clip(SDL_MIX_MAXVOLUME * ffp-&gt;startup_volume / 100, 0, SDL_MIX_MAXVOLUME);</span><br><span class="line">    is-&gt;audio_volume = ffp-&gt;startup_volume;</span><br><span class="line">    is-&gt;muted = 0;</span><br><span class="line">    is-&gt;av_sync_type = ffp-&gt;av_sync_type;</span><br><span class="line"></span><br><span class="line">    is-&gt;play_mutex = SDL_CreateMutex();</span><br><span class="line">    is-&gt;accurate_seek_mutex = SDL_CreateMutex();</span><br><span class="line">    ffp-&gt;is = is;</span><br><span class="line">    is-&gt;pause_req = !ffp-&gt;start_on_prepared;</span><br><span class="line"></span><br><span class="line">    is-&gt;video_refresh_tid = SDL_CreateThreadEx(&amp;is-&gt;_video_refresh_tid, video_refresh_thread, ffp, "ff_vout");</span><br><span class="line">    if (!is-&gt;video_refresh_tid) &#123;</span><br><span class="line">        av_freep(&amp;ffp-&gt;is);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    is-&gt;initialized_decoder = 0;</span><br><span class="line">    is-&gt;read_tid = SDL_CreateThreadEx(&amp;is-&gt;_read_tid, read_thread, ffp, "ff_read");</span><br><span class="line">    if (!is-&gt;read_tid) &#123;</span><br><span class="line">        av_log(NULL, AV_LOG_FATAL, "SDL_CreateThread(): %s\n", SDL_GetError());</span><br><span class="line">        goto fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ffp-&gt;async_init_decoder &amp;&amp; !ffp-&gt;video_disable &amp;&amp; ffp-&gt;video_mime_type &amp;&amp; strlen(ffp-&gt;video_mime_type) &gt; 0</span><br><span class="line">                    &amp;&amp; ffp-&gt;mediacodec_default_name &amp;&amp; strlen(ffp-&gt;mediacodec_default_name) &gt; 0) &#123;</span><br><span class="line">        if (ffp-&gt;mediacodec_all_videos || ffp-&gt;mediacodec_avc || ffp-&gt;mediacodec_hevc || ffp-&gt;mediacodec_mpeg2) &#123;</span><br><span class="line">            decoder_init(&amp;is-&gt;viddec, NULL, &amp;is-&gt;videoq, is-&gt;continue_read_thread);</span><br><span class="line">            ffp-&gt;node_vdec = ffpipeline_init_video_decoder(ffp-&gt;pipeline, ffp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    is-&gt;initialized_decoder = 1;</span><br><span class="line"></span><br><span class="line">    return is;</span><br><span class="line">fail:</span><br><span class="line">    is-&gt;initialized_decoder = 1;</span><br><span class="line">    is-&gt;abort_request = true;</span><br><span class="line">    if (is-&gt;video_refresh_tid)</span><br><span class="line">        SDL_WaitThread(is-&gt;video_refresh_tid, NULL);</span><br><span class="line">    stream_close(ffp);</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对 frame queue、 packet queue 和 clock 分别进行了初始化，同时在该方法中创建了两个线程</p>
<ul>
<li><code>ff_vout</code>：video_refresh_thread 线程，用于视频显示</li>
<li><code>ff_read</code>：read_thread 线程，用于读取数据</li>
</ul>
<h3 id="read-thread"><a href="#read-thread" class="headerlink" title="read_thread"></a>read_thread</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* this thread gets the stream from the disk or the network */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    FFPlayer *ffp = arg;</span><br><span class="line">    VideoState *is = ffp-&gt;is;</span><br><span class="line">    AVFormatContext *ic = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> err, i, ret __unused;</span><br><span class="line">    <span class="keyword">int</span> st_index[AVMEDIA_TYPE_NB];</span><br><span class="line">    AVPacket pkt1, *pkt = &amp;pkt1;</span><br><span class="line">    <span class="keyword">int64_t</span> stream_start_time;</span><br><span class="line">    <span class="keyword">int</span> completed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkt_in_play_range = <span class="number">0</span>;</span><br><span class="line">    AVDictionaryEntry *t;</span><br><span class="line">    SDL_mutex *wait_mutex = SDL_CreateMutex();</span><br><span class="line">    <span class="keyword">int</span> scan_all_pmts_set = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> pkt_ts;</span><br><span class="line">    <span class="keyword">int</span> last_error = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> prev_io_tick_counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int64_t</span> io_tick_counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> init_ijkmeta = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wait_mutex) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_FATAL, <span class="string">"SDL_CreateMutex(): %s\n"</span>, SDL_GetError());</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(st_index, -<span class="number">1</span>, <span class="keyword">sizeof</span>(st_index));</span><br><span class="line">    is-&gt;last_video_stream = is-&gt;video_stream = -<span class="number">1</span>;</span><br><span class="line">    is-&gt;last_audio_stream = is-&gt;audio_stream = -<span class="number">1</span>;</span><br><span class="line">    is-&gt;last_subtitle_stream = is-&gt;subtitle_stream = -<span class="number">1</span>;</span><br><span class="line">    is-&gt;eof = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ic = avformat_alloc_context();</span><br><span class="line">    <span class="keyword">if</span> (!ic) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_FATAL, <span class="string">"Could not allocate context.\n"</span>);</span><br><span class="line">        ret = AVERROR(ENOMEM);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    ic-&gt;interrupt_callback.callback = decode_interrupt_cb;</span><br><span class="line">    ic-&gt;interrupt_callback.opaque = is;</span><br><span class="line">    <span class="keyword">if</span> (!av_dict_get(ffp-&gt;format_opts, <span class="string">"scan_all_pmts"</span>, <span class="literal">NULL</span>, AV_DICT_MATCH_CASE)) &#123;</span><br><span class="line">        av_dict_set(&amp;ffp-&gt;format_opts, <span class="string">"scan_all_pmts"</span>, <span class="string">"1"</span>, AV_DICT_DONT_OVERWRITE);</span><br><span class="line">        scan_all_pmts_set = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (av_stristart(is-&gt;filename, <span class="string">"rtmp"</span>, <span class="literal">NULL</span>) ||</span><br><span class="line">        av_stristart(is-&gt;filename, <span class="string">"rtsp"</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="comment">// There is total different meaning for 'timeout' option in rtmp</span></span><br><span class="line">        av_log(ffp, AV_LOG_WARNING, <span class="string">"remove 'timeout' option for rtmp.\n"</span>);</span><br><span class="line">        av_dict_set(&amp;ffp-&gt;format_opts, <span class="string">"timeout"</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;skip_calc_frame_rate) &#123;</span><br><span class="line">        av_dict_set_int(&amp;ic-&gt;metadata, <span class="string">"skip-calc-frame-rate"</span>, ffp-&gt;skip_calc_frame_rate, <span class="number">0</span>);</span><br><span class="line">        av_dict_set_int(&amp;ffp-&gt;format_opts, <span class="string">"skip-calc-frame-rate"</span>, ffp-&gt;skip_calc_frame_rate, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;iformat_name)</span><br><span class="line">        is-&gt;iformat = av_find_input_format(ffp-&gt;iformat_name);</span><br><span class="line">    err = avformat_open_input(&amp;ic, is-&gt;filename, is-&gt;iformat, &amp;ffp-&gt;format_opts);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        print_error(is-&gt;filename, err);</span><br><span class="line">        ret = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    ffp_notify_msg1(ffp, FFP_MSG_OPEN_INPUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scan_all_pmts_set)</span><br><span class="line">        av_dict_set(&amp;ffp-&gt;format_opts, <span class="string">"scan_all_pmts"</span>, <span class="literal">NULL</span>, AV_DICT_MATCH_CASE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((t = av_dict_get(ffp-&gt;format_opts, <span class="string">""</span>, <span class="literal">NULL</span>, AV_DICT_IGNORE_SUFFIX))) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Option %s not found.\n"</span>, t-&gt;key);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> FFP_MERGE</span></span><br><span class="line">        ret = AVERROR_OPTION_NOT_FOUND;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    is-&gt;ic = ic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;genpts)</span><br><span class="line">        ic-&gt;flags |= AVFMT_FLAG_GENPTS;</span><br><span class="line"></span><br><span class="line">    av_format_inject_global_side_data(ic);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//AVDictionary **opts;</span></span><br><span class="line">    <span class="comment">//int orig_nb_streams;</span></span><br><span class="line">    <span class="comment">//opts = setup_find_stream_info_opts(ic, ffp-&gt;codec_opts);</span></span><br><span class="line">    <span class="comment">//orig_nb_streams = ic-&gt;nb_streams;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;find_stream_info) &#123;</span><br><span class="line">        AVDictionary **opts = setup_find_stream_info_opts(ic, ffp-&gt;codec_opts);</span><br><span class="line">        <span class="keyword">int</span> orig_nb_streams = ic-&gt;nb_streams;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (av_stristart(is-&gt;filename, <span class="string">"data:"</span>, <span class="literal">NULL</span>) &amp;&amp; orig_nb_streams &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; orig_nb_streams; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!ic-&gt;streams[i] || !ic-&gt;streams[i]-&gt;codecpar || ic-&gt;streams[i]-&gt;codecpar-&gt;profile == FF_PROFILE_UNKNOWN) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i == orig_nb_streams) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            err = avformat_find_stream_info(ic, opts);</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="number">0</span>);</span><br><span class="line">        ffp_notify_msg1(ffp, FFP_MSG_FIND_STREAM_INFO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; orig_nb_streams; i++)</span><br><span class="line">            av_dict_free(&amp;opts[i]);</span><br><span class="line">        av_freep(&amp;opts);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_WARNING,</span><br><span class="line">                   <span class="string">"%s: could not find codec parameters\n"</span>, is-&gt;filename);</span><br><span class="line">            ret = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ic-&gt;pb)</span><br><span class="line">        ic-&gt;pb-&gt;eof_reached = <span class="number">0</span>; <span class="comment">// FIXME hack, ffplay maybe should not use avio_feof() to test for the end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;seek_by_bytes &lt; <span class="number">0</span>)</span><br><span class="line">        ffp-&gt;seek_by_bytes = !!(ic-&gt;iformat-&gt;flags &amp; AVFMT_TS_DISCONT) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"ogg"</span>, ic-&gt;iformat-&gt;name);</span><br><span class="line"></span><br><span class="line">    is-&gt;max_frame_duration = (ic-&gt;iformat-&gt;flags &amp; AVFMT_TS_DISCONT) ? <span class="number">10.0</span> : <span class="number">3600.0</span>;</span><br><span class="line">    is-&gt;max_frame_duration = <span class="number">10.0</span>;</span><br><span class="line">    av_log(ffp, AV_LOG_INFO, <span class="string">"max_frame_duration: %.3f\n"</span>, is-&gt;max_frame_duration);</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> FFP_MERGE</span></span><br><span class="line">    <span class="keyword">if</span> (!window_title &amp;&amp; (t = av_dict_get(ic-&gt;metadata, <span class="string">"title"</span>, <span class="literal">NULL</span>, <span class="number">0</span>)))</span><br><span class="line">        window_title = av_asprintf(<span class="string">"%s - %s"</span>, t-&gt;value, input_filename);</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* if seeking requested, we execute it */</span></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;start_time != AV_NOPTS_VALUE) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> timestamp;</span><br><span class="line"></span><br><span class="line">        timestamp = ffp-&gt;start_time;</span><br><span class="line">        <span class="comment">/* add the stream start time */</span></span><br><span class="line">        <span class="keyword">if</span> (ic-&gt;start_time != AV_NOPTS_VALUE)</span><br><span class="line">            timestamp += ic-&gt;start_time;</span><br><span class="line">        ret = avformat_seek_file(ic, -<span class="number">1</span>, INT64_MIN, timestamp, INT64_MAX, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_WARNING, <span class="string">"%s: could not seek to position %0.3f\n"</span>,</span><br><span class="line">                    is-&gt;filename, (<span class="keyword">double</span>)timestamp / AV_TIME_BASE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    is-&gt;realtime = is_realtime(ic);</span><br><span class="line"></span><br><span class="line">    av_dump_format(ic, <span class="number">0</span>, is-&gt;filename, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> video_stream_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> h264_stream_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> first_h264_stream = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ic-&gt;nb_streams; i++) &#123;</span><br><span class="line">        AVStream *st = ic-&gt;streams[i];</span><br><span class="line">        <span class="keyword">enum</span> AVMediaType type = st-&gt;codecpar-&gt;codec_type;</span><br><span class="line">        st-&gt;discard = AVDISCARD_ALL;</span><br><span class="line">        <span class="keyword">if</span> (type &gt;= <span class="number">0</span> &amp;&amp; ffp-&gt;wanted_stream_spec[type] &amp;&amp; st_index[type] == -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (avformat_match_stream_specifier(ic, st, ffp-&gt;wanted_stream_spec[type]) &gt; <span class="number">0</span>)</span><br><span class="line">                st_index[type] = i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// choose first h264</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type == AVMEDIA_TYPE_VIDEO) &#123;</span><br><span class="line">            <span class="keyword">enum</span> AVCodecID codec_id = st-&gt;codecpar-&gt;codec_id;</span><br><span class="line">            video_stream_count++;</span><br><span class="line">            <span class="keyword">if</span> (codec_id == AV_CODEC_ID_H264) &#123;</span><br><span class="line">                h264_stream_count++;</span><br><span class="line">                <span class="keyword">if</span> (first_h264_stream &lt; <span class="number">0</span>)</span><br><span class="line">                    first_h264_stream = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (video_stream_count &gt; <span class="number">1</span> &amp;&amp; st_index[AVMEDIA_TYPE_VIDEO] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        st_index[AVMEDIA_TYPE_VIDEO] = first_h264_stream;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING, <span class="string">"multiple video stream found, prefer first h264 stream: %d\n"</span>, first_h264_stream);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;video_disable)</span><br><span class="line">        st_index[AVMEDIA_TYPE_VIDEO] =</span><br><span class="line">            av_find_best_stream(ic, AVMEDIA_TYPE_VIDEO,</span><br><span class="line">                                st_index[AVMEDIA_TYPE_VIDEO], -<span class="number">1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;audio_disable)</span><br><span class="line">        st_index[AVMEDIA_TYPE_AUDIO] =</span><br><span class="line">            av_find_best_stream(ic, AVMEDIA_TYPE_AUDIO,</span><br><span class="line">                                st_index[AVMEDIA_TYPE_AUDIO],</span><br><span class="line">                                st_index[AVMEDIA_TYPE_VIDEO],</span><br><span class="line">                                <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;video_disable &amp;&amp; !ffp-&gt;subtitle_disable)</span><br><span class="line">        st_index[AVMEDIA_TYPE_SUBTITLE] =</span><br><span class="line">            av_find_best_stream(ic, AVMEDIA_TYPE_SUBTITLE,</span><br><span class="line">                                st_index[AVMEDIA_TYPE_SUBTITLE],</span><br><span class="line">                                (st_index[AVMEDIA_TYPE_AUDIO] &gt;= <span class="number">0</span> ?</span><br><span class="line">                                 st_index[AVMEDIA_TYPE_AUDIO] :</span><br><span class="line">                                 st_index[AVMEDIA_TYPE_VIDEO]),</span><br><span class="line">                                <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    is-&gt;show_mode = ffp-&gt;show_mode;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> FFP_MERGE <span class="comment">// bbc: dunno if we need this</span></span></span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_VIDEO] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        AVStream *st = ic-&gt;streams[st_index[AVMEDIA_TYPE_VIDEO]];</span><br><span class="line">        AVCodecParameters *codecpar = st-&gt;codecpar;</span><br><span class="line">        AVRational sar = av_guess_sample_aspect_ratio(ic, st, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (codecpar-&gt;width)</span><br><span class="line">            set_default_window_size(codecpar-&gt;width, codecpar-&gt;height, sar);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* open the streams */</span></span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_AUDIO] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        stream_component_open(ffp, st_index[AVMEDIA_TYPE_AUDIO]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ffp-&gt;av_sync_type = AV_SYNC_VIDEO_MASTER;</span><br><span class="line">        is-&gt;av_sync_type  = ffp-&gt;av_sync_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_VIDEO] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ret = stream_component_open(ffp, st_index[AVMEDIA_TYPE_VIDEO]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is-&gt;show_mode == SHOW_MODE_NONE)</span><br><span class="line">        is-&gt;show_mode = ret &gt;= <span class="number">0</span> ? SHOW_MODE_VIDEO : SHOW_MODE_RDFT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_SUBTITLE] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        stream_component_open(ffp, st_index[AVMEDIA_TYPE_SUBTITLE]);</span><br><span class="line">    &#125;</span><br><span class="line">    ffp_notify_msg1(ffp, FFP_MSG_COMPONENT_OPEN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;ijkmeta_delay_init) &#123;</span><br><span class="line">        ijkmeta_set_avformat_context_l(ffp-&gt;meta, ic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ffp-&gt;stat.bit_rate = ic-&gt;bit_rate;</span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_VIDEO] &gt;= <span class="number">0</span>)</span><br><span class="line">        ijkmeta_set_int64_l(ffp-&gt;meta, IJKM_KEY_VIDEO_STREAM, st_index[AVMEDIA_TYPE_VIDEO]);</span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_AUDIO] &gt;= <span class="number">0</span>)</span><br><span class="line">        ijkmeta_set_int64_l(ffp-&gt;meta, IJKM_KEY_AUDIO_STREAM, st_index[AVMEDIA_TYPE_AUDIO]);</span><br><span class="line">    <span class="keyword">if</span> (st_index[AVMEDIA_TYPE_SUBTITLE] &gt;= <span class="number">0</span>)</span><br><span class="line">        ijkmeta_set_int64_l(ffp-&gt;meta, IJKM_KEY_TIMEDTEXT_STREAM, st_index[AVMEDIA_TYPE_SUBTITLE]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is-&gt;video_stream &lt; <span class="number">0</span> &amp;&amp; is-&gt;audio_stream &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_FATAL, <span class="string">"Failed to open file '%s' or configure filtergraph\n"</span>,</span><br><span class="line">               is-&gt;filename);</span><br><span class="line">        ret = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is-&gt;audio_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        is-&gt;audioq.is_buffer_indicator = <span class="number">1</span>;</span><br><span class="line">        is-&gt;buffer_indicator_queue = &amp;is-&gt;audioq;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is-&gt;video_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        is-&gt;videoq.is_buffer_indicator = <span class="number">1</span>;</span><br><span class="line">        is-&gt;buffer_indicator_queue = &amp;is-&gt;videoq;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        assert(<span class="string">"invalid streams"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;infinite_buffer &lt; <span class="number">0</span> &amp;&amp; is-&gt;realtime)</span><br><span class="line">        ffp-&gt;infinite_buffer = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;render_wait_start &amp;&amp; !ffp-&gt;start_on_prepared)</span><br><span class="line">        toggle_pause(ffp, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (is-&gt;video_st &amp;&amp; is-&gt;video_st-&gt;codecpar) &#123;</span><br><span class="line">        AVCodecParameters *codecpar = is-&gt;video_st-&gt;codecpar;</span><br><span class="line">        ffp_notify_msg3(ffp, FFP_MSG_VIDEO_SIZE_CHANGED, codecpar-&gt;width, codecpar-&gt;height);</span><br><span class="line">        ffp_notify_msg3(ffp, FFP_MSG_SAR_CHANGED, codecpar-&gt;sample_aspect_ratio.num, codecpar-&gt;sample_aspect_ratio.den);</span><br><span class="line">    &#125;</span><br><span class="line">    ffp-&gt;prepared = <span class="literal">true</span>;</span><br><span class="line">    ffp_notify_msg1(ffp, FFP_MSG_PREPARED);</span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;render_wait_start &amp;&amp; !ffp-&gt;start_on_prepared) &#123;</span><br><span class="line">        <span class="keyword">while</span> (is-&gt;pause_req &amp;&amp; !is-&gt;abort_request) &#123;</span><br><span class="line">            SDL_Delay(<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;auto_resume) &#123;</span><br><span class="line">        ffp_notify_msg1(ffp, FFP_REQ_START);</span><br><span class="line">        ffp-&gt;auto_resume = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* offset should be seeked*/</span></span><br><span class="line">    <span class="keyword">if</span> (ffp-&gt;seek_at_start &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ffp_seek_to_l(ffp, (<span class="keyword">long</span>)(ffp-&gt;seek_at_start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is-&gt;abort_request)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> FFP_MERGE</span></span><br><span class="line">        <span class="keyword">if</span> (is-&gt;paused != is-&gt;last_paused) &#123;</span><br><span class="line">            is-&gt;last_paused = is-&gt;paused;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;paused)</span><br><span class="line">                is-&gt;read_pause_return = av_read_pause(ic);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                av_read_play(ic);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> CONFIG_RTSP_DEMUXER || CONFIG_MMSH_PROTOCOL</span></span><br><span class="line">        <span class="keyword">if</span> (is-&gt;paused &amp;&amp;</span><br><span class="line">                (!<span class="built_in">strcmp</span>(ic-&gt;iformat-&gt;name, <span class="string">"rtsp"</span>) ||</span><br><span class="line">                 (ic-&gt;pb &amp;&amp; !<span class="built_in">strncmp</span>(ffp-&gt;input_filename, <span class="string">"mmsh:"</span>, <span class="number">5</span>)))) &#123;</span><br><span class="line">            <span class="comment">/* wait 10 ms to avoid trying to get another packet */</span></span><br><span class="line">            <span class="comment">/* <span class="doctag">XXX:</span> horrible */</span></span><br><span class="line">            SDL_Delay(<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (is-&gt;seek_req) &#123;</span><br><span class="line">            <span class="keyword">int64_t</span> seek_target = is-&gt;seek_pos;</span><br><span class="line">            <span class="keyword">int64_t</span> seek_min    = is-&gt;seek_rel &gt; <span class="number">0</span> ? seek_target - is-&gt;seek_rel + <span class="number">2</span>: INT64_MIN;</span><br><span class="line">            <span class="keyword">int64_t</span> seek_max    = is-&gt;seek_rel &lt; <span class="number">0</span> ? seek_target - is-&gt;seek_rel - <span class="number">2</span>: INT64_MAX;</span><br><span class="line"><span class="comment">// FIXME the +-2 is due to rounding being not done in the correct direction in generation</span></span><br><span class="line"><span class="comment">//      of the seek_pos/seek_rel variables</span></span><br><span class="line"></span><br><span class="line">            ffp_toggle_buffering(ffp, <span class="number">1</span>);</span><br><span class="line">            ffp_notify_msg3(ffp, FFP_MSG_BUFFERING_UPDATE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            ret = avformat_seek_file(is-&gt;ic, -<span class="number">1</span>, seek_min, seek_target, seek_max, is-&gt;seek_flags);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_ERROR,</span><br><span class="line">                       <span class="string">"%s: error while seeking\n"</span>, is-&gt;ic-&gt;filename);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;audio_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    packet_queue_flush(&amp;is-&gt;audioq);</span><br><span class="line">                    packet_queue_put(&amp;is-&gt;audioq, &amp;flush_pkt);</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> clear invaild audio data</span></span><br><span class="line">                    <span class="comment">// SDL_AoutFlushAudio(ffp-&gt;aout);</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;subtitle_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    packet_queue_flush(&amp;is-&gt;subtitleq);</span><br><span class="line">                    packet_queue_put(&amp;is-&gt;subtitleq, &amp;flush_pkt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;video_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ffp-&gt;node_vdec) &#123;</span><br><span class="line">                        ffpipenode_flush(ffp-&gt;node_vdec);</span><br><span class="line">                    &#125;</span><br><span class="line">                    packet_queue_flush(&amp;is-&gt;videoq);</span><br><span class="line">                    packet_queue_put(&amp;is-&gt;videoq, &amp;flush_pkt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;seek_flags &amp; AVSEEK_FLAG_BYTE) &#123;</span><br><span class="line">                   set_clock(&amp;is-&gt;extclk, NAN, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   set_clock(&amp;is-&gt;extclk, seek_target / (<span class="keyword">double</span>)AV_TIME_BASE, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                is-&gt;latest_video_seek_load_serial = is-&gt;videoq.serial;</span><br><span class="line">                is-&gt;latest_audio_seek_load_serial = is-&gt;audioq.serial;</span><br><span class="line">                is-&gt;latest_seek_load_start_at = av_gettime();</span><br><span class="line">            &#125;</span><br><span class="line">            ffp-&gt;dcc.current_high_water_mark_in_ms = ffp-&gt;dcc.first_high_water_mark_in_ms;</span><br><span class="line">            is-&gt;seek_req = <span class="number">0</span>;</span><br><span class="line">            is-&gt;queue_attachments_req = <span class="number">1</span>;</span><br><span class="line">            is-&gt;eof = <span class="number">0</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> FFP_MERGE</span></span><br><span class="line">            <span class="keyword">if</span> (is-&gt;paused)</span><br><span class="line">                step_to_next_frame(is);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">            completed = <span class="number">0</span>;</span><br><span class="line">            SDL_LockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line">            <span class="keyword">if</span> (ffp-&gt;auto_resume) &#123;</span><br><span class="line">                is-&gt;pause_req = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (ffp-&gt;packet_buffering)</span><br><span class="line">                    is-&gt;buffering_on = <span class="number">1</span>;</span><br><span class="line">                ffp-&gt;auto_resume = <span class="number">0</span>;</span><br><span class="line">                stream_update_pause_l(ffp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;pause_req)</span><br><span class="line">                step_to_next_frame_l(ffp);</span><br><span class="line">            SDL_UnlockMutex(ffp-&gt;is-&gt;play_mutex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ffp-&gt;enable_accurate_seek) &#123;</span><br><span class="line">                is-&gt;drop_aframe_count = <span class="number">0</span>;</span><br><span class="line">                is-&gt;drop_vframe_count = <span class="number">0</span>;</span><br><span class="line">                SDL_LockMutex(is-&gt;accurate_seek_mutex);</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;video_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    is-&gt;video_accurate_seek_req = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;audio_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    is-&gt;audio_accurate_seek_req = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                SDL_CondSignal(is-&gt;audio_accurate_seek_cond);</span><br><span class="line">                SDL_CondSignal(is-&gt;video_accurate_seek_cond);</span><br><span class="line">                SDL_UnlockMutex(is-&gt;accurate_seek_mutex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ffp_notify_msg3(ffp, FFP_MSG_SEEK_COMPLETE, (<span class="keyword">int</span>)fftime_to_milliseconds(seek_target), ret);</span><br><span class="line">            ffp_toggle_buffering(ffp, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is-&gt;queue_attachments_req) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;video_st &amp;&amp; (is-&gt;video_st-&gt;disposition &amp; AV_DISPOSITION_ATTACHED_PIC)) &#123;</span><br><span class="line">                AVPacket copy = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">                <span class="keyword">if</span> ((ret = av_packet_ref(&amp;copy, &amp;is-&gt;video_st-&gt;attached_pic)) &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">goto</span> fail;</span><br><span class="line">                packet_queue_put(&amp;is-&gt;videoq, &amp;copy);</span><br><span class="line">                packet_queue_put_nullpacket(&amp;is-&gt;videoq, is-&gt;video_stream);</span><br><span class="line">            &#125;</span><br><span class="line">            is-&gt;queue_attachments_req = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* if the queue are full, no need to read more */</span></span><br><span class="line">        <span class="keyword">if</span> (ffp-&gt;infinite_buffer&lt;<span class="number">1</span> &amp;&amp; !is-&gt;seek_req &amp;&amp;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> FFP_MERGE</span></span><br><span class="line">              (is-&gt;audioq.size + is-&gt;videoq.size + is-&gt;subtitleq.size &gt; MAX_QUEUE_SIZE</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">              (is-&gt;audioq.size + is-&gt;videoq.size + is-&gt;subtitleq.size &gt; ffp-&gt;dcc.max_buffer_size</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">            || (   stream_has_enough_packets(is-&gt;audio_st, is-&gt;audio_stream, &amp;is-&gt;audioq, MIN_FRAMES)</span><br><span class="line">                &amp;&amp; stream_has_enough_packets(is-&gt;video_st, is-&gt;video_stream, &amp;is-&gt;videoq, MIN_FRAMES)</span><br><span class="line">                &amp;&amp; stream_has_enough_packets(is-&gt;subtitle_st, is-&gt;subtitle_stream, &amp;is-&gt;subtitleq, MIN_FRAMES)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!is-&gt;eof) &#123;</span><br><span class="line">                ffp_toggle_buffering(ffp, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* wait 10 ms */</span></span><br><span class="line">            SDL_LockMutex(wait_mutex);</span><br><span class="line">            SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class="number">10</span>);</span><br><span class="line">            SDL_UnlockMutex(wait_mutex);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((!is-&gt;paused || completed) &amp;&amp;</span><br><span class="line">            (!is-&gt;audio_st || (is-&gt;auddec.finished == is-&gt;audioq.<span class="function">serial &amp;&amp; <span class="title">frame_queue_nb_remaining</span><span class="params">(&amp;is-&gt;sampq)</span> </span>== <span class="number">0</span>)) &amp;&amp;</span><br><span class="line">            (!is-&gt;video_st || (is-&gt;viddec.finished == is-&gt;videoq.<span class="function">serial &amp;&amp; <span class="title">frame_queue_nb_remaining</span><span class="params">(&amp;is-&gt;pictq)</span> </span>== <span class="number">0</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ffp-&gt;loop != <span class="number">1</span> &amp;&amp; (!ffp-&gt;loop || --ffp-&gt;loop)) &#123;</span><br><span class="line">                stream_seek(is, ffp-&gt;start_time != AV_NOPTS_VALUE ? ffp-&gt;start_time : <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ffp-&gt;autoexit) &#123;</span><br><span class="line">                ret = AVERROR_EOF;</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ffp_statistic_l(ffp);</span><br><span class="line">                <span class="keyword">if</span> (completed) &#123;</span><br><span class="line">                    av_log(ffp, AV_LOG_INFO, <span class="string">"ffp_toggle_buffering: eof\n"</span>);</span><br><span class="line">                    SDL_LockMutex(wait_mutex);</span><br><span class="line">                    <span class="comment">// infinite wait may block shutdown</span></span><br><span class="line">                    <span class="keyword">while</span>(!is-&gt;abort_request &amp;&amp; !is-&gt;seek_req)</span><br><span class="line">                        SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class="number">100</span>);</span><br><span class="line">                    SDL_UnlockMutex(wait_mutex);</span><br><span class="line">                    <span class="keyword">if</span> (!is-&gt;abort_request)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    completed = <span class="number">1</span>;</span><br><span class="line">                    ffp-&gt;auto_resume = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> 0 it's a bit early to notify complete here</span></span><br><span class="line">                    ffp_toggle_buffering(ffp, <span class="number">0</span>);</span><br><span class="line">                    toggle_pause(ffp, <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (ffp-&gt;error) &#123;</span><br><span class="line">                        av_log(ffp, AV_LOG_INFO, <span class="string">"ffp_toggle_buffering: error: %d\n"</span>, ffp-&gt;error);</span><br><span class="line">                        ffp_notify_msg1(ffp, FFP_MSG_ERROR);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        av_log(ffp, AV_LOG_INFO, <span class="string">"ffp_toggle_buffering: completed: OK\n"</span>);</span><br><span class="line">                        ffp_notify_msg1(ffp, FFP_MSG_COMPLETED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pkt-&gt;flags = <span class="number">0</span>;</span><br><span class="line">        ret = av_read_frame(ic, pkt);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> pb_eof = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> pb_error = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ((ret == AVERROR_EOF || avio_feof(ic-&gt;pb)) &amp;&amp; !is-&gt;eof) &#123;</span><br><span class="line">                ffp_check_buffering_l(ffp);</span><br><span class="line">                pb_eof = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// check error later</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ic-&gt;pb &amp;&amp; ic-&gt;pb-&gt;error) &#123;</span><br><span class="line">                pb_eof = <span class="number">1</span>;</span><br><span class="line">                pb_error = ic-&gt;pb-&gt;error;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret == AVERROR_EXIT) &#123;</span><br><span class="line">                pb_eof = <span class="number">1</span>;</span><br><span class="line">                pb_error = AVERROR_EXIT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pb_eof) &#123;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;video_stream &gt;= <span class="number">0</span>)</span><br><span class="line">                    packet_queue_put_nullpacket(&amp;is-&gt;videoq, is-&gt;video_stream);</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;audio_stream &gt;= <span class="number">0</span>)</span><br><span class="line">                    packet_queue_put_nullpacket(&amp;is-&gt;audioq, is-&gt;audio_stream);</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;subtitle_stream &gt;= <span class="number">0</span>)</span><br><span class="line">                    packet_queue_put_nullpacket(&amp;is-&gt;subtitleq, is-&gt;subtitle_stream);</span><br><span class="line">                is-&gt;eof = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pb_error) &#123;</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;video_stream &gt;= <span class="number">0</span>)</span><br><span class="line">                    packet_queue_put_nullpacket(&amp;is-&gt;videoq, is-&gt;video_stream);</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;audio_stream &gt;= <span class="number">0</span>)</span><br><span class="line">                    packet_queue_put_nullpacket(&amp;is-&gt;audioq, is-&gt;audio_stream);</span><br><span class="line">                <span class="keyword">if</span> (is-&gt;subtitle_stream &gt;= <span class="number">0</span>)</span><br><span class="line">                    packet_queue_put_nullpacket(&amp;is-&gt;subtitleq, is-&gt;subtitle_stream);</span><br><span class="line">                is-&gt;eof = <span class="number">1</span>;</span><br><span class="line">                ffp-&gt;error = pb_error;</span><br><span class="line">                av_log(ffp, AV_LOG_ERROR, <span class="string">"av_read_frame error: %s\n"</span>, ffp_get_error_string(ffp-&gt;error));</span><br><span class="line">                <span class="comment">// break;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ffp-&gt;error = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;eof) &#123;</span><br><span class="line">                ffp_toggle_buffering(ffp, <span class="number">0</span>);</span><br><span class="line">                SDL_Delay(<span class="number">100</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            SDL_LockMutex(wait_mutex);</span><br><span class="line">            SDL_CondWaitTimeout(is-&gt;continue_read_thread, wait_mutex, <span class="number">10</span>);</span><br><span class="line">            SDL_UnlockMutex(wait_mutex);</span><br><span class="line">            ffp_statistic_l(ffp);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            is-&gt;eof = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkt-&gt;flags &amp; AV_PKT_FLAG_DISCONTINUITY) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;audio_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                packet_queue_put(&amp;is-&gt;audioq, &amp;flush_pkt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;subtitle_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                packet_queue_put(&amp;is-&gt;subtitleq, &amp;flush_pkt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is-&gt;video_stream &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                packet_queue_put(&amp;is-&gt;videoq, &amp;flush_pkt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* check if packet is in play range specified by user, then queue, otherwise discard */</span></span><br><span class="line">        stream_start_time = ic-&gt;streams[pkt-&gt;stream_index]-&gt;start_time;</span><br><span class="line">        pkt_ts = pkt-&gt;pts == AV_NOPTS_VALUE ? pkt-&gt;dts : pkt-&gt;pts;</span><br><span class="line">        pkt_in_play_range = ffp-&gt;duration == AV_NOPTS_VALUE ||</span><br><span class="line">                (pkt_ts - (stream_start_time != AV_NOPTS_VALUE ? stream_start_time : <span class="number">0</span>)) *</span><br><span class="line">                av_q2d(ic-&gt;streams[pkt-&gt;stream_index]-&gt;time_base) -</span><br><span class="line">                (<span class="keyword">double</span>)(ffp-&gt;start_time != AV_NOPTS_VALUE ? ffp-&gt;start_time : <span class="number">0</span>) / <span class="number">1000000</span></span><br><span class="line">                &lt;= ((<span class="keyword">double</span>)ffp-&gt;duration / <span class="number">1000000</span>);</span><br><span class="line">        <span class="keyword">if</span> (pkt-&gt;stream_index == is-&gt;audio_stream &amp;&amp; pkt_in_play_range) &#123;</span><br><span class="line">            packet_queue_put(&amp;is-&gt;audioq, pkt);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkt-&gt;stream_index == is-&gt;video_stream &amp;&amp; pkt_in_play_range</span><br><span class="line">                   &amp;&amp; !(is-&gt;video_st &amp;&amp; (is-&gt;video_st-&gt;disposition &amp; AV_DISPOSITION_ATTACHED_PIC))) &#123;</span><br><span class="line">            packet_queue_put(&amp;is-&gt;videoq, pkt);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkt-&gt;stream_index == is-&gt;subtitle_stream &amp;&amp; pkt_in_play_range) &#123;</span><br><span class="line">            packet_queue_put(&amp;is-&gt;subtitleq, pkt);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            av_packet_unref(pkt);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ffp_statistic_l(ffp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ffp-&gt;ijkmeta_delay_init &amp;&amp; !init_ijkmeta &amp;&amp;</span><br><span class="line">                (ffp-&gt;first_video_frame_rendered || !is-&gt;video_st) &amp;&amp; (ffp-&gt;first_audio_frame_rendered || !is-&gt;audio_st)) &#123;</span><br><span class="line">            ijkmeta_set_avformat_context_l(ffp-&gt;meta, ic);</span><br><span class="line">            init_ijkmeta = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ffp-&gt;packet_buffering) &#123;</span><br><span class="line">            io_tick_counter = SDL_GetTickHR();</span><br><span class="line">            <span class="keyword">if</span> ((!ffp-&gt;first_video_frame_rendered &amp;&amp; is-&gt;video_st) || (!ffp-&gt;first_audio_frame_rendered &amp;&amp; is-&gt;audio_st)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">abs</span>((<span class="keyword">int</span>)(io_tick_counter - prev_io_tick_counter)) &gt; FAST_BUFFERING_CHECK_PER_MILLISECONDS) &#123;</span><br><span class="line">                    prev_io_tick_counter = io_tick_counter;</span><br><span class="line">                    ffp-&gt;dcc.current_high_water_mark_in_ms = ffp-&gt;dcc.first_high_water_mark_in_ms;</span><br><span class="line">                    ffp_check_buffering_l(ffp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">abs</span>((<span class="keyword">int</span>)(io_tick_counter - prev_io_tick_counter)) &gt; BUFFERING_CHECK_PER_MILLISECONDS) &#123;</span><br><span class="line">                    prev_io_tick_counter = io_tick_counter;</span><br><span class="line">                    ffp_check_buffering_l(ffp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"> fail:</span><br><span class="line">    <span class="keyword">if</span> (ic &amp;&amp; !is-&gt;ic)</span><br><span class="line">        avformat_close_input(&amp;ic);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ffp-&gt;prepared || !is-&gt;abort_request) &#123;</span><br><span class="line">        ffp-&gt;last_error = last_error;</span><br><span class="line">        ffp_notify_msg2(ffp, FFP_MSG_ERROR, last_error);</span><br><span class="line">    &#125;</span><br><span class="line">    SDL_DestroyMutex(wait_mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 <code>avformat_alloc_context()</code> 方法来初始化 AVFormatContext</li>
<li>调用 <code>avformat_open_input()</code> 方法完成文件的打开和格式的探测</li>
<li>通过 <code>ffp_notify_msg1()</code> 发送 <code>FFP_MSG_OPEN_INPUT</code> 消息</li>
<li>通过 <code>avformat_find_stream_info()</code> 来读媒体文件的 packet</li>
<li>通过 <code>ffp_notify_msg1()</code> 发送 <code>FFP_MSG_FIND_STREAM_INFO</code> 消息</li>
<li>如果是 seek，调用 <code>avformat_seek_file()</code></li>
<li>通过 <code>stream_component_open()</code> 来打开解码器<ul>
<li><code>avcodec_alloc_context3()</code> 创建 AVCodecContext</li>
<li><code>avcodec_parameters_to_context()</code> 设置参数</li>
<li><code>avcodec_find_decoder</code> 匹配最佳解码器</li>
<li><code>avcodec_open2()</code> 打开解码器</li>
<li><code>decoder_start()</code> 创建解码线程 ff_video_dec</li>
</ul>
</li>
<li>通过 <code>ffp_notify_msg1()</code> 发送 <code>FFP_MSG_COMPONENT_OPEN</code> 消息</li>
<li><code>ffp-&gt;prepared = true</code></li>
<li>通过 <code>ffp_notify_msg1()</code> 发送 <code>FFP_MSG_PREPARED</code> 消息</li>
<li>进入 <code>for(;;)</code> 循环，不断 <code>av_read_frame()</code></li>
</ul>
<p><code>FFP_MSG_PREPARED</code> 消息走到 <code>message_loop_n</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">message_loop_n</span><span class="params">(JNIEnv *env, IjkMediaPlayer *mp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    jobject weak_thiz = (jobject) ijkmp_get_weak_thiz(mp);</span><br><span class="line">    JNI_CHECK_GOTO(weak_thiz, env, <span class="literal">NULL</span>, <span class="string">"mpjni: message_loop_n: null weak_thiz"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        AVMessage msg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> retval = ijkmp_get_msg(mp, &amp;msg, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// block-get should never return 0</span></span><br><span class="line">        assert(retval &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> FFP_MSG_PREPARED:</span><br><span class="line">            MPTRACE(<span class="string">"FFP_MSG_PREPARED:\n"</span>);</span><br><span class="line">            post_event(env, weak_thiz, MEDIA_PREPARED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ALOGE(<span class="string">"unknown FFP_MSG_xxx(%d)\n"</span>, msg.what);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        msg_free_res(&amp;msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>ijkmp_get_msg()</code> 方法中通过 <code>ijkmp_change_state_l</code> 将状态改为 <code>MP_STATE_PREPARED</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* need to call msg_free_res for freeing the resouce obtained in msg */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ijkmp_get_msg</span><span class="params">(IjkMediaPlayer *mp, AVMessage *msg, <span class="keyword">int</span> block)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    assert(mp);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> continue_wait_next_msg = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> retval = msg_queue_get(&amp;mp-&gt;ffplayer-&gt;msg_queue, msg, block);</span><br><span class="line">        <span class="keyword">if</span> (retval &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (msg-&gt;what) &#123;</span><br><span class="line">        <span class="keyword">case</span> FFP_MSG_PREPARED:</span><br><span class="line">            MPTRACE(<span class="string">"ijkmp_get_msg: FFP_MSG_PREPARED\n"</span>);</span><br><span class="line">            pthread_mutex_lock(&amp;mp-&gt;mutex);</span><br><span class="line">            <span class="keyword">if</span> (mp-&gt;mp_state == MP_STATE_ASYNC_PREPARING) &#123;</span><br><span class="line">                ijkmp_change_state_l(mp, MP_STATE_PREPARED);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">FIXME:</span> 1: onError() ?</span></span><br><span class="line">                av_log(mp-&gt;ffplayer, AV_LOG_DEBUG, <span class="string">"FFP_MSG_PREPARED: expecting mp_state==MP_STATE_ASYNC_PREPARING\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!mp-&gt;ffplayer-&gt;start_on_prepared) &#123;</span><br><span class="line">                ijkmp_change_state_l(mp, MP_STATE_PAUSED);</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(&amp;mp-&gt;mutex);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (continue_wait_next_msg) &#123;</span><br><span class="line">            msg_free_res(msg);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时通过 <code>post_event()</code> 将消息传递给 java 层</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">post_event</span><span class="params">(JNIEnv *env, jobject weak_this, <span class="keyword">int</span> what, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// MPTRACE("post_event(%p, %p, %d, %d, %d)", (void*)env, (void*) weak_this, what, arg1, arg2);</span></span><br><span class="line">    J4AC_IjkMediaPlayer__postEventFromNative(env, weak_this, what, arg1, arg2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// MPTRACE("post_event()=void");</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应到 java 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title">AbstractMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Called from native code when an interesting event happens. This method</span><br><span class="line">     * just uses the EventHandler system to post the event back to the main app</span><br><span class="line">     * thread. We use a weak reference to the original IjkMediaPlayer object so</span><br><span class="line">     * that the native code is safe from the object disappearing from underneath</span><br><span class="line">     * it. (This is the cookie passed to native_setup().)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@CalledByNative</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">postEventFromNative</span><span class="params">(Object weakThiz, <span class="keyword">int</span> what,</span><br><span class="line">            <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (weakThiz == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">        IjkMediaPlayer mp = (IjkMediaPlayer) ((WeakReference) weakThiz).get();</span><br><span class="line">        <span class="keyword">if</span> (mp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (what == MEDIA_INFO &amp;&amp; arg1 == MEDIA_INFO_STARTED_AS_NEXT) &#123;</span><br><span class="line">            <span class="comment">// this acquires the wakelock if needed, and sets the client side</span></span><br><span class="line">            <span class="comment">// state</span></span><br><span class="line">            mp.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mp.mEventHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Message m = mp.mEventHandler.obtainMessage(what, arg1, arg2, obj);</span><br><span class="line">            mp.mEventHandler.sendMessage(m);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;IjkMediaPlayer&gt; mWeakPlayer;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EventHandler</span><span class="params">(IjkMediaPlayer mp, Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">            mWeakPlayer = <span class="keyword">new</span> WeakReference&lt;IjkMediaPlayer&gt;(mp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            IjkMediaPlayer player = mWeakPlayer.get();</span><br><span class="line">            <span class="keyword">if</span> (player == <span class="keyword">null</span> || player.mNativeMediaPlayer == <span class="number">0</span>) &#123;</span><br><span class="line">                DebugLog.w(TAG,</span><br><span class="line">                        <span class="string">"IjkMediaPlayer went away with unhandled events"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MEDIA_PREPARED:</span><br><span class="line">                player.notifyOnPrepared();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_PLAYBACK_COMPLETE:</span><br><span class="line">                player.stayAwake(<span class="keyword">false</span>);</span><br><span class="line">                player.notifyOnCompletion();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_BUFFERING_UPDATE:</span><br><span class="line">                <span class="keyword">long</span> bufferPosition = msg.arg1;</span><br><span class="line">                <span class="keyword">if</span> (bufferPosition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    bufferPosition = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">long</span> percent = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">long</span> duration = player.getDuration();</span><br><span class="line">                <span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    percent = bufferPosition * <span class="number">100</span> / duration;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (percent &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">                    percent = <span class="number">100</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// DebugLog.efmt(TAG, "Buffer (%d%%) %d/%d",  percent, bufferPosition, duration);</span></span><br><span class="line">                player.notifyOnBufferingUpdate((<span class="keyword">int</span>)percent);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_SEEK_COMPLETE:</span><br><span class="line">                player.notifyOnSeekComplete();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_SET_VIDEO_SIZE:</span><br><span class="line">                player.mVideoWidth = msg.arg1;</span><br><span class="line">                player.mVideoHeight = msg.arg2;</span><br><span class="line">                player.notifyOnVideoSizeChanged(player.mVideoWidth, player.mVideoHeight,</span><br><span class="line">                        player.mVideoSarNum, player.mVideoSarDen);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_ERROR:</span><br><span class="line">                DebugLog.e(TAG, <span class="string">"Error ("</span> + msg.arg1 + <span class="string">","</span> + msg.arg2 + <span class="string">")"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!player.notifyOnError(msg.arg1, msg.arg2)) &#123;</span><br><span class="line">                    player.notifyOnCompletion();</span><br><span class="line">                &#125;</span><br><span class="line">                player.stayAwake(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_INFO:</span><br><span class="line">                <span class="keyword">switch</span> (msg.arg1) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MEDIA_INFO_VIDEO_RENDERING_START:</span><br><span class="line">                        DebugLog.i(TAG, <span class="string">"Info: MEDIA_INFO_VIDEO_RENDERING_START\n"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                player.notifyOnInfo(msg.arg1, msg.arg2);</span><br><span class="line">                <span class="comment">// No real default action so far.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">case</span> MEDIA_TIMED_TEXT:</span><br><span class="line">                <span class="keyword">if</span> (msg.obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    player.notifyOnTimedText(<span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    IjkTimedText text = <span class="keyword">new</span> IjkTimedText(<span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>), (String)msg.obj);</span><br><span class="line">                    player.notifyOnTimedText(text);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">case</span> MEDIA_NOP: <span class="comment">// interface test message - ignore</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MEDIA_SET_VIDEO_SAR:</span><br><span class="line">                player.mVideoSarNum = msg.arg1;</span><br><span class="line">                player.mVideoSarDen = msg.arg2;</span><br><span class="line">                player.notifyOnVideoSizeChanged(player.mVideoWidth, player.mVideoHeight,</span><br><span class="line">                        player.mVideoSarNum, player.mVideoSarDen);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                DebugLog.e(TAG, <span class="string">"Unknown message type "</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终通过 <code>player.notifyOnPrepared()</code> 回调出去</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/03/10/ijkplayer-ffmpeg-avcodec-decode-video2/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yydcdut.com">yydcdut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>