<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> OkHttp - CacheInterceptor源码简析 · Android杂文 - yydcdut</title><meta name="description" content="OkHttp - CacheInterceptor源码简析 - yydcdut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yydcdut.com/atom.xml" title="Android杂文 - yydcdut"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut/yydcdut.github.io/issues" target="_blank" class="nav-list-link">COMMENT</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">OkHttp - CacheInterceptor源码简析</h1><div class="post-info">2019年7月10日</div><div class="post-content"><blockquote>
<p>Github: <a href="https://github.com/square/okhttp" target="_blank" rel="external">okhttp</a>      分析版本：<a href="https://github.com/square/okhttp/tree/930d4d07d836aef3c2681867d6ab9e73c23aacfb" target="_blank" rel="external">930d4d0</a></p>
</blockquote>
<p>Serves requests from the cache and writes responses to the cache</p>
<a id="more"></a>
<h2 id="HTTP-缓存"><a href="#HTTP-缓存" class="headerlink" title="HTTP 缓存"></a>HTTP 缓存</h2><h3 id="Expires-强制缓存"><a href="#Expires-强制缓存" class="headerlink" title="Expires (强制缓存)"></a>Expires (强制缓存)</h3><p>Expires 的值为服务端返回的到期时间，即下一次请求时请求时间小于服务端返回的到期时间则直接使用缓存数据</p>
<p>Expires 是 HTTP 1.0 的产物，在 HTTP 1.1 中用 Cache-Control 替代</p>
<h3 id="Cache-Control-强制缓存"><a href="#Cache-Control-强制缓存" class="headerlink" title="Cache-Control (强制缓存)"></a>Cache-Control (强制缓存)</h3><p>Cache-Control 的取值有 private、public、no-cache、max-age，no-store 等，默认为private</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>private</td>
<td>表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）</td>
</tr>
<tr>
<td>public</td>
<td>表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存</td>
</tr>
<tr>
<td>no-cache</td>
<td>在发布缓存副本之前，强制要求缓存把请求提交给原始服务器进行验证</td>
</tr>
<tr>
<td>no-store</td>
<td>缓存不应存储有关客户端请求或服务器响应的任何内容</td>
</tr>
<tr>
<td>max-age=<seconds></seconds></td>
<td>设置缓存存储的最大周期，超过这个时间缓存被认为过期</td>
</tr>
<tr>
<td>s-maxage=<seconds></seconds></td>
<td>覆盖<code>max-age</code>或者<code>Expires</code>头，但是仅适用于共享缓存</td>
</tr>
<tr>
<td>max-stale[=<seconds>]</seconds></td>
<td>表明客户端愿意接收一个已经过期的资源。可以设置一个可选的秒数，表示响应不能已经过时超过该给定的时间</td>
</tr>
<tr>
<td>min-fresh=<seconds></seconds></td>
<td>表示客户端希望获取一个能在指定的秒数内保持其最新状态的响应</td>
</tr>
</tbody>
</table>
<h3 id="Last-Modified-对比缓存"><a href="#Last-Modified-对比缓存" class="headerlink" title="Last-Modified (对比缓存)"></a>Last-Modified (对比缓存)</h3><p>服务器在响应请求时，告诉浏览器资源的最后修改时间</p>
<h3 id="If-Modified-Since-对比缓存"><a href="#If-Modified-Since-对比缓存" class="headerlink" title="If-Modified-Since (对比缓存)"></a>If-Modified-Since (对比缓存)</h3><p>再次请求服务器时，通过此字段通知服务器上次请求时间，服务器返回的资源最后修改时间，服务器收到请求后发现有头If-Modified-Since 则与被请求资源的最后修改时间进行比对</p>
<ul>
<li>若资源的最后修改时间大于 If-Modified-Since ，说明资源又被改动过，则响应整片资源内容，返回状态码 200</li>
<li>若资源的最后修改时间小于或等于 If-Modified-Since ，说明资源无新修改，则响应 HTTP 304，告知浏览器继续使用所保存的 Cache</li>
</ul>
<h3 id="Etag-对比缓存"><a href="#Etag-对比缓存" class="headerlink" title="Etag (对比缓存)"></a>Etag (对比缓存)</h3><p>服务器响应请求时，告诉浏览器当前资源在服务器的唯一标识（生成规则由服务器决定）</p>
<h3 id="If-None-Match-对比缓存"><a href="#If-None-Match-对比缓存" class="headerlink" title="If-None-Match  (对比缓存)"></a>If-None-Match  (对比缓存)</h3><p>再次请求服务器时，通过此字段通知服务器客户段缓存数据的唯一标识，服务器收到请求后发现有头 If-None-Match 则与被请求资源的唯一标识进行比对</p>
<ul>
<li>不同，说明资源又被改动过，则响应整片资源内容，返回状态码 200</li>
<li>相同，说明资源无新修改，则响应 HTTP 304，告知浏览器继续使用所保存的 Cache</li>
</ul>
<p><img src="http://yydcdut.com/img/okhttp-cache-interceptor-http-header-cache.png" alt="http://yydcdut.com/img/okhttp-cache-interceptor-http-header-cache.png"></p>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="intercept-chain-Interceptor-Chain"><a href="#intercept-chain-Interceptor-Chain" class="headerlink" title="intercept(chain: Interceptor.Chain)"></a>intercept(chain: Interceptor.Chain)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheInterceptor</span></span>(internal <span class="variable"><span class="keyword">val</span> cache</span>: InternalCache?) : Interceptor &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="typename">Interceptor.Chain</span>)</span>: Response &#123;</span></span><br><span class="line">    <span class="comment">// 从本地获取</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> cacheCandidate</span> = cache?.<span class="keyword">get</span>(chain.request())</span><br><span class="line"></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> now</span> = System.currentTimeMillis()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 response 中 header 缓存信息返回策略，判断是使用缓存还是请求网络获取新的数据</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> strategy</span> = CacheStrategy.Factory(now, chain.request(), cacheCandidate).compute()</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> networkRequest</span> = strategy.networkRequest <span class="comment">// 若是不为 null ，表示需要进行网络请求</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> cacheResponse</span> = strategy.cacheResponse <span class="comment">// 若是不为 null ，表示可以使用本地缓存</span></span><br><span class="line"></span><br><span class="line">    cache?.trackResponse(strategy)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存的 response 不适用</span></span><br><span class="line">    <span class="keyword">if</span> (cacheCandidate != <span class="literal">null</span> &amp;&amp; cacheResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The cache candidate wasn't applicable. Close it.</span></span><br><span class="line">      cacheCandidate.body()?.closeQuietly()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不允许使用网络并且缓存为空，新建一个 504 的 Resposne 返回</span></span><br><span class="line">    <span class="comment">// If we're forbidden from using the network and the cache is insufficient, fail.</span></span><br><span class="line">    <span class="keyword">if</span> (networkRequest == <span class="literal">null</span> &amp;&amp; cacheResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Response.Builder()</span><br><span class="line">          .request(chain.request())</span><br><span class="line">          .protocol(Protocol.HTTP_1_1)</span><br><span class="line">          .code(HTTP_GATEWAY_TIMEOUT)</span><br><span class="line">          .message(<span class="string">"Unsatisfiable Request (only-if-cached)"</span>)</span><br><span class="line">          .body(EMPTY_RESPONSE)</span><br><span class="line">          .sentRequestAtMillis(-<span class="number">1</span>L)</span><br><span class="line">          .receivedResponseAtMillis(System.currentTimeMillis())</span><br><span class="line">          .build()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不需要网络访问，返回 cache response</span></span><br><span class="line">    <span class="comment">// If we don't need the network, we're done.</span></span><br><span class="line">    <span class="keyword">if</span> (networkRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cacheResponse!!.newBuilder()</span><br><span class="line">          .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">          .build()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 丢给下一个拦截器</span></span><br><span class="line">    <span class="variable"><span class="keyword">var</span> networkResponse</span>: Response? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      networkResponse = chain.proceed(networkRequest)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// If we're crashing on I/O or otherwise, don't leak the cache body.</span></span><br><span class="line">      <span class="keyword">if</span> (networkResponse == <span class="literal">null</span> &amp;&amp; cacheCandidate != <span class="literal">null</span>) &#123;</span><br><span class="line">        cacheCandidate.body()?.closeQuietly()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当缓存响应和网络响应同时存在的时候</span></span><br><span class="line">    <span class="comment">// If we have a cache response too, then we're doing a conditional get.</span></span><br><span class="line">    <span class="keyword">if</span> (cacheResponse != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (networkResponse?.code() == HTTP_NOT_MODIFIED) &#123; <span class="comment">// 返回 304</span></span><br><span class="line">        <span class="comment">// 使用缓存的响应</span></span><br><span class="line">        <span class="variable"><span class="keyword">val</span> response</span> = cacheResponse.newBuilder()</span><br><span class="line">            .headers(combine(cacheResponse.headers(), networkResponse.headers()))</span><br><span class="line">            .sentRequestAtMillis(networkResponse.sentRequestAtMillis())</span><br><span class="line">            .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())</span><br><span class="line">            .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">            .networkResponse(stripBody(networkResponse))</span><br><span class="line">            .build()</span><br><span class="line"></span><br><span class="line">        networkResponse.body()!!.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the cache after combining headers but before stripping the</span></span><br><span class="line">        <span class="comment">// Content-Encoding header (as performed by initContentStream()).</span></span><br><span class="line">        cache!!.trackConditionalCacheHit()</span><br><span class="line">        cache.update(cacheResponse, response)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cacheResponse.body()?.closeQuietly()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用网络响应</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> response</span> = networkResponse!!.newBuilder()</span><br><span class="line">        .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">        .networkResponse(stripBody(networkResponse))</span><br><span class="line">        .build()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存 response</span></span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (response.promisesBody() &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) &#123;</span><br><span class="line">        <span class="comment">// Offer this request to the cache.</span></span><br><span class="line">        <span class="variable"><span class="keyword">val</span> cacheRequest</span> = cache.put(response)</span><br><span class="line">        <span class="keyword">return</span> cacheWritingResponse(cacheRequest, response)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只缓存GET....不然移除request</span></span><br><span class="line">      <span class="keyword">if</span> (HttpMethod.invalidatesCache(networkRequest.method)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          cache.remove(networkRequest)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (_: IOException) &#123;</span><br><span class="line">          <span class="comment">// The cache cannot be written.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 Request 尝试到 cache 中拿缓存</li>
<li>根据 response , time , request 创建一个缓存策略，用于判断怎样使用缓存</li>
<li>如果缓存策略中设置禁止使用网络，并且缓存又为空，则构建一个 504 的 Resposne 直接返回</li>
<li>缓存策略中设置不使用网络但有缓存，直接返回缓存</li>
<li>接着走后续拦截器的流程，chain.proceed(networkRequest)</li>
<li>当缓存存在的时候，如果网络返回的 304 Resposne，则使用缓存的 Resposne</li>
<li>构建网络请求的 Response</li>
<li>将 Response 缓存起来</li>
<li>返回 Response</li>
</ul>
<p>这里的 cache 是 <code>InternalCache</code> 类型</p>
<h3 id="InternalCache"><a href="#InternalCache" class="headerlink" title="InternalCache"></a>InternalCache</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">interface InternalCache &#123;</span><br><span class="line"></span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(request: <span class="typename">Request</span>)</span>: Response?</span></span><br><span class="line"></span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">put</span><span class="params">(response: <span class="typename">Response</span>)</span>: CacheRequest?</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Remove any cache entries for the supplied [request]. This is invoked when the client</span><br><span class="line">   * invalidates the cache, such as when making POST requests.</span><br><span class="line">   */</span></span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">remove</span><span class="params">(request: <span class="typename">Request</span>)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Handles a conditional request hit by updating the stored cache response with the headers from</span><br><span class="line">   * [network]. The cached response body is not updated. If the stored response has changed</span><br><span class="line">   * since [cached] was returned, this does nothing.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(cached: <span class="typename">Response, network: Response</span>)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Track an conditional GET that was satisfied by this cache. */</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">trackConditionalCacheHit</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Track an HTTP response being satisfied with [cacheStrategy]. */</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">trackResponse</span><span class="params">(cacheStrategy: <span class="typename">CacheStrategy</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>InternalCache</code> 是一个接口，利用了面向接口编程的方式，接着查找哪个实现了或者说使用了这个接口，对应找到了<code>Cache</code> 这个类</p>
<h3 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> <span class="title">internal</span> <span class="title">constructor</span></span>(</span><br><span class="line">  directory: File,</span><br><span class="line">  maxSize: <span class="typename">Long</span>,</span><br><span class="line">  fileSystem: FileSystem</span><br><span class="line">) : Closeable, Flushable &#123;</span><br><span class="line">  internal <span class="variable"><span class="keyword">val</span> internalCache</span>: InternalCache = <span class="keyword">object</span> : InternalCache &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(request: <span class="typename">Request</span>)</span>: Response? &#123;</span></span><br><span class="line">      <span class="keyword">return</span> this@Cache.<span class="keyword">get</span>(request)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">put</span><span class="params">(response: <span class="typename">Response</span>)</span>: CacheRequest? &#123;</span></span><br><span class="line">      <span class="keyword">return</span> this@Cache.put(response)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">remove</span><span class="params">(request: <span class="typename">Request</span>)</span> &#123;</span></span><br><span class="line">      this@Cache.remove(request)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(cached: <span class="typename">Response, network: Response</span>)</span> &#123;</span></span><br><span class="line">      this@Cache.update(cached, network)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">trackConditionalCacheHit</span><span class="params">()</span> &#123;</span></span><br><span class="line">      this@Cache.trackConditionalCacheHit()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">trackResponse</span><span class="params">(cacheStrategy: <span class="typename">CacheStrategy</span>)</span> &#123;</span></span><br><span class="line">      this@Cache.trackResponse(cacheStrategy)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  internal <span class="variable"><span class="keyword">val</span> cache</span>: DiskLruCache</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Create a cache of at most `maxSize` bytes in `directory`. */</span></span><br><span class="line">  constructor(directory: File, maxSize: <span class="typename">Long</span>) : this(directory, maxSize, FileSystem.SYSTEM)</span><br><span class="line"></span><br><span class="line">  init &#123;</span><br><span class="line">    this.cache = DiskLruCache.create(fileSystem, directory, VERSION, ENTRY_COUNT, maxSize)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内部现实是 <code>DiskLruCache</code></p>
<h3 id="CacheStrategy"><a href="#CacheStrategy" class="headerlink" title="CacheStrategy"></a>CacheStrategy</h3><p>CacheStrategy 是一个策略器，负责判断是使用缓存还是请求网络获取新的数据，通过工厂创建</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheStrategy</span> <span class="title">internal</span> <span class="title">constructor</span></span>(</span><br><span class="line">  <span class="comment">/** The request to send on the network, or null if this call doesn't use the network. */</span></span><br><span class="line">  <span class="variable"><span class="keyword">val</span> networkRequest</span>: Request?,</span><br><span class="line">  <span class="comment">/** The cached response to return or validate; or null if this call doesn't use a cache. */</span></span><br><span class="line">  <span class="variable"><span class="keyword">val</span> cacheResponse</span>: Response?</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Factory</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> nowMillis</span>: <span class="typename">Long</span>,</span><br><span class="line">    internal <span class="variable"><span class="keyword">val</span> request</span>: Request,</span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> cacheResponse</span>: Response?</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">/** The server's time when the cached response was served, if known. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> servedDate</span>: Date? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> servedDateString</span>: String? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The last modified date of the cached response, if known. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> lastModified</span>: Date? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> lastModifiedString</span>: String? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The expiration date of the cached response, if known. If both this field and the max age are</span><br><span class="line">     * set, the max age is preferred.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> expires</span>: Date? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Extension header set by OkHttp specifying the timestamp when the cached HTTP request was</span><br><span class="line">     * first initiated.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> sentRequestMillis</span> = <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Extension header set by OkHttp specifying the timestamp when the cached HTTP response was</span><br><span class="line">     * first received.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> receivedResponseMillis</span> = <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Etag of the cached response. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> etag</span>: String? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Age of the cached response. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">var</span> ageSeconds</span> = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns true if computeFreshnessLifetime used a heuristic. If we used a heuristic to serve a</span><br><span class="line">     * cached response older than 24 hours, we are required to attach a warning.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isFreshnessLifetimeHeuristic</span><span class="params">()</span>: Boolean &#123;</span></span><br><span class="line">      <span class="keyword">return</span> cacheResponse!!.cacheControl().maxAgeSeconds == -<span class="number">1</span> &amp;&amp; expires == <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">      <span class="comment">// 在 cacheResponse 缓存不为空的请求，将头信息取出</span></span><br><span class="line">      <span class="keyword">if</span> (cacheResponse != <span class="literal">null</span>) &#123;</span><br><span class="line">        this.sentRequestMillis = cacheResponse.sentRequestAtMillis()</span><br><span class="line">        this.receivedResponseMillis = cacheResponse.receivedResponseAtMillis()</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> headers</span> = cacheResponse.headers()</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until headers.size) &#123;</span><br><span class="line">          <span class="variable"><span class="keyword">val</span> fieldName</span> = headers.name(i)</span><br><span class="line">          <span class="variable"><span class="keyword">val</span> value</span> = headers.value(i)</span><br><span class="line">          <span class="keyword">when</span> &#123;</span><br><span class="line">            <span class="comment">// Date</span></span><br><span class="line">            fieldName.equals(<span class="string">"Date"</span>, ignoreCase = <span class="literal">true</span>) -&gt; &#123;</span><br><span class="line">              servedDate = HttpDate.parse(value)</span><br><span class="line">              servedDateString = value</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Expires </span></span><br><span class="line">            fieldName.equals(<span class="string">"Expires"</span>, ignoreCase = <span class="literal">true</span>) -&gt; &#123;</span><br><span class="line">              expires = HttpDate.parse(value)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Last-Modified</span></span><br><span class="line">            fieldName.equals(<span class="string">"Last-Modified"</span>, ignoreCase = <span class="literal">true</span>) -&gt; &#123;</span><br><span class="line">              lastModified = HttpDate.parse(value)</span><br><span class="line">              lastModifiedString = value</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ETag</span></span><br><span class="line">            fieldName.equals(<span class="string">"ETag"</span>, ignoreCase = <span class="literal">true</span>) -&gt; &#123;</span><br><span class="line">              etag = value</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Age</span></span><br><span class="line">            fieldName.equals(<span class="string">"Age"</span>, ignoreCase = <span class="literal">true</span>) -&gt; &#123;</span><br><span class="line">              ageSeconds = value.toNonNegativeInt(-<span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>CacheStrategy.Factory</code> 的构造函数中</p>
<h3 id="CacheStrategy-Factory-compute"><a href="#CacheStrategy-Factory-compute" class="headerlink" title="CacheStrategy.Factory#compute()"></a>CacheStrategy.Factory#compute()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheStrategy</span> <span class="title">internal</span> <span class="title">constructor</span></span>(</span><br><span class="line">  <span class="comment">/** The request to send on the network, or null if this call doesn't use the network. */</span></span><br><span class="line">  <span class="variable"><span class="keyword">val</span> networkRequest</span>: Request?,</span><br><span class="line">  <span class="comment">/** The cached response to return or validate; or null if this call doesn't use a cache. */</span></span><br><span class="line">  <span class="variable"><span class="keyword">val</span> cacheResponse</span>: Response?</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Factory</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> nowMillis</span>: <span class="typename">Long</span>,</span><br><span class="line">    internal <span class="variable"><span class="keyword">val</span> request</span>: Request,</span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> cacheResponse</span>: Response?</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">/** Returns a strategy to satisfy [request] using [cacheResponse]. */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">compute</span><span class="params">()</span>: CacheStrategy &#123;</span></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> candidate</span> = computeCandidate()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// We're forbidden from using the network and the cache is insufficient.</span></span><br><span class="line">      <span class="keyword">if</span> (candidate.networkRequest != <span class="literal">null</span> &amp;&amp; request.cacheControl.onlyIfCached) &#123;</span><br><span class="line">        <span class="keyword">return</span> CacheStrategy(<span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> candidate</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Returns a strategy to use assuming the request can use the network. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">computeCandidate</span><span class="params">()</span>: CacheStrategy &#123;</span></span><br><span class="line">      <span class="comment">// 没有缓存 Response 的话返回没有 response 的 CacheStrategy</span></span><br><span class="line">      <span class="comment">// No cached response.</span></span><br><span class="line">      <span class="keyword">if</span> (cacheResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CacheStrategy(request, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 若是 Https 且没有经过 handshake 的话，返回没有 response 的 CacheStrategy</span></span><br><span class="line">      <span class="comment">// Drop the cached response if it's missing a required handshake.</span></span><br><span class="line">      <span class="keyword">if</span> (request.isHttps &amp;&amp; cacheResponse.handshake() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CacheStrategy(request, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 是否可缓存，若 cacheResponse 是不可缓存的（通过 response code 以及 cache-control 等判断），则返回没有 response 的 CacheStrategy</span></span><br><span class="line">      <span class="comment">// If this response shouldn't have been stored, it should never be used as a response source.</span></span><br><span class="line">      <span class="comment">// This check should be redundant as long as the persistence store is well-behaved and the</span></span><br><span class="line">      <span class="comment">// rules are constant.</span></span><br><span class="line">      <span class="keyword">if</span> (!isCacheable(cacheResponse, request)) &#123;</span><br><span class="line">        <span class="keyword">return</span> CacheStrategy(request, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// request 请求要求不带缓存，则返回没有 response 的 CacheStrategy</span></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> requestCaching</span> = request.cacheControl</span><br><span class="line">      <span class="keyword">if</span> (requestCaching.noCache || hasConditions(request)) &#123;</span><br><span class="line">        <span class="keyword">return</span> CacheStrategy(request, <span class="literal">null</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> responseCaching</span> = cacheResponse.cacheControl()</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> ageMillis</span> = cacheResponseAge()</span><br><span class="line">      <span class="variable"><span class="keyword">var</span> freshMillis</span> = computeFreshnessLifetime()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (requestCaching.maxAgeSeconds != -<span class="number">1</span>) &#123;</span><br><span class="line">        freshMillis = minOf(freshMillis, SECONDS.toMillis(requestCaching.maxAgeSeconds.toLong()))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">var</span> minFreshMillis</span>: <span class="typename">Long</span> = <span class="number">0</span></span><br><span class="line">      <span class="keyword">if</span> (requestCaching.minFreshSeconds != -<span class="number">1</span>) &#123;</span><br><span class="line">        minFreshMillis = SECONDS.toMillis(requestCaching.minFreshSeconds.toLong())</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">var</span> maxStaleMillis</span>: <span class="typename">Long</span> = <span class="number">0</span></span><br><span class="line">      <span class="keyword">if</span> (!responseCaching.mustRevalidate &amp;&amp; requestCaching.maxStaleSeconds != -<span class="number">1</span>) &#123;</span><br><span class="line">        maxStaleMillis = SECONDS.toMillis(requestCaching.maxStaleSeconds.toLong())</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 满足缓存时间条件，返回没有 reqeust 的 CacheStrategy</span></span><br><span class="line">      <span class="keyword">if</span> (!responseCaching.noCache &amp;&amp; ageMillis + minFreshMillis <span class="type">&lt; freshMillis + maxStaleMillis) &#123;</span><br><span class="line">        val builder = cacheResponse.newBuilder()</span><br><span class="line">        if (ageMillis + minFreshMillis &gt;</span>= freshMillis) &#123;</span><br><span class="line">          builder.addHeader(<span class="string">"Warning"</span>, <span class="string">"110 HttpURLConnection \"Response is stale\""</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> oneDayMillis</span> = <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>L</span><br><span class="line">        <span class="keyword">if</span> (ageMillis &gt; oneDayMillis &amp;&amp; isFreshnessLifetimeHeuristic()) &#123;</span><br><span class="line">          builder.addHeader(<span class="string">"Warning"</span>, <span class="string">"113 HttpURLConnection \"Heuristic expiration\""</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CacheStrategy(<span class="literal">null</span>, builder.build())</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 进行缓存 header 判断</span></span><br><span class="line">      <span class="comment">// Find a condition to add to the request. If the condition is satisfied, the response body</span></span><br><span class="line">      <span class="comment">// will not be transmitted.</span></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> conditionName</span>: String</span><br><span class="line">      <span class="variable"><span class="keyword">val</span> conditionValue</span>: String?</span><br><span class="line">      <span class="keyword">when</span> &#123;</span><br><span class="line">        etag != <span class="literal">null</span> -&gt; &#123;</span><br><span class="line">          conditionName = <span class="string">"If-None-Match"</span></span><br><span class="line">          conditionValue = etag</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastModified != <span class="literal">null</span> -&gt; &#123;</span><br><span class="line">          conditionName = <span class="string">"If-Modified-Since"</span></span><br><span class="line">          conditionValue = lastModifiedString</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        servedDate != <span class="literal">null</span> -&gt; &#123;</span><br><span class="line">          conditionName = <span class="string">"If-Modified-Since"</span></span><br><span class="line">          conditionValue = servedDateString</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> -&gt; <span class="keyword">return</span> CacheStrategy(request, <span class="literal">null</span>) <span class="comment">// No condition! Make a regular request.</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> conditionalRequestHeaders</span> = request.headers.newBuilder()</span><br><span class="line">      addHeaderLenient(conditionalRequestHeaders, conditionName, conditionValue!!)</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> conditionalRequest</span> = request.newBuilder()</span><br><span class="line">          .headers(conditionalRequestHeaders.build())</span><br><span class="line">          .build()</span><br><span class="line">      <span class="keyword">return</span> CacheStrategy(conditionalRequest, cacheResponse)</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns true if the request contains conditions that save the server from sending a response</span><br><span class="line">     * that the client has locally. When a request is enqueued with its own conditions, the built-in</span><br><span class="line">     * response cache won't be used.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hasConditions</span><span class="params">(request: <span class="typename">Request</span>)</span>: Boolean =</span></span><br><span class="line">        request.header(<span class="string">"If-Modified-Since"</span>) != <span class="literal">null</span> || request.header(<span class="string">"If-None-Match"</span>) != <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="comment">/** Returns true if `response` can be stored to later serve another request. */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isCacheable</span><span class="params">(response: <span class="typename">Response, request: Request</span>)</span>: Boolean &#123;</span></span><br><span class="line">      <span class="comment">// Always go to network for uncacheable response codes (RFC 7231 section 6.1), This</span></span><br><span class="line">      <span class="comment">// implementation doesn't support caching partial content.</span></span><br><span class="line">      <span class="keyword">when</span> (response.code()) &#123;</span><br><span class="line">        HTTP_OK, <span class="comment">// 200</span></span><br><span class="line">        HTTP_NOT_AUTHORITATIVE, <span class="comment">// 203</span></span><br><span class="line">        HTTP_NO_CONTENT, <span class="comment">// 204</span></span><br><span class="line">        HTTP_MULT_CHOICE, <span class="comment">// 300</span></span><br><span class="line">        HTTP_MOVED_PERM, <span class="comment">// 301</span></span><br><span class="line">        HTTP_NOT_FOUND, <span class="comment">// 404 </span></span><br><span class="line">        HTTP_BAD_METHOD, <span class="comment">// 405</span></span><br><span class="line">        HTTP_GONE, <span class="comment">// 410</span></span><br><span class="line">        HTTP_REQ_TOO_LONG, <span class="comment">// 414</span></span><br><span class="line">        HTTP_NOT_IMPLEMENTED, <span class="comment">// 501</span></span><br><span class="line">        StatusLine.HTTP_PERM_REDIRECT -&gt; &#123; <span class="comment">// 308</span></span><br><span class="line">          <span class="comment">// These codes can be cached unless headers forbid it.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HTTP_MOVED_TEMP, <span class="comment">// 302</span></span><br><span class="line">        StatusLine.HTTP_TEMP_REDIRECT -&gt; &#123;</span><br><span class="line">          <span class="comment">// These codes can only be cached with the right response headers.</span></span><br><span class="line">          <span class="comment">// http://tools.ietf.org/html/rfc7234#section-3</span></span><br><span class="line">          <span class="comment">// s-maxage is not checked because OkHttp is a private cache that should ignore s-maxage.</span></span><br><span class="line">          <span class="keyword">if</span> (response.header(<span class="string">"Expires"</span>) == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              response.cacheControl().maxAgeSeconds == -<span class="number">1</span> &amp;&amp;</span><br><span class="line">              !response.cacheControl().isPublic &amp;&amp;</span><br><span class="line">              !response.cacheControl().isPrivate) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">          <span class="comment">// All other codes cannot be cached.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// A 'no-store' directive on request or response prevents the response from being cached.</span></span><br><span class="line">      <span class="keyword">return</span> !response.cacheControl().noStore &amp;&amp; !request.cacheControl.noStore</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>cacheResponse 为空，直接使用网络请求</li>
<li><code>isCacheable()</code> 判断 cacheResponse 和 request 是否都支持缓存，只要一个不支持那么直接使用网络请求</li>
<li>requestCaching 判断 noCache 和 判断请求头是否有 If-Modified-Since 和 If-None-Match</li>
<li>判断 cacheResponse 的过期时间（包括 maxStaleMillis 的判断），如果没有过期，则使用 cacheResponse</li>
<li>cacheResponse 过期了，那么如果 cacheResponse 有 eTag/If-None-Match 属性则将其添加到请求头中</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/07/09/okhttp-bridge-interceptor-analyse/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yydcdut.com">yydcdut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>