<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> OkHttp - RetryAndFollowUpInterceptor源码简析 · Android杂文 - yydcdut</title><meta name="description" content="OkHttp - RetryAndFollowUpInterceptor源码简析 - yydcdut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yydcdut.com/atom.xml" title="Android杂文 - yydcdut"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut/yydcdut.github.io/issues" target="_blank" class="nav-list-link">COMMENT</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">OkHttp - RetryAndFollowUpInterceptor源码简析</h1><div class="post-info">2019年7月8日</div><div class="post-content"><blockquote>
<p>Github: <a href="https://github.com/square/okhttp" target="_blank" rel="external">okhttp</a>             分析版本：<a href="https://github.com/square/okhttp/tree/930d4d07d836aef3c2681867d6ab9e73c23aacfb" target="_blank" rel="external">930d4d0</a></p>
</blockquote>
<p>This interceptor recovers from failures and follows redirects as necessary</p>
<a id="more"></a>
<h3 id="intercept-chain-Interceptor-Chain"><a href="#intercept-chain-Interceptor-Chain" class="headerlink" title="intercept(chain: Interceptor.Chain)"></a>intercept(chain: Interceptor.Chain)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryAndFollowUpInterceptor</span></span>(<span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> client</span>: OkHttpClient) : Interceptor &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="typename">Interceptor.Chain</span>)</span>: Response &#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">var</span> request</span> = chain.request()</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> realChain</span> = chain <span class="keyword">as</span> RealInterceptorChain</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> transmitter</span> = realChain.transmitter()</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> followUpCount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable"><span class="keyword">var</span> priorResponse</span>: Response? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="comment">// 为 request 准备 stream</span></span><br><span class="line">      transmitter.prepareToConnect(request)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (transmitter.isCanceled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> IOException(<span class="string">"Canceled"</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">var</span> response</span>: Response</span><br><span class="line">      <span class="variable"><span class="keyword">var</span> success</span> = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 丢给下一个拦截器</span></span><br><span class="line">        response = realChain.proceed(request, transmitter, <span class="literal">null</span>)</span><br><span class="line">        success = <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (e: RouteException) &#123; <span class="comment">// 路由异常 RouteException </span></span><br><span class="line">        <span class="comment">// The attempt to connect via a route failed. The request will not have been sent.</span></span><br><span class="line">        <span class="keyword">if</span> (!recover(e.lastConnectException, transmitter, <span class="literal">false</span>, request)) &#123; <span class="comment">// 检测路由异常是否能重新连接</span></span><br><span class="line">          <span class="keyword">throw</span> e.firstConnectException</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span> <span class="comment">// 可以重新连接，重新走 while 循环</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (e: IOException) &#123; <span class="comment">// 检测该IO异常是否能重新连接</span></span><br><span class="line">        <span class="comment">// An attempt to communicate with a server failed. The request may have been sent.</span></span><br><span class="line">        <span class="variable"><span class="keyword">val</span> requestSendStarted</span> = e !<span class="keyword">is</span> ConnectionShutdownException</span><br><span class="line">        <span class="keyword">if</span> (!recover(e, transmitter, requestSendStarted, request)) <span class="keyword">throw</span> e</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// The network call threw an exception. Release any resources.</span></span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">          transmitter.exchangeDoneDueToException() <span class="comment">// 释放</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// priorResponse 是用来保存前一个 Resposne 的，当发现需要重定向，则将当前 Resposne 设置给priorResponse，再执行一遍流程，这里可以看到将前一个 Response 和当前的 Resposne 结合在一起了，直到不需要重定向了，则将 priorResponse 和 Resposne 结合起来。</span></span><br><span class="line">      <span class="comment">// Attach the prior response if it exists. Such responses never have a body.</span></span><br><span class="line">      <span class="keyword">if</span> (priorResponse != <span class="literal">null</span>) &#123;</span><br><span class="line">        response = response.newBuilder()</span><br><span class="line">            .priorResponse(priorResponse.newBuilder()</span><br><span class="line">                .body(<span class="literal">null</span>)</span><br><span class="line">                .build())</span><br><span class="line">            .build()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> exchange</span> = response.exchange</span><br><span class="line">      <span class="variable"><span class="keyword">val</span> route</span> = exchange?.connection()?.route()</span><br><span class="line">      <span class="variable"><span class="keyword">val</span> followUp</span> = followUpRequest(response, route) <span class="comment">// 判断是否需要重定向,如果需要重定向则返回一个重定向的 Request，没有则为 null</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (followUp == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 不需要重定向</span></span><br><span class="line">        <span class="keyword">if</span> (exchange != <span class="literal">null</span> &amp;&amp; exchange.isDuplex) &#123;</span><br><span class="line">          transmitter.timeoutEarlyExit()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回 response</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 需要重定向</span></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> followUpBody</span> = followUp.body</span><br><span class="line">      <span class="keyword">if</span> (followUpBody != <span class="literal">null</span> &amp;&amp; followUpBody.isOneShot()) &#123;</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 关闭响应流</span></span><br><span class="line">      response.body()?.closeQuietly()</span><br><span class="line">      <span class="keyword">if</span> (transmitter.hasExchange()) &#123;</span><br><span class="line">        exchange?.detachWithViolence()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 重定向次数++,并且小于最大重定向次数MAX_FOLLOW_UPS（20）</span></span><br><span class="line">      <span class="keyword">if</span> (++followUpCount &gt; MAX_FOLLOW_UPS) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ProtocolException(<span class="string">"Too many follow-up requests: $followUpCount"</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      request = followUp</span><br><span class="line">      priorResponse = response</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RouteException</code> 和 <code>IOException</code> 异常检测都会调用 <code>recover()</code> 方法进行判断重试</p>
<h3 id="recover-e-IOException-transmitter-Transmitter-requestSendStarted-Boolean-userRequest-Request"><a href="#recover-e-IOException-transmitter-Transmitter-requestSendStarted-Boolean-userRequest-Request" class="headerlink" title="recover(e: IOException, transmitter: Transmitter, requestSendStarted: Boolean, userRequest: Request)"></a>recover(e: IOException, transmitter: Transmitter, requestSendStarted: Boolean, userRequest: Request)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryAndFollowUpInterceptor</span></span>(<span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> client</span>: OkHttpClient) : Interceptor &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Report and attempt to recover from a failure to communicate with a server. Returns true if</span><br><span class="line">   * `e` is recoverable, or false if the failure is permanent. Requests with a body can only</span><br><span class="line">   * be recovered if the body is buffered or if the failure occurred before the request has been</span><br><span class="line">   * sent.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">recover</span><span class="params">(</span><br><span class="line">    e: <span class="typename">IOException,</span><br><span class="line">    transmitter: Transmitter,</span><br><span class="line">    requestSendStarted: Boolean,</span><br><span class="line">    userRequest: Request</span></span><br><span class="line">  )</span>: Boolean &#123;</span></span><br><span class="line">    <span class="comment">// 判断 OkHttpClient 是否支持失败重连的机制</span></span><br><span class="line">    <span class="comment">// The application layer has forbidden retries.</span></span><br><span class="line">    <span class="keyword">if</span> (!client.retryOnConnectionFailure()) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 与之前版本的 UnrepeatableRequestBody 类似，只能请求一次的请求</span></span><br><span class="line">    <span class="comment">// We can't send the request body again.</span></span><br><span class="line">    <span class="keyword">if</span> (requestSendStarted &amp;&amp; requestIsOneShot(e, userRequest)) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测该异常是否是致命的</span></span><br><span class="line">    <span class="comment">// This exception is fatal.</span></span><br><span class="line">    <span class="keyword">if</span> (!isRecoverable(e, requestSendStarted)) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否有更多的路线</span></span><br><span class="line">    <span class="comment">// No more routes to attempt.</span></span><br><span class="line">    <span class="keyword">if</span> (!transmitter.canRetry()) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">// For failure recovery, use the same route selector with a new connection.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestIsOneShot</span><span class="params">(e: <span class="typename">IOException, userRequest: Request</span>)</span>: Boolean &#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> requestBody</span> = userRequest.body</span><br><span class="line">    <span class="keyword">return</span> (requestBody != <span class="literal">null</span> &amp;&amp; requestBody.isOneShot()) ||</span><br><span class="line">        e <span class="keyword">is</span> FileNotFoundException</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>判断是否支持失败重连的机制（默认方式创建的话，retryOnConnectionFailure 属性是 true）</li>
<li><code>requestSendStarted</code> 表明请求是否已经被发送，这里这里为 false</li>
<li>通过 <code>isRecoverable()</code> 方法检测该异常是否是致命的</li>
<li>是否有更多的路线可以重试</li>
</ul>
<h3 id="isRecoverable-e-IOException-requestSendStarted-Boolean"><a href="#isRecoverable-e-IOException-requestSendStarted-Boolean" class="headerlink" title="isRecoverable(e: IOException, requestSendStarted: Boolean)"></a>isRecoverable(e: IOException, requestSendStarted: Boolean)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryAndFollowUpInterceptor</span></span>(<span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> client</span>: OkHttpClient) : Interceptor &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isRecoverable</span><span class="params">(e: <span class="typename">IOException, requestSendStarted: Boolean</span>)</span>: Boolean &#123;</span></span><br><span class="line">    <span class="comment">// ProtocolException 属于严重异常，不能进行重新连接</span></span><br><span class="line">    <span class="comment">// If there was a protocol problem, don't recover.</span></span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">is</span> ProtocolException) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当异常为中断异常时</span></span><br><span class="line">    <span class="comment">// If there was an interruption don't recover, but if there was a timeout connecting to a route</span></span><br><span class="line">    <span class="comment">// we should try the next route (if there is one).</span></span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">is</span> InterruptedIOException) &#123;</span><br><span class="line">      <span class="keyword">return</span> e <span class="keyword">is</span> SocketTimeoutException &amp;&amp; !requestSendStarted</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 握手异常</span></span><br><span class="line">    <span class="comment">// Look for known client-side or negotiation errors that are unlikely to be fixed by trying</span></span><br><span class="line">    <span class="comment">// again with a different route.</span></span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">is</span> SSLHandshakeException) &#123;</span><br><span class="line">      <span class="comment">// If the problem was a CertificateException from the X509TrustManager,</span></span><br><span class="line">      <span class="comment">// do not retry.</span></span><br><span class="line">      <span class="keyword">if</span> (e.cause <span class="keyword">is</span> CertificateException) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验证异常</span></span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">is</span> SSLPeerUnverifiedException) &#123;</span><br><span class="line">      <span class="comment">// e.g. a certificate pinning error.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// An example of one we might want to retry with a different route is a problem connecting to a</span></span><br><span class="line">    <span class="comment">// proxy and would manifest as a standard IOException. Unless it is one we know we should not</span></span><br><span class="line">    <span class="comment">// retry, we return true and try a new route.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>协议问题，不能重试</li>
<li>如果是超时问题，并且请求没有被发送，可以重试，其他的就不要重试了</li>
<li>安全问题，不要重试</li>
</ul>
<h3 id="Transmitter-canRetry"><a href="#Transmitter-canRetry" class="headerlink" title="Transmitter#canRetry()"></a>Transmitter#canRetry()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transmitter</span></span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> client</span>: OkHttpClient,</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> call</span>: Call</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">canRetry</span><span class="params">()</span>: Boolean &#123;</span></span><br><span class="line">    <span class="keyword">return</span> exchangeFinder!!.hasStreamFailure() &amp;&amp; exchangeFinder!!.hasRouteToTry()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进到 <code>ExchangeFinder</code> 中：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExchangeFinder</span></span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> transmitter</span>: Transmitter,</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> connectionPool</span>: RealConnectionPool,</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> address</span>: Address,</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> call</span>: Call,</span><br><span class="line">  <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> eventListener</span>: EventListener</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** Returns true if a current route is still good or if there are routes we haven't tried yet. */</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">hasRouteToTry</span><span class="params">()</span>: Boolean &#123;</span></span><br><span class="line">    synchronized(connectionPool) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextRouteToTry != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (retryCurrentRoute()) &#123;</span><br><span class="line">        <span class="comment">// Lock in the route because retryCurrentRoute() is racy and we don't want to call it twice.</span></span><br><span class="line">        nextRouteToTry = transmitter.connection!!.route()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (routeSelection?.hasNext() ?: <span class="literal">false</span>) || routeSelector.hasNext()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Return true if the route used for the current connection should be retried, even if the</span><br><span class="line">   * connection itself is unhealthy. The biggest gotcha here is that we shouldn't reuse routes from</span><br><span class="line">   * coalesced connections.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">retryCurrentRoute</span><span class="params">()</span>: Boolean &#123;</span></span><br><span class="line">    <span class="keyword">return</span> transmitter.connection != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        transmitter.connection!!.routeFailureCount == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        transmitter.connection!!.route().address().url.canReuseConnectionFor(address.url)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找相同 address 的链接</p>
<h3 id="followUpRequest-userResponse-Response-route-Route"><a href="#followUpRequest-userResponse-Response-route-Route" class="headerlink" title="followUpRequest(userResponse: Response, route: Route?)"></a>followUpRequest(userResponse: Response, route: Route?)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryAndFollowUpInterceptor</span></span>(<span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> client</span>: OkHttpClient) : Interceptor &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Figures out the HTTP request to make in response to receiving `userResponse`. This will</span><br><span class="line">   * either add authentication headers, follow redirects or handle a client request timeout. If a</span><br><span class="line">   * follow-up is either unnecessary or not applicable, this returns null.</span><br><span class="line">   */</span></span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">followUpRequest</span><span class="params">(userResponse: <span class="typename">Response, route: Route?</span>)</span>: Request? &#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> responseCode</span> = userResponse.code()</span><br><span class="line"></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> method</span> = userResponse.request().method</span><br><span class="line">    <span class="keyword">when</span> (responseCode) &#123;</span><br><span class="line">      <span class="comment">// 407</span></span><br><span class="line">      HTTP_PROXY_AUTH -&gt; &#123; </span><br><span class="line">        <span class="variable"><span class="keyword">val</span> selectedProxy</span> = route!!.proxy()</span><br><span class="line">        <span class="keyword">if</span> (selectedProxy.type() != Proxy.Type.HTTP) &#123;</span><br><span class="line">          <span class="keyword">throw</span> ProtocolException(<span class="string">"Received HTTP_PROXY_AUTH (407) code while not using proxy"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> client.proxyAuthenticator().authenticate(route, userResponse)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 401</span></span><br><span class="line">      HTTP_UNAUTHORIZED -&gt; <span class="keyword">return</span> client.authenticator().authenticate(route, userResponse)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 308, 307</span></span><br><span class="line">      HTTP_PERM_REDIRECT, HTTP_TEMP_REDIRECT -&gt; &#123;</span><br><span class="line">        <span class="comment">// "If the 307 or 308 status code is received in response to a request other than GET</span></span><br><span class="line">        <span class="comment">// or HEAD, the user agent MUST NOT automatically redirect the request"</span></span><br><span class="line">        <span class="keyword">if</span> (method != <span class="string">"GET"</span> &amp;&amp; method != <span class="string">"HEAD"</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buildRedirectRequest(userResponse, method)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 300, 301, 302, 303</span></span><br><span class="line">      HTTP_MULT_CHOICE, HTTP_MOVED_PERM, HTTP_MOVED_TEMP, HTTP_SEE_OTHER -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> buildRedirectRequest(userResponse, method)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 408</span></span><br><span class="line">      HTTP_CLIENT_TIMEOUT -&gt; &#123;</span><br><span class="line">        <span class="comment">// 408's are rare in practice, but some servers like HAProxy use this response code. The</span></span><br><span class="line">        <span class="comment">// spec says that we may repeat the request without modifications. Modern browsers also</span></span><br><span class="line">        <span class="comment">// repeat the request (even non-idempotent ones.)</span></span><br><span class="line">        <span class="keyword">if</span> (!client.retryOnConnectionFailure()) &#123;</span><br><span class="line">          <span class="comment">// The application layer has directed us not to retry the request.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable"><span class="keyword">val</span> requestBody</span> = userResponse.request().body</span><br><span class="line">        <span class="keyword">if</span> (requestBody != <span class="literal">null</span> &amp;&amp; requestBody.isOneShot()) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> priorResponse</span> = userResponse.priorResponse()</span><br><span class="line">        <span class="keyword">if</span> (priorResponse != <span class="literal">null</span> &amp;&amp; priorResponse.code() == HTTP_CLIENT_TIMEOUT) &#123;</span><br><span class="line">          <span class="comment">// We attempted to retry and got another timeout. Give up.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retryAfter(userResponse, <span class="number">0</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userResponse.request()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 503</span></span><br><span class="line">      HTTP_UNAVAILABLE -&gt; &#123;</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> priorResponse</span> = userResponse.priorResponse()</span><br><span class="line">        <span class="keyword">if</span> (priorResponse != <span class="literal">null</span> &amp;&amp; priorResponse.code() == HTTP_UNAVAILABLE) &#123;</span><br><span class="line">          <span class="comment">// We attempted to retry and got another timeout. Give up.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retryAfter(userResponse, Integer.MAX_VALUE) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// specifically received an instruction to retry without delay</span></span><br><span class="line">          <span class="keyword">return</span> userResponse.request()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> -&gt; <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当返回码满足某些条件时就重新构造一个 Request，不满足就返回 null</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (followUp == <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (exchange != <span class="literal">null</span> &amp;&amp; exchange.isDuplex) &#123;</span><br><span class="line">    transmitter.timeoutEarlyExit()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> response</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当不需要重定向，也就是返回的为 null ，直接返回 response</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/07/09/okhttp-bridge-interceptor-analyse/" class="prev">PREV</a><a href="/2019/07/07/okhttp-analyse/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yydcdut.com">yydcdut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>