<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> OkHttp - BridgeInterceptor源码简析 · Android杂文 - yydcdut</title><meta name="description" content="OkHttp - BridgeInterceptor源码简析 - yydcdut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yydcdut.com/atom.xml" title="Android杂文 - yydcdut"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut/yydcdut.github.io/issues" target="_blank" class="nav-list-link">COMMENT</a></li><li class="nav-list-item"><a href="https://github.com/yydcdut" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">OkHttp - BridgeInterceptor源码简析</h1><div class="post-info">2019年7月9日</div><div class="post-content"><blockquote>
<p>Github: <a href="https://github.com/square/okhttp" target="_blank" rel="external">okhttp</a>      分析版本：<a href="https://github.com/square/okhttp/tree/930d4d07d836aef3c2681867d6ab9e73c23aacfb" target="_blank" rel="external">930d4d0</a></p>
</blockquote>
<p>Bridges from application code to network code</p>
<a id="more"></a>
<h3 id="intercept-chain-Interceptor-Chain"><a href="#intercept-chain-Interceptor-Chain" class="headerlink" title="intercept(chain: Interceptor.Chain)"></a>intercept(chain: Interceptor.Chain)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BridgeInterceptor</span></span>(<span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> cookieJar</span>: CookieJar) : Interceptor &#123;</span><br><span class="line"></span><br><span class="line">  @Throws(IOException::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="typename">Interceptor.Chain</span>)</span>: Response &#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> userRequest</span> = chain.request()</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> requestBuilder</span> = userRequest.newBuilder()</span><br><span class="line"></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> body</span> = userRequest.body</span><br><span class="line">    <span class="comment">// 对请求头的补充</span></span><br><span class="line">    <span class="keyword">if</span> (body != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="variable"><span class="keyword">val</span> contentType</span> = body.contentType()</span><br><span class="line">      <span class="keyword">if</span> (contentType != <span class="literal">null</span>) &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Content-Type"</span>, contentType.toString())</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> contentLength</span> = body.contentLength()</span><br><span class="line">      <span class="keyword">if</span> (contentLength != -<span class="number">1</span>L) &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Content-Length"</span>, contentLength.toString())</span><br><span class="line">        requestBuilder.removeHeader(<span class="string">"Transfer-Encoding"</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        requestBuilder.header(<span class="string">"Transfer-Encoding"</span>, <span class="string">"chunked"</span>)</span><br><span class="line">        requestBuilder.removeHeader(<span class="string">"Content-Length"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Host"</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Host"</span>, userRequest.url.toHostHeader())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认保持连接 Keep-Alive</span></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Connection"</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认 GZIP 压缩</span></span><br><span class="line">    <span class="comment">// If we add an "Accept-Encoding: gzip" header field we're responsible for also decompressing</span></span><br><span class="line">    <span class="comment">// the transfer stream.</span></span><br><span class="line">    <span class="variable"><span class="keyword">var</span> transparentGzip</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"Accept-Encoding"</span>) == <span class="literal">null</span> &amp;&amp; userRequest.header(<span class="string">"Range"</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">      transparentGzip = <span class="literal">true</span></span><br><span class="line">      requestBuilder.header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cookies 信息</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> cookies</span> = cookieJar.loadForRequest(userRequest.url)</span><br><span class="line">    <span class="keyword">if</span> (cookies.isNotEmpty()) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"Cookie"</span>, cookieHeader(cookies))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userRequest.header(<span class="string">"User-Agent"</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">      requestBuilder.header(<span class="string">"User-Agent"</span>, userAgent)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 丢给下一个拦截器发送网络请求</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> networkResponse</span> = chain.proceed(requestBuilder.build())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接受服务器返回的 Cookies</span></span><br><span class="line">    cookieJar.receiveHeaders(userRequest.url, networkResponse.headers())</span><br><span class="line"></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> responseBuilder</span> = networkResponse.newBuilder()</span><br><span class="line">        .request(userRequest)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (transparentGzip &amp;&amp;</span><br><span class="line">        <span class="string">"gzip"</span>.equals(networkResponse.header(<span class="string">"Content-Encoding"</span>), ignoreCase = <span class="literal">true</span>) &amp;&amp;</span><br><span class="line">        networkResponse.promisesBody()) &#123;</span><br><span class="line">      <span class="comment">// 当服务器返回的数据是 GZIP 压缩的，那么客户端就进行解压操作</span></span><br><span class="line">      <span class="variable"><span class="keyword">val</span> responseBody</span> = networkResponse.body()</span><br><span class="line">      <span class="keyword">if</span> (responseBody != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> gzipSource</span> = GzipSource(responseBody.source())</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> strippedHeaders</span> = networkResponse.headers().newBuilder()</span><br><span class="line">            .removeAll(<span class="string">"Content-Encoding"</span>)</span><br><span class="line">            .removeAll(<span class="string">"Content-Length"</span>)</span><br><span class="line">            .build()</span><br><span class="line">        responseBuilder.headers(strippedHeaders)</span><br><span class="line">        <span class="variable"><span class="keyword">val</span> contentType</span> = networkResponse.header(<span class="string">"Content-Type"</span>)</span><br><span class="line">        responseBuilder.body(RealResponseBody(contentType, -<span class="number">1</span>L, gzipSource.buffer()))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建 Response</span></span><br><span class="line">    <span class="keyword">return</span> responseBuilder.build()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns a 'Cookie' HTTP request header with all cookies, like `a=b; c=d`. */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">cookieHeader</span><span class="params">(cookies: <span class="typename">List&lt;Cookie&gt;</span>)</span>: String = buildString &#123;</span></span><br><span class="line">    cookies.forEachIndexed &#123; index, cookie -&gt;</span><br><span class="line">      <span class="keyword">if</span> (index &gt; <span class="number">0</span>) append(<span class="string">"; "</span>)</span><br><span class="line">      append(cookie.name).append('=').append(cookie.value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>将用户构建的一个 Request 请求转化为能够进行网络访问的请求</li>
<li>将 Request 丢给下一个拦截器去进行网络请求</li>
<li>将网络请求回来的响应 Response 转化为用户可用的 Response</li>
</ul>
<h3 id="Request-转换"><a href="#Request-转换" class="headerlink" title="Request 转换"></a>Request 转换</h3><p>因为用户在构建一个 Request 对象的时侯往往只会简单设置 url, RequestBody 等几个属性，但是真正要发送一个请求实际上没这么简单，在原来的基础上添加了很多请求头</p>
<ul>
<li>Content-Type: 网络请求类型</li>
<li>Content-Length: 请求体内容的长度，与 Transfer-Encoding 互斥</li>
<li>Transfer-Encoding: 值为 chunked 表示请求体的内容大小是未知的，与 Content-Length 互斥</li>
<li>Host: 请求的 url 的主机</li>
<li>Connection: 默认就是 Keep-Alive，就是一个 TCP 连接之后不会关闭，保持连接状态</li>
<li>Accept-Encoding: 默认是 gzip，告诉服务器客户端支持 gzip 编码的响应</li>
<li>Cookie: 当请求设置了 Cookie 那么就是添加 Cookie 这个请求头</li>
<li>User-Agent: 根据 OKHTTP 的版本来返回</li>
</ul>
<h3 id="Response-转换"><a href="#Response-转换" class="headerlink" title="Response 转换"></a>Response 转换</h3><ul>
<li><p>cookie 处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookieJar.receiveHeaders(userRequest.url, networkResponse.headers())</span><br></pre></td></tr></table></figure>
</li>
<li><p>gzip 处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GzipSource(responseBody.source()).buffer()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/07/10/okhttp-cache-interceptor-analyse/" class="prev">PREV</a><a href="/2019/07/08/okhttp-retry-and-follow-up-interceptor-analyse/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yydcdut.com">yydcdut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>